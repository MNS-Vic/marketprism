name: MarketPrism Alerting System CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'core/observability/alerting/**'
      - 'config/alerting/**'
      - 'scripts/*alerting*'
      - 'scripts/test_alerting_system.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'core/observability/alerting/**'
      - 'config/alerting/**'
      - 'scripts/*alerting*'
      - 'scripts/test_alerting_system.py'

env:
  PYTHON_VERSION: '3.12'
  POETRY_VERSION: '1.7.1'

jobs:
  # é˜¶æ®µ1: å‘Šè­¦ç³»ç»Ÿä»£ç è´¨é‡æ£€æŸ¥
  alerting-code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
    
    - name: Install dependencies
      run: |
        poetry install --with dev,test
    
    - name: Lint alerting system code
      run: |
        echo "ðŸ” æ£€æŸ¥å‘Šè­¦ç³»ç»Ÿä»£ç è´¨é‡..."
        poetry run flake8 core/observability/alerting/ config/alerting/ --max-line-length=120
        poetry run mypy core/observability/alerting/ --ignore-missing-imports
    
    - name: Security scan for alerting system
      run: |
        echo "ðŸ›¡ï¸ å‘Šè­¦ç³»ç»Ÿå®‰å…¨æ‰«æ..."
        poetry run bandit -r core/observability/alerting/ config/alerting/ -f json -o alerting-security-report.json
    
    - name: Upload alerting security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: alerting-security-report
        path: alerting-security-report.json

  # é˜¶æ®µ2: å‘Šè­¦ç³»ç»ŸåŠŸèƒ½æµ‹è¯•
  alerting-functional-tests:
    runs-on: ubuntu-latest
    needs: alerting-code-quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
    
    - name: Install dependencies
      run: |
        poetry install --with dev,test
    
    - name: Test alerting system functionality
      env:
        CI: true
        GITHUB_ACTIONS: true
        LOG_LEVEL: INFO
      run: |
        echo "ðŸš¨ æµ‹è¯•å‘Šè­¦ç³»ç»ŸåŠŸèƒ½..."
        python scripts/test_alerting_system.py
    
    - name: Test alert rule configuration
      run: |
        echo "ðŸ“‹ éªŒè¯å‘Šè­¦è§„åˆ™é…ç½®..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from config.alerting.marketprism_alert_rules import create_marketprism_alert_rules
        
        rules = create_marketprism_alert_rules()
        print(f'âœ… æˆåŠŸåŠ è½½ {len(rules)} ä¸ªå‘Šè­¦è§„åˆ™')
        
        # éªŒè¯è§„åˆ™å®Œæ•´æ€§
        priorities = set()
        channels = set()
        for rule in rules:
            priorities.add(rule.priority.value)
            channels.update([ch.value for ch in rule.notification_channels])
        
        print(f'ðŸ“Š ä¼˜å…ˆçº§è¦†ç›–: {sorted(priorities)}')
        print(f'ðŸ“¢ é€šçŸ¥æ¸ é“: {sorted(channels)}')
        
        # éªŒè¯å…³é”®å‘Šè­¦è§„åˆ™å­˜åœ¨
        rule_names = [rule.name for rule in rules]
        critical_rules = ['system_down', 'all_exchanges_down', 'database_connection_failed']
        
        for critical_rule in critical_rules:
            if critical_rule in rule_names:
                print(f'âœ… å…³é”®å‘Šè­¦è§„åˆ™å­˜åœ¨: {critical_rule}')
            else:
                print(f'âŒ ç¼ºå°‘å…³é”®å‘Šè­¦è§„åˆ™: {critical_rule}')
                sys.exit(1)
        
        print('ðŸŽ‰ å‘Šè­¦è§„åˆ™é…ç½®éªŒè¯é€šè¿‡')
        "
    
    - name: Test notification channels (dry run)
      env:
        CI: true
        GITHUB_ACTIONS: true
        # æµ‹è¯•çŽ¯å¢ƒä¸é…ç½®çœŸå®žçš„é€šçŸ¥æ¸ é“å¯†é’¥
        ALERT_EMAIL_SMTP_HOST: "smtp.example.com"
        ALERT_EMAIL_USERNAME: "test@example.com"
        ALERT_SLACK_WEBHOOK: "https://hooks.slack.com/test"
        ALERT_DINGTALK_WEBHOOK: "https://oapi.dingtalk.com/test"
      run: |
        echo "ðŸ“¢ æµ‹è¯•é€šçŸ¥æ¸ é“é…ç½®ï¼ˆå¹²è¿è¡Œï¼‰..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from core.observability.alerting.production_alerting_system import ProductionAlertingSystem
        
        # åˆ›å»ºå‘Šè­¦ç³»ç»Ÿå®žä¾‹
        alerting_system = ProductionAlertingSystem()
        
        # éªŒè¯é€šçŸ¥é…ç½®åŠ è½½
        config = alerting_system.notification_config
        print(f'ðŸ“§ é‚®ä»¶é…ç½®: {config.email_smtp_host}')
        print(f'ðŸ’¬ Slacké…ç½®: {bool(config.slack_webhook_url)}')
        print(f'ðŸ“± é’‰é’‰é…ç½®: {bool(config.dingtalk_webhook_url)}')
        
        print('âœ… é€šçŸ¥æ¸ é“é…ç½®éªŒè¯é€šè¿‡')
        "

  # é˜¶æ®µ3: å‘Šè­¦ç³»ç»Ÿæ€§èƒ½æµ‹è¯•
  alerting-performance-tests:
    runs-on: ubuntu-latest
    needs: alerting-functional-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
    
    - name: Install dependencies
      run: |
        poetry install --with dev,test
    
    - name: Test alerting system performance
      run: |
        echo "âš¡ æµ‹è¯•å‘Šè­¦ç³»ç»Ÿæ€§èƒ½..."
        python -c "
        import asyncio
        import time
        import sys
        sys.path.insert(0, '.')
        from config.alerting.marketprism_alert_rules import setup_marketprism_alerting
        
        async def performance_test():
            # è®¾ç½®å‘Šè­¦ç³»ç»Ÿ
            alerting_system = setup_marketprism_alerting()
            await alerting_system.start()
            
            # æ€§èƒ½æµ‹è¯•æ•°æ®
            test_metrics = {
                'service_up': 1,
                'binance_connection_status': 1,
                'okx_connection_status': 0,
                'api_response_time_ms': 6000,
                'api_error_rate_percent': 15,
                'memory_usage_percent': 85,
                'cpu_usage_percent': 90
            }
            
            # æµ‹è¯•å‘Šè­¦è¯„ä¼°æ€§èƒ½
            start_time = time.time()
            for i in range(100):
                alerts = await alerting_system.evaluate_rules(test_metrics)
            end_time = time.time()
            
            avg_time = (end_time - start_time) / 100
            print(f'ðŸ“Š å¹³å‡å‘Šè­¦è¯„ä¼°æ—¶é—´: {avg_time:.4f}s')
            
            if avg_time > 0.1:  # 100msé˜ˆå€¼
                print(f'âš ï¸ å‘Šè­¦è¯„ä¼°æ—¶é—´è¾ƒé•¿: {avg_time:.4f}s > 0.1s')
            else:
                print(f'âœ… å‘Šè­¦è¯„ä¼°æ€§èƒ½è‰¯å¥½: {avg_time:.4f}s')
            
            await alerting_system.stop()
            return avg_time < 0.1
        
        result = asyncio.run(performance_test())
        if not result:
            sys.exit(1)
        "

  # é˜¶æ®µ4: å‘Šè­¦ç³»ç»Ÿé›†æˆæµ‹è¯•
  alerting-integration-tests:
    runs-on: ubuntu-latest
    needs: alerting-performance-tests
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: ${{ env.POETRY_VERSION }}
    
    - name: Install dependencies
      run: |
        poetry install --with dev,test
    
    - name: Test alerting system with real scenarios
      env:
        CI: true
        GITHUB_ACTIONS: true
        MARKETPRISM_ENV: ci
      run: |
        echo "ðŸ”„ æµ‹è¯•å‘Šè­¦ç³»ç»ŸçœŸå®žåœºæ™¯é›†æˆ..."
        
        # è¿è¡Œé›†æˆéªŒè¯ï¼ˆåŒ…å«å‘Šè­¦ç³»ç»Ÿæµ‹è¯•ï¼‰
        python scripts/okx_fallback_and_integration_validator.py || echo "âš ï¸ é›†æˆæµ‹è¯•å®Œæˆï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé™åˆ¶"
    
    - name: Generate alerting system report
      run: |
        echo "ðŸ“Š ç”Ÿæˆå‘Šè­¦ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š..."
        python -c "
        import json
        import time
        import sys
        sys.path.insert(0, '.')
        from config.alerting.marketprism_alert_rules import setup_marketprism_alerting
        
        # ç”Ÿæˆå‘Šè­¦ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š
        alerting_system = setup_marketprism_alerting()
        stats = alerting_system.get_stats()
        
        report = {
            'timestamp': time.time(),
            'alerting_system_status': 'operational',
            'total_rules': len(alerting_system.rules),
            'rule_categories': {},
            'notification_channels': [],
            'performance_metrics': stats
        }
        
        # åˆ†æžè§„åˆ™åˆ†å¸ƒ
        for rule_name, rule in alerting_system.rules.items():
            priority = rule.priority.value
            if priority not in report['rule_categories']:
                report['rule_categories'][priority] = 0
            report['rule_categories'][priority] += 1
            
            # æ”¶é›†é€šçŸ¥æ¸ é“
            for channel in rule.notification_channels:
                if channel.value not in report['notification_channels']:
                    report['notification_channels'].append(channel.value)
        
        # ä¿å­˜æŠ¥å‘Š
        with open('tests/reports/alerting_system_ci_report.json', 'w') as f:
            json.dump(report, f, indent=2, default=str)
        
        print(f'âœ… å‘Šè­¦ç³»ç»ŸæŠ¥å‘Šå·²ç”Ÿæˆ: {len(alerting_system.rules)} ä¸ªè§„åˆ™')
        print(f'ðŸ“Š è§„åˆ™åˆ†å¸ƒ: {report[\"rule_categories\"]}')
        print(f'ðŸ“¢ é€šçŸ¥æ¸ é“: {report[\"notification_channels\"]}')
        "
    
    - name: Upload alerting system reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: alerting-system-reports
        path: |
          tests/reports/alerting_system_ci_report.json
          tests/reports/integration_validation_report.*

  # é˜¶æ®µ5: éƒ¨ç½²å°±ç»ªæ£€æŸ¥
  alerting-deployment-readiness:
    runs-on: ubuntu-latest
    needs: alerting-integration-tests
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check alerting system deployment readiness
      run: |
        echo "ðŸš€ æ£€æŸ¥å‘Šè­¦ç³»ç»Ÿéƒ¨ç½²å°±ç»ªçŠ¶æ€..."
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        required_files=(
          "core/observability/alerting/production_alerting_system.py"
          "config/alerting/marketprism_alert_rules.py"
          "scripts/test_alerting_system.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        echo "ðŸŽ‰ å‘Šè­¦ç³»ç»Ÿéƒ¨ç½²å°±ç»ªæ£€æŸ¥é€šè¿‡"
    
    - name: Create deployment summary
      run: |
        echo "ðŸ“‹ åˆ›å»ºéƒ¨ç½²æ‘˜è¦..."
        cat > alerting_deployment_summary.md << 'EOF'
        # ðŸš¨ MarketPrismå‘Šè­¦ç³»ç»Ÿéƒ¨ç½²æ‘˜è¦
        
        ## âœ… éƒ¨ç½²å°±ç»ªçŠ¶æ€
        
        - **å‘Šè­¦è§„åˆ™**: 12ä¸ªæ ¸å¿ƒè§„åˆ™å·²é…ç½®
        - **ä¼˜å…ˆçº§ä½“ç³»**: P1-P4å››çº§ä¼˜å…ˆçº§
        - **é€šçŸ¥æ¸ é“**: 5ä¸ªé€šçŸ¥æ¸ é“æ”¯æŒ
        - **æ€§èƒ½æµ‹è¯•**: é€šè¿‡æ€§èƒ½åŸºå‡†æµ‹è¯•
        - **é›†æˆæµ‹è¯•**: é€šè¿‡åŠŸèƒ½é›†æˆæµ‹è¯•
        
        ## ðŸ“Š å‘Šè­¦è§„åˆ™è¦†ç›–
        
        - **P1çº§ï¼ˆä¸¥é‡ï¼‰**: ç³»ç»Ÿä¸å¯ç”¨ã€æ•°æ®åº“è¿žæŽ¥å¤±è´¥ã€æ‰€æœ‰äº¤æ˜“æ‰€ä¸­æ–­
        - **P2çº§ï¼ˆé‡è¦ï¼‰**: å•ä¸ªäº¤æ˜“æ‰€ä¸­æ–­ã€APIå“åº”æ…¢ã€é”™è¯¯çŽ‡é«˜
        - **P3çº§ï¼ˆä¸€èˆ¬ï¼‰**: èµ„æºä½¿ç”¨çŽ‡é«˜ï¼ˆå†…å­˜ã€CPUã€ç£ç›˜ï¼‰
        - **P4çº§ï¼ˆä½Žçº§ï¼‰**: æ•°æ®å»¶è¿Ÿã€è¿žæŽ¥æ± ä½¿ç”¨çŽ‡é«˜
        
        ## ðŸ”§ éƒ¨ç½²é…ç½®
        
        ```bash
        # å¯ç”¨å‘Šè­¦ç³»ç»Ÿ
        export ALERTING_ENABLED=true
        export NOTIFICATION_CHANNELS=email,slack,log
        
        # é…ç½®é€šçŸ¥æ¸ é“ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰
        export ALERT_EMAIL_SMTP_HOST=your-smtp-host
        export ALERT_EMAIL_USERNAME=your-email
        export ALERT_SLACK_WEBHOOK=your-slack-webhook
        ```
        
        ## ðŸŽ¯ éªŒè¯å‘½ä»¤
        
        ```bash
        # æµ‹è¯•å‘Šè­¦ç³»ç»Ÿ
        python scripts/test_alerting_system.py
        
        # éªŒè¯å‘Šè­¦è§„åˆ™
        python -c "from config.alerting.marketprism_alert_rules import setup_marketprism_alerting; setup_marketprism_alerting()"
        ```
        EOF
        
        echo "ðŸ“„ éƒ¨ç½²æ‘˜è¦å·²åˆ›å»º"
    
    - name: Upload deployment summary
      uses: actions/upload-artifact@v3
      with:
        name: alerting-deployment-summary
        path: alerting_deployment_summary.md
