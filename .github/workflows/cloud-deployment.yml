name: MarketPrism Cloud Deployment

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # é˜¶æ®µ1: æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: '1.7.1'

    - name: Install dependencies
      run: |
        poetry install --with dev,test

    - name: Run tests
      run: |
        poetry run pytest tests/ -v --tb=short --timeout=300

    - name: Run security scan
      run: |
        poetry run bandit -r src/ -f json -o security-report.json || true

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          security-report.json
          tests/reports/

  # é˜¶æ®µ2: éƒ¨ç½²åˆ°äº‘ç«¯
  deploy-to-cloud:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment variables
      run: |
        echo "DEPLOYMENT_ENV=${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_ENV
        echo "IMAGE_TAG=${{ needs.build-and-test.outputs.image-tag }}" >> $GITHUB_ENV

    # éƒ¨ç½²åˆ°Docker Swarmé›†ç¾¤
    - name: Deploy to Docker Swarm
      id: deploy
      run: |
        # åˆ›å»ºéƒ¨ç½²é…ç½®
        cat > docker-stack.yml << EOF
        version: '3.8'
        
        services:
          redis:
            image: redis:7-alpine
            command: redis-server --appendonly yes --requirepass \${REDIS_PASSWORD}
            environment:
              - REDIS_PASSWORD=\${REDIS_PASSWORD}
            volumes:
              - redis_data:/data
            networks:
              - marketprism-network
            deploy:
              replicas: 1
              restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
        
          postgres:
            image: postgres:15-alpine
            environment:
              - POSTGRES_DB=\${POSTGRES_DB}
              - POSTGRES_USER=\${POSTGRES_USER}
              - POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}
            volumes:
              - postgres_data:/var/lib/postgresql/data
            networks:
              - marketprism-network
            deploy:
              replicas: 1
              restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
        
          nats:
            image: nats:2-alpine
            command: ["-js", "-m", "8222"]
            networks:
              - marketprism-network
            deploy:
              replicas: 1
              restart_policy:
                condition: on-failure
        
          prometheus:
            image: prom/prometheus:latest
            command:
              - '--config.file=/etc/prometheus/prometheus.yml'
              - '--storage.tsdb.path=/prometheus'
              - '--web.console.libraries=/etc/prometheus/console_libraries'
              - '--web.console.templates=/etc/prometheus/consoles'
              - '--storage.tsdb.retention.time=200h'
              - '--web.enable-lifecycle'
            volumes:
              - prometheus_data:/prometheus
            networks:
              - marketprism-network
            ports:
              - "9090:9090"
            deploy:
              replicas: 1
              restart_policy:
                condition: on-failure
        
          data-collector:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            environment:
              - DATABASE_URL=postgresql://\${POSTGRES_USER}:\${POSTGRES_PASSWORD}@postgres:5432/\${POSTGRES_DB}
              - REDIS_URL=redis://:\${REDIS_PASSWORD}@redis:6379/0
              - NATS_URL=nats://nats:4222
              - PROMETHEUS_ENABLED=true
              - ALERTING_ENABLED=true
              - ENVIRONMENT=${{ env.DEPLOYMENT_ENV }}
            networks:
              - marketprism-network
            ports:
              - "8080:8080"
            depends_on:
              - redis
              - postgres
              - nats
            deploy:
              replicas: 2
              restart_policy:
                condition: on-failure
                delay: 10s
                max_attempts: 3
              update_config:
                parallelism: 1
                delay: 10s
                failure_action: rollback
              rollback_config:
                parallelism: 1
                delay: 10s
        
        volumes:
          redis_data:
          postgres_data:
          prometheus_data:
        
        networks:
          marketprism-network:
            driver: overlay
            attachable: true
        EOF
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export POSTGRES_DB=marketprism
        export POSTGRES_USER=marketprism_user
        export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        
        # åˆå§‹åŒ–Docker Swarmï¼ˆå¦‚æœéœ€è¦ï¼‰
        docker swarm init --advertise-addr 127.0.0.1 || true
        
        # éƒ¨ç½²æœåŠ¡æ ˆ
        docker stack deploy -c docker-stack.yml marketprism
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 60
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker service ls
        
        echo "url=http://localhost:8080" >> $GITHUB_OUTPUT

    - name: Wait for services to be ready
      run: |
        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "âœ… æœåŠ¡å·²å°±ç»ª"
            break
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 10
          fi
        done

    - name: Run deployment tests
      run: |
        echo "ğŸ§ª è¿è¡Œéƒ¨ç½²éªŒè¯æµ‹è¯•..."
        
        # å¥åº·æ£€æŸ¥
        health_status=$(curl -s http://localhost:8080/health | jq -r '.status' 2>/dev/null || echo "unknown")
        echo "å¥åº·çŠ¶æ€: $health_status"
        
        # APIæµ‹è¯•
        if curl -s http://localhost:8080/api/v1/exchanges/binance/ping > /dev/null; then
          echo "âœ… Binance APIæµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ Binance APIæµ‹è¯•å¤±è´¥"
        fi
        
        # PrometheusæŒ‡æ ‡æµ‹è¯•
        if curl -s http://localhost:9090/metrics | head -5 > /dev/null; then
          echo "âœ… PrometheusæŒ‡æ ‡æ­£å¸¸"
        else
          echo "âš ï¸ PrometheusæŒ‡æ ‡å¼‚å¸¸"
        fi
        
        # æœåŠ¡çŠ¶æ€æ£€æŸ¥
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
        docker service ls
        
        # å®¹å™¨æ—¥å¿—æ£€æŸ¥
        echo "ğŸ“ åº”ç”¨æ—¥å¿—:"
        docker service logs marketprism_data-collector --tail 10

    - name: Run alerting system test
      run: |
        echo "ğŸš¨ æµ‹è¯•å‘Šè­¦ç³»ç»Ÿ..."
        
        # åˆ›å»ºä¸´æ—¶æµ‹è¯•è„šæœ¬
        cat > test_alerts.py << 'EOF'
        import sys
        import os
        sys.path.insert(0, '.')
        
        try:
            from config.alerting.marketprism_alert_rules import setup_marketprism_alerting
            
            alerting_system = setup_marketprism_alerting()
            print(f"âœ… å‘Šè­¦ç³»ç»ŸåŠ è½½æˆåŠŸï¼Œå…± {len(alerting_system.rules)} ä¸ªè§„åˆ™")
            
            # æµ‹è¯•å‘Šè­¦è§„åˆ™
            test_metrics = {
                'service_up': 1,
                'memory_usage_percent': 50,
                'cpu_usage_percent': 30
            }
            
            import asyncio
            async def test_alerts():
                alerts = await alerting_system.evaluate_rules(test_metrics)
                print(f"âœ… å‘Šè­¦è¯„ä¼°å®Œæˆï¼Œè§¦å‘ {len(alerts)} ä¸ªå‘Šè­¦")
                return len(alerts) == 0  # æ­£å¸¸æƒ…å†µä¸‹ä¸åº”è¯¥æœ‰å‘Šè­¦
            
            result = asyncio.run(test_alerts())
            sys.exit(0 if result else 1)
            
        except Exception as e:
            print(f"âŒ å‘Šè­¦ç³»ç»Ÿæµ‹è¯•å¤±è´¥: {e}")
            sys.exit(1)
        EOF
        
        python test_alerts.py

    - name: Performance benchmark
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        
        # APIå“åº”æ—¶é—´æµ‹è¯•
        for i in {1..5}; do
          response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:8080/health)
          echo "APIå“åº”æ—¶é—´ $i: ${response_time}s"
        done
        
        # å¹¶å‘æµ‹è¯•
        echo "ğŸ”„ å¹¶å‘æµ‹è¯•..."
        for i in {1..10}; do
          curl -s http://localhost:8080/health > /dev/null &
        done
        wait
        echo "âœ… å¹¶å‘æµ‹è¯•å®Œæˆ"

    - name: Generate deployment report
      run: |
        echo "ğŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š..."
        
        cat > deployment-report.md << EOF
        # ğŸš€ MarketPrismäº‘ç«¯éƒ¨ç½²æŠ¥å‘Š
        
        **éƒ¨ç½²æ—¶é—´**: $(date)
        **ç¯å¢ƒ**: ${{ env.DEPLOYMENT_ENV }}
        **é•œåƒ**: ${{ env.IMAGE_TAG }}
        **æäº¤**: ${{ github.sha }}
        
        ## ğŸ“Š æœåŠ¡çŠ¶æ€
        \`\`\`
        $(docker service ls)
        \`\`\`
        
        ## ğŸ” å¥åº·æ£€æŸ¥
        - APIå¥åº·çŠ¶æ€: $(curl -s http://localhost:8080/health | jq -r '.status' 2>/dev/null || echo "unknown")
        - PrometheusçŠ¶æ€: $(curl -s http://localhost:9090/-/healthy > /dev/null && echo "healthy" || echo "unhealthy")
        
        ## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡
        - æœåŠ¡å‰¯æœ¬æ•°: 2
        - å†…å­˜é™åˆ¶: 1GB
        - CPUé™åˆ¶: 0.5æ ¸
        
        ## ğŸ”— è®¿é—®åœ°å€
        - API: http://localhost:8080
        - å¥åº·æ£€æŸ¥: http://localhost:8080/health
        - Prometheus: http://localhost:9090
        
        EOF
        
        echo "âœ… éƒ¨ç½²æŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: deployment-artifacts
        path: |
          deployment-report.md
          docker-stack.yml

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ MarketPrismäº‘ç«¯éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ”— è®¿é—®åœ°å€: http://localhost:8080"
        else
          echo "âŒ MarketPrismäº‘ç«¯éƒ¨ç½²å¤±è´¥"
          echo "ğŸ“ è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
        fi

  # é˜¶æ®µ3: éƒ¨ç½²åç›‘æ§
  post-deployment-monitoring:
    runs-on: ubuntu-latest
    needs: deploy-to-cloud
    if: success()
    
    steps:
    - name: Setup monitoring
      run: |
        echo "ğŸ“Š è®¾ç½®éƒ¨ç½²åç›‘æ§..."
        
        # æŒç»­å¥åº·æ£€æŸ¥
        for i in {1..60}; do
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ ($i/60)"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ ($i/60)"
          fi
          sleep 30
        done

    - name: Generate monitoring report
      run: |
        echo "ğŸ“ˆ ç”Ÿæˆç›‘æ§æŠ¥å‘Š..."
        
        # æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
        echo "ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ:"
        docker stats --no-stream
        
        # æ”¶é›†åº”ç”¨æŒ‡æ ‡
        echo "åº”ç”¨æŒ‡æ ‡:"
        curl -s http://localhost:9090/api/v1/query?query=up | jq '.'
        
        echo "âœ… ç›‘æ§æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
