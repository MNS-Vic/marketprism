# MarketPrism Collector TDD Makefile
# 
# ä½¿ç”¨æ–¹æ³•:
#   make -f Makefile_collector_tdd test-quick     # å¿«é€Ÿæµ‹è¯•
#   make -f Makefile_collector_tdd test-unit      # å•å…ƒæµ‹è¯•
#   make -f Makefile_collector_tdd test-all       # å®Œæ•´TDDæµ‹è¯•

PYTHON := python3
PYTEST := $(PYTHON) -m pytest
PROJECT_ROOT := $(shell pwd)
TEST_DIR := tests
COLLECTOR_SRC := services/python-collector/src/marketprism_collector
VENV_DIR := venv_tdd

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

.PHONY: help
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "MarketPrism Collector TDD æµ‹è¯•å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

.PHONY: install-deps
install-deps: ## å®‰è£…æµ‹è¯•ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–..."
	$(PYTHON) -m pip install -r requirements.txt
	$(PYTHON) -m pip install pytest pytest-asyncio pytest-html pytest-json-report pytest-cov pytest-timeout pytest-benchmark
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

.PHONY: setup-test-env
setup-test-env: ## è®¾ç½®æµ‹è¯•ç¯å¢ƒ
	@echo "ğŸ”§ è®¾ç½®æµ‹è¯•ç¯å¢ƒ..."
	mkdir -p $(TEST_DIR)/reports
	mkdir -p $(TEST_DIR)/temp
	mkdir -p logs/tests
	@echo "âœ… æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ"

.PHONY: test-quick
test-quick: setup-test-env ## å¿«é€Ÿæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
	@echo "âš¡ æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
	$(PYTHON) $(TEST_DIR)/quick_test_collector.py

.PHONY: test-unit
test-unit: setup-test-env ## æ‰§è¡Œå•å…ƒæµ‹è¯•
	@echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/unit/collector/ -v \
		--tb=short \
		--cov=$(COLLECTOR_SRC) \
		--cov-report=html:$(TEST_DIR)/reports/unit_coverage \
		--cov-report=json \
		--html=$(TEST_DIR)/reports/unit_test_report.html \
		--self-contained-html \
		--json-report --json-report-file=$(TEST_DIR)/reports/unit_test_results.json

.PHONY: test-integration
test-integration: setup-test-env ## æ‰§è¡Œé›†æˆæµ‹è¯•
	@echo "ğŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/integration/collector/ -v \
		--tb=short \
		--timeout=120 \
		--html=$(TEST_DIR)/reports/integration_test_report.html \
		--self-contained-html \
		--json-report --json-report-file=$(TEST_DIR)/reports/integration_test_results.json

.PHONY: test-e2e
test-e2e: setup-test-env ## æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•
	@echo "ğŸ¯ æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/e2e/collector/ -v \
		--tb=short \
		--timeout=300 \
		-m "not slow" \
		--html=$(TEST_DIR)/reports/e2e_test_report.html \
		--self-contained-html \
		--json-report --json-report-file=$(TEST_DIR)/reports/e2e_test_results.json

.PHONY: test-performance
test-performance: setup-test-env ## æ‰§è¡Œæ€§èƒ½æµ‹è¯•
	@echo "ğŸš€ æ‰§è¡Œæ€§èƒ½æµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/performance/collector/ -v \
		--tb=short \
		--timeout=600 \
		--benchmark-only \
		--benchmark-html=$(TEST_DIR)/reports/performance_report.html \
		--json-report --json-report-file=$(TEST_DIR)/reports/performance_test_results.json

.PHONY: test-all
test-all: setup-test-env ## æ‰§è¡Œå®Œæ•´TDDæµ‹è¯•å¥—ä»¶
	@echo "ğŸ¯ æ‰§è¡Œå®Œæ•´TDDæµ‹è¯•å¥—ä»¶..."
	$(PYTHON) $(TEST_DIR)/run_collector_tdd.py --phase all

.PHONY: test-phase1
test-phase1: setup-test-env ## æ‰§è¡Œé˜¶æ®µ1æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ï¼‰
	@echo "ğŸ§ª æ‰§è¡Œé˜¶æ®µ1æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ï¼‰..."
	$(PYTHON) $(TEST_DIR)/run_collector_tdd.py --phase unit

.PHONY: test-phase2
test-phase2: setup-test-env ## æ‰§è¡Œé˜¶æ®µ2æµ‹è¯•ï¼ˆé›†æˆæµ‹è¯•ï¼‰
	@echo "ğŸ”— æ‰§è¡Œé˜¶æ®µ2æµ‹è¯•ï¼ˆé›†æˆæµ‹è¯•ï¼‰..."
	$(PYTHON) $(TEST_DIR)/run_collector_tdd.py --phase integration

.PHONY: test-phase3
test-phase3: setup-test-env ## æ‰§è¡Œé˜¶æ®µ3æµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰
	@echo "ğŸ¯ æ‰§è¡Œé˜¶æ®µ3æµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰..."
	$(PYTHON) $(TEST_DIR)/run_collector_tdd.py --phase e2e

.PHONY: test-fast
test-fast: setup-test-env ## å¿«é€Ÿæ¨¡å¼æµ‹è¯•ï¼ˆè·³è¿‡è€—æ—¶æµ‹è¯•ï¼‰
	@echo "âš¡ æ‰§è¡Œå¿«é€Ÿæ¨¡å¼æµ‹è¯•..."
	$(PYTHON) $(TEST_DIR)/run_collector_tdd.py --fast

.PHONY: test-binance
test-binance: setup-test-env ## æµ‹è¯•Binanceç›¸å…³åŠŸèƒ½
	@echo "ğŸ”¸ æµ‹è¯•Binanceç›¸å…³åŠŸèƒ½..."
	$(PYTEST) -v -m "binance" \
		--tb=short \
		--timeout=120 \
		--html=$(TEST_DIR)/reports/binance_test_report.html

.PHONY: test-okx
test-okx: setup-test-env ## æµ‹è¯•OKXç›¸å…³åŠŸèƒ½
	@echo "ğŸ”¸ æµ‹è¯•OKXç›¸å…³åŠŸèƒ½..."
	$(PYTEST) -v -m "okx" \
		--tb=short \
		--timeout=120 \
		--html=$(TEST_DIR)/reports/okx_test_report.html

.PHONY: test-core-integration
test-core-integration: setup-test-env ## æµ‹è¯•Coreæ¨¡å—é›†æˆ
	@echo "ğŸ”§ æµ‹è¯•Coreæ¨¡å—é›†æˆ..."
	$(PYTEST) -v -m "core_integration" \
		--tb=short \
		--cov=$(COLLECTOR_SRC) \
		--cov-report=html:$(TEST_DIR)/reports/core_integration_coverage \
		--html=$(TEST_DIR)/reports/core_integration_report.html

.PHONY: lint
lint: ## ä»£ç æ£€æŸ¥
	@echo "ğŸ” æ‰§è¡Œä»£ç æ£€æŸ¥..."
	$(PYTHON) -m flake8 $(COLLECTOR_SRC) --max-line-length=120
	$(PYTHON) -m mypy $(COLLECTOR_SRC) --ignore-missing-imports

.PHONY: format
format: ## ä»£ç æ ¼å¼åŒ–
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	$(PYTHON) -m black $(COLLECTOR_SRC) --line-length=120
	$(PYTHON) -m isort $(COLLECTOR_SRC)

.PHONY: clean
clean: ## æ¸…ç†æµ‹è¯•æ–‡ä»¶å’Œç¼“å­˜
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶å’Œç¼“å­˜..."
	rm -rf $(TEST_DIR)/reports/*
	rm -rf $(TEST_DIR)/temp/*
	rm -rf $(TEST_DIR)/.pytest_cache
	rm -rf $(COLLECTOR_SRC)/__pycache__
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

.PHONY: clean-all
clean-all: clean ## å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒï¼‰
	@echo "ğŸ§¹ å®Œå…¨æ¸…ç†..."
	rm -rf $(VENV_DIR)
	rm -rf .coverage
	rm -rf htmlcov/
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆ"

.PHONY: coverage
coverage: ## ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	$(PYTEST) $(TEST_DIR)/unit/collector/ $(TEST_DIR)/integration/collector/ \
		--cov=$(COLLECTOR_SRC) \
		--cov-report=html:$(TEST_DIR)/reports/coverage_html \
		--cov-report=json:$(TEST_DIR)/reports/coverage.json \
		--cov-report=term-missing
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $(TEST_DIR)/reports/coverage_html/index.html"

.PHONY: benchmark
benchmark: setup-test-env ## è¿è¡ŒåŸºå‡†æµ‹è¯•
	@echo "ğŸƒ æ‰§è¡ŒåŸºå‡†æµ‹è¯•..."
	$(PYTEST) $(TEST_DIR) -v \
		--benchmark-only \
		--benchmark-sort=mean \
		--benchmark-html=$(TEST_DIR)/reports/benchmark_report.html

.PHONY: stress-test
stress-test: setup-test-env ## å‹åŠ›æµ‹è¯•
	@echo "ğŸ’ª æ‰§è¡Œå‹åŠ›æµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/performance/collector/ -v \
		-m "stress" \
		--timeout=1800 \
		--tb=short

.PHONY: continuous
continuous: ## æŒç»­æµ‹è¯•æ¨¡å¼
	@echo "ğŸ”„ å¯åŠ¨æŒç»­æµ‹è¯•æ¨¡å¼..."
	$(PYTEST) -f $(TEST_DIR)/unit/collector/ \
		--tb=short \
		--maxfail=1

.PHONY: debug
debug: ## è°ƒè¯•æ¨¡å¼æµ‹è¯•
	@echo "ğŸ› è°ƒè¯•æ¨¡å¼æµ‹è¯•..."
	$(PYTEST) $(TEST_DIR)/unit/collector/test_core_integration.py -v \
		--tb=long \
		--capture=no \
		--log-cli-level=DEBUG

.PHONY: check-env
check-env: ## æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ
	@echo "ğŸ” æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ..."
	@echo "Pythonç‰ˆæœ¬: $(shell $(PYTHON) --version)"
	@echo "pytestç‰ˆæœ¬: $(shell $(PYTEST) --version)"
	@echo "é¡¹ç›®æ ¹ç›®å½•: $(PROJECT_ROOT)"
	@$(PYTHON) -c "import sys; print('Pythonè·¯å¾„:', sys.path[0])"
	@ls -la $(TEST_DIR)/
	@echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

.PHONY: install-test-data
install-test-data: ## å®‰è£…æµ‹è¯•æ•°æ®
	@echo "ğŸ“¥ å®‰è£…æµ‹è¯•æ•°æ®..."
	mkdir -p $(TEST_DIR)/fixtures
	# è¿™é‡Œå¯ä»¥æ·»åŠ ä¸‹è½½æˆ–ç”Ÿæˆæµ‹è¯•æ•°æ®çš„å‘½ä»¤
	@echo "âœ… æµ‹è¯•æ•°æ®å®‰è£…å®Œæˆ"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
.PHONY: report-summary
report-summary: ## ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
	@echo "ğŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦..."
	@if [ -f "$(TEST_DIR)/reports/tdd_final_report.json" ]; then \
		$(PYTHON) -c "import json; data=json.load(open('$(TEST_DIR)/reports/tdd_final_report.json')); print('æ•´ä½“æˆåŠŸç‡:', data['test_run_info']['overall_success_rate'], '%')"; \
	else \
		echo "æ²¡æœ‰æ‰¾åˆ°æœ€ç»ˆæŠ¥å‘Šæ–‡ä»¶"; \
	fi

# CI/CD å‹å¥½çš„æµ‹è¯•å‘½ä»¤
.PHONY: ci-test
ci-test: install-deps setup-test-env test-quick test-unit ## CI/CDæµ‹è¯•æµæ°´çº¿
	@echo "ğŸš€ CI/CDæµ‹è¯•æµæ°´çº¿å®Œæˆ"

# æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡
.PHONY: stats
stats: ## æ˜¾ç¤ºæµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
	@echo "ğŸ“Š æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯:"
	@find $(TEST_DIR) -name "test_*.py" | wc -l | awk '{print "æµ‹è¯•æ–‡ä»¶æ•°é‡:", $$1}'
	@grep -r "def test_" $(TEST_DIR) | wc -l | awk '{print "æµ‹è¯•å‡½æ•°æ•°é‡:", $$1}'
	@grep -r "class Test" $(TEST_DIR) | wc -l | awk '{print "æµ‹è¯•ç±»æ•°é‡:", $$1}'