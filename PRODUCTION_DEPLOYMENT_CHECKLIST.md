# 🚀 MarketPrism生产部署检查清单

## 📋 部署前检查 (Pre-Deployment)

### ✅ 环境准备
- [ ] **服务器资源**: 最小4GB RAM, 2 CPU核心, 50GB存储空间
- [ ] **Docker环境**: Docker 20.10+, Docker Compose 2.0+
- [ ] **网络配置**: 确保可访问交易所API (Binance, OKX)
- [ ] **防火墙设置**: 开放必要端口 (4222, 8085, 8123, 5432, 6379)

### ✅ 配置文件准备
- [ ] **环境变量**: 复制`.env.production.template`为`.env.production`
- [ ] **API密钥**: 配置Binance和OKX API密钥
- [ ] **数据库密码**: 设置PostgreSQL和ClickHouse密码
- [ ] **NATS配置**: 验证NATS服务器地址
- [ ] **日志级别**: 设置为INFO或WARNING (生产环境)

### ✅ 安全配置
- [ ] **API密钥权限**: 确保API密钥只有读取权限
- [ ] **网络安全**: 配置防火墙规则
- [ ] **访问控制**: 设置适当的文件权限 (600 for .env files)
- [ ] **SSL/TLS**: 配置HTTPS (如对外提供服务)

## 🚀 部署执行 (Deployment)

### ✅ 基础服务启动
```bash
# 1. 启动基础设施服务
docker-compose up -d postgres clickhouse redis

# 2. 等待服务健康检查通过
docker-compose ps

# 3. 启动NATS服务器
docker-compose up -d nats

# 4. 验证NATS连接
nats server check
```

### ✅ 数据收集器启动
```bash
# 1. 启动数据收集器
cd services/data-collector
python unified_collector_main.py --mode production --log-level INFO

# 2. 验证启动成功
curl http://localhost:8085/health
```

### ✅ 监控服务启动
```bash
# 1. 启动Prometheus
docker-compose up -d prometheus

# 2. 启动Grafana (可选)
docker-compose up -d grafana

# 3. 验证监控指标
curl http://localhost:8085/metrics
```

## 🔍 部署后验证 (Post-Deployment)

### ✅ 功能验证
- [ ] **WebSocket连接**: 验证与交易所的WebSocket连接正常
- [ ] **数据收集**: 确认订单簿和交易数据正常收集
- [ ] **NATS发布**: 验证数据正常发布到NATS主题
- [ ] **数据存储**: 确认数据正常写入ClickHouse
- [ ] **健康检查**: 所有健康检查端点返回正常状态

### ✅ 性能验证
- [ ] **内存使用**: 验证内存使用在配置限制内
- [ ] **CPU使用**: 确认CPU使用率正常 (<80%)
- [ ] **网络延迟**: 检查与交易所的网络延迟
- [ ] **数据延迟**: 验证数据处理延迟在可接受范围内
- [ ] **吞吐量**: 确认数据处理吞吐量满足需求

### ✅ 稳定性验证
- [ ] **心跳机制**: 验证WebSocket心跳正常工作
- [ ] **重连机制**: 测试网络中断后的自动重连
- [ ] **错误恢复**: 验证各种错误场景的恢复能力
- [ ] **内存管理**: 确认内存清理机制正常工作
- [ ] **日志记录**: 验证结构化日志正常输出

## 📊 监控配置 (Monitoring)

### ✅ 关键指标监控
- [ ] **系统指标**: CPU, 内存, 磁盘, 网络
- [ ] **应用指标**: WebSocket连接数, 数据处理速率
- [ ] **业务指标**: 订单簿更新频率, 交易数据量
- [ ] **错误指标**: 连接失败率, 数据丢失率

### ✅ 告警配置
- [ ] **系统告警**: 高CPU/内存使用, 磁盘空间不足
- [ ] **连接告警**: WebSocket连接中断, NATS连接失败
- [ ] **数据告警**: 数据延迟过高, 数据丢失
- [ ] **服务告警**: 服务不可用, 健康检查失败

## 🔧 运维操作 (Operations)

### ✅ 日常维护
- [ ] **日志轮转**: 配置日志文件轮转和清理
- [ ] **数据备份**: 设置定期数据备份
- [ ] **性能监控**: 定期检查系统性能指标
- [ ] **安全更新**: 定期更新系统和依赖包

### ✅ 故障处理
- [ ] **重启流程**: 准备服务重启脚本
- [ ] **回滚计划**: 准备版本回滚方案
- [ ] **故障排查**: 准备常见问题排查手册
- [ ] **联系方式**: 准备紧急联系人信息

## 🚨 紧急响应 (Emergency Response)

### ✅ 故障响应流程
1. **问题识别**: 通过监控告警或用户反馈识别问题
2. **影响评估**: 评估问题影响范围和严重程度
3. **快速修复**: 执行临时修复措施恢复服务
4. **根因分析**: 分析问题根本原因
5. **永久修复**: 实施永久性解决方案
6. **事后总结**: 编写事故报告和改进计划

### ✅ 联系信息
- **技术负责人**: [填入联系方式]
- **运维团队**: [填入联系方式]
- **业务负责人**: [填入联系方式]

## 📈 性能基准 (Performance Benchmarks)

### ✅ 预期性能指标
- **数据延迟**: < 100ms (从交易所到NATS)
- **处理吞吐量**: > 1000 msg/s
- **内存使用**: < 1GB (正常运行)
- **CPU使用**: < 50% (正常负载)
- **连接成功率**: > 99.9%
- **数据完整性**: > 99.99%

---

## ✅ 部署完成确认

部署完成后，请确认以下所有项目都已检查并通过：

- [ ] 所有服务正常运行
- [ ] 健康检查全部通过
- [ ] 监控指标正常
- [ ] 告警配置生效
- [ ] 文档更新完成
- [ ] 团队培训完成

**部署负责人签名**: _________________ **日期**: _________

**技术审核人签名**: _________________ **日期**: _________
