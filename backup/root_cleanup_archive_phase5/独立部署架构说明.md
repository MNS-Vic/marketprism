# MarketPrism ç‹¬ç«‹éƒ¨ç½²æ¶æ„è¯´æ˜

## ğŸ¯ ç‹¬ç«‹éƒ¨ç½²æ ¸å¿ƒç‰¹å¾

æ¯ä¸ªæœåŠ¡éƒ½æ˜¯**å®Œå…¨ç‹¬ç«‹çš„éƒ¨ç½²å•å…ƒ**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

### 1. ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸ
```yaml
ç‹¬ç«‹å¼€å‘: æ¯ä¸ªå›¢é˜Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘è‡ªå·±è´Ÿè´£çš„æœåŠ¡
ç‹¬ç«‹æµ‹è¯•: å„æœåŠ¡æœ‰ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒå’Œæµ‹è¯•æµç¨‹  
ç‹¬ç«‹å‘å¸ƒ: æœåŠ¡å¯ä»¥æŒ‰éœ€å‘å¸ƒï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
ç‹¬ç«‹æ‰©å±•: æ ¹æ®è´Ÿè½½æƒ…å†µç‹¬ç«‹æ‰©ç¼©å®¹
ç‹¬ç«‹æ•…éšœ: ä¸€ä¸ªæœåŠ¡æ•…éšœä¸ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ
```

### 2. ç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒ
```yaml
ç‹¬ç«‹è¿›ç¨‹: æ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹/å®¹å™¨ä¸­
ç‹¬ç«‹ç«¯å£: æ¯ä¸ªæœåŠ¡å ç”¨ä¸åŒçš„ç«¯å£
ç‹¬ç«‹èµ„æº: CPUã€å†…å­˜ã€å­˜å‚¨èµ„æºç‹¬ç«‹åˆ†é…
ç‹¬ç«‹é…ç½®: æ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶
```

## ğŸ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²

### æœåŠ¡å®¹å™¨åŒ–æ–¹æ¡ˆ
```yaml
market-data-collector:
  container_name: marketprism-collector
  image: marketprism/collector:v1.0.0
  ports: ["8001:8000"]
  environment:
    - SERVICE_NAME=market-data-collector
    - NATS_URL=nats://message-broker:4222
    - CLICKHOUSE_URL=clickhouse://data-storage:9000

data-storage-service:
  container_name: marketprism-storage
  image: marketprism/storage:v1.0.0
  ports: ["8002:8000"]
  environment:
    - SERVICE_NAME=data-storage-service
    - CLICKHOUSE_HOST=clickhouse
    - CLICKHOUSE_PORT=9000

api-gateway-service:
  container_name: marketprism-gateway
  image: marketprism/gateway:v1.0.0
  ports: ["8000:8000"]  # å¤–éƒ¨è®¿é—®å…¥å£
  environment:
    - SERVICE_NAME=api-gateway
    - COLLECTOR_URL=http://market-data-collector:8000
    - STORAGE_URL=http://data-storage-service:8000

monitoring-service:
  container_name: marketprism-monitoring
  image: marketprism/monitoring:v1.0.0
  ports: ["3000:3000", "9090:9090"]
  environment:
    - SERVICE_NAME=monitoring-service
    - GRAFANA_PORT=3000
    - PROMETHEUS_PORT=9090

message-broker-service:
  container_name: marketprism-nats
  image: nats:2.9-alpine
  ports: ["4222:4222", "8222:8222"]
  command: ["--jetstream", "--store_dir", "/data"]

scheduler-service:
  container_name: marketprism-scheduler
  image: marketprism/scheduler:v1.0.0
  ports: ["8003:8000"]
  environment:
    - SERVICE_NAME=scheduler-service
    - NATS_URL=nats://message-broker:4222
```

## ğŸš€ ç‹¬ç«‹éƒ¨ç½²ç¤ºä¾‹

### 1. å•æœåŠ¡éƒ¨ç½²
```bash
# åªéƒ¨ç½²æ•°æ®æ”¶é›†æœåŠ¡
docker run -d \
  --name marketprism-collector \
  -p 8001:8000 \
  -e NATS_URL=nats://192.168.1.100:4222 \
  -e CLICKHOUSE_URL=clickhouse://192.168.1.101:9000 \
  marketprism/collector:v1.0.0

# åªéƒ¨ç½²APIç½‘å…³
docker run -d \
  --name marketprism-gateway \
  -p 8000:8000 \
  -e COLLECTOR_URL=http://192.168.1.102:8001 \
  -e STORAGE_URL=http://192.168.1.103:8002 \
  marketprism/gateway:v1.0.0
```

### 2. åˆ†æœºæˆ¿éƒ¨ç½²
```yaml
# æœºæˆ¿A - æ ¸å¿ƒä¸šåŠ¡æœåŠ¡
services:
  - market-data-collector
  - data-storage-service
  - api-gateway-service

# æœºæˆ¿B - åŸºç¡€è®¾æ–½æœåŠ¡  
services:
  - monitoring-service
  - message-broker-service
  - scheduler-service

# è·¨æœºæˆ¿é€šä¿¡
network:
  - VPNéš§é“æˆ–ä¸“çº¿è¿æ¥
  - æœåŠ¡å‘ç°æ³¨å†Œä¸­å¿ƒ
```

### 3. å¤šç¯å¢ƒéƒ¨ç½²
```yaml
# å¼€å‘ç¯å¢ƒ - å•æœºéƒ¨ç½²
docker-compose -f docker-compose.dev.yml up

# æµ‹è¯•ç¯å¢ƒ - æ¨¡æ‹Ÿç”Ÿäº§æ‹“æ‰‘
docker-compose -f docker-compose.test.yml up

# ç”Ÿäº§ç¯å¢ƒ - K8sé›†ç¾¤éƒ¨ç½²
kubectl apply -f k8s/production/
```

## ğŸ”§ ç‹¬ç«‹éƒ¨ç½²çš„æŠ€æœ¯å®ç°

### 1. æœåŠ¡å‘ç°
```python
# æ¯ä¸ªæœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
from core.networking import ServiceRegistry

class MarketDataCollector:
    def __init__(self):
        self.registry = ServiceRegistry()
        
    async def start(self):
        # æ³¨å†Œè‡ªå·±
        await self.registry.register(
            service_name="market-data-collector",
            host=self.host,
            port=self.port,
            health_check_url=f"http://{self.host}:{self.port}/health"
        )
        
    async def discover_storage_service(self):
        # å‘ç°å­˜å‚¨æœåŠ¡
        storage_nodes = await self.registry.discover("data-storage-service")
        return storage_nodes[0]  # è´Ÿè½½å‡è¡¡é€‰æ‹©
```

### 2. é…ç½®ç®¡ç†
```yaml
# æ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶
market-data-collector/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ base.yaml          # åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ development.yaml   # å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ production.yaml    # ç”Ÿäº§ç¯å¢ƒ
â”‚   â””â”€â”€ local.yaml         # æœ¬åœ°è¦†ç›–
â””â”€â”€ Dockerfile

data-storage-service/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ base.yaml
â”‚   â”œâ”€â”€ development.yaml
â”‚   â””â”€â”€ production.yaml
â””â”€â”€ Dockerfile
```

### 3. å¥åº·æ£€æŸ¥
```python
# æ¯ä¸ªæœåŠ¡æä¾›æ ‡å‡†å¥åº·æ£€æŸ¥æ¥å£
@app.get("/health")
async def health_check():
    return {
        "service": "market-data-collector",
        "status": "healthy",
        "version": "1.0.0",
        "timestamp": datetime.utcnow(),
        "dependencies": {
            "clickhouse": await check_clickhouse_health(),
            "nats": await check_nats_health()
        }
    }
```

## ğŸ“Š ç‹¬ç«‹éƒ¨ç½²çš„ä¼˜åŠ¿

### 1. æŠ€æœ¯æ ˆçµæ´»æ€§
```yaml
market-data-collector:
  language: Python
  framework: FastAPI
  database: Redis (ç¼“å­˜)

data-storage-service:
  language: Python
  framework: FastAPI  
  database: ClickHouse

api-gateway-service:
  language: Go (é«˜æ€§èƒ½éœ€æ±‚)
  framework: Gin
  middleware: Nginx

monitoring-service:
  technology: Prometheus + Grafana
  language: Python (è‡ªå®šä¹‰æŒ‡æ ‡)
```

### 2. ç‹¬ç«‹æ‰©å±•
```bash
# åªæ‰©å±•æ•°æ®æ”¶é›†æœåŠ¡ï¼ˆé«˜å¹¶å‘åœºæ™¯ï¼‰
docker service scale marketprism-collector=5

# åªæ‰©å±•å­˜å‚¨æœåŠ¡ï¼ˆå¤§æ•°æ®å†™å…¥åœºæ™¯ï¼‰
docker service scale marketprism-storage=3

# APIç½‘å…³ä¿æŒå•å®ä¾‹ï¼ˆè´Ÿè½½å‡è¡¡å™¨åé¢ï¼‰
docker service scale marketprism-gateway=1
```

### 3. ç‹¬ç«‹ç‰ˆæœ¬ç®¡ç†
```yaml
services:
  market-data-collector: v2.1.0  # æœ€æ–°ç‰ˆæœ¬ï¼Œæ–°åŠŸèƒ½
  data-storage-service: v1.5.2   # ç¨³å®šç‰ˆæœ¬ï¼Œbugä¿®å¤
  api-gateway-service: v1.0.0    # ç¨³å®šè¿è¡Œï¼Œæ— éœ€æ›´æ–°
  monitoring-service: v3.0.0     # å¤§ç‰ˆæœ¬å‡çº§ï¼Œæ–°ç›‘æ§åŠŸèƒ½
```

## âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜

### 1. æœåŠ¡é—´ä¾èµ–
```python
# å¯åŠ¨é¡ºåºä¾èµ–
startup_order = [
    "message-broker-service",    # æ¶ˆæ¯ä¸­é—´ä»¶å…ˆå¯åŠ¨
    "data-storage-service",      # å­˜å‚¨æœåŠ¡
    "market-data-collector",     # æ•°æ®æ”¶é›†ä¾èµ–å­˜å‚¨
    "api-gateway-service",       # ç½‘å…³æœ€åå¯åŠ¨
    "monitoring-service",        # ç›‘æ§æœåŠ¡ç‹¬ç«‹
    "scheduler-service"          # è°ƒåº¦æœåŠ¡ç‹¬ç«‹
]
```

### 2. æ•°æ®ä¸€è‡´æ€§
```python
# åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
class DataConsistencyManager:
    async def process_market_data(self, data):
        # ä½¿ç”¨Sagaæ¨¡å¼ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
        saga = Saga()
        saga.add_step(
            action=self.collector.normalize_data,
            compensation=self.collector.rollback_normalization
        )
        saga.add_step(
            action=self.storage.save_data,
            compensation=self.storage.delete_data
        )
        await saga.execute()
```

### 3. ç½‘ç»œå»¶è¿Ÿ
```python
# æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–
class ServiceCommunication:
    def __init__(self):
        # è¿æ¥æ± å¤ç”¨
        self.http_pool = aiohttp.ClientSession(
            timeout=aiohttp.ClientTimeout(total=30),
            connector=aiohttp.TCPConnector(limit=100)
        )
        
        # ç†”æ–­å™¨
        self.circuit_breaker = CircuitBreaker(
            failure_threshold=5,
            recovery_timeout=60
        )
```

## æ€»ç»“

æ˜¯çš„ï¼Œ**æ¯ä¸ªæœåŠ¡éƒ½å®Œå…¨ç‹¬ç«‹éƒ¨ç½²**ï¼š

âœ… **ç‹¬ç«‹è¿›ç¨‹**: æ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨ç‹¬ç«‹å®¹å™¨ä¸­
âœ… **ç‹¬ç«‹ç«¯å£**: é¿å…ç«¯å£å†²çª  
âœ… **ç‹¬ç«‹é…ç½®**: å„è‡ªçš„é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
âœ… **ç‹¬ç«‹æ‰©å±•**: æ ¹æ®éœ€è¦ç‹¬ç«‹æ‰©ç¼©å®¹
âœ… **ç‹¬ç«‹å‘å¸ƒ**: æœåŠ¡æ›´æ–°ä¸å½±å“å…¶ä»–æœåŠ¡
âœ… **ç‹¬ç«‹æ•…éšœ**: æ•…éšœéš”ç¦»ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§

è¿™æ ·çš„æ¶æ„è®¾è®¡è®©ä½ å¯ä»¥ï¼š
- æŒ‰éœ€éƒ¨ç½²ç‰¹å®šæœåŠ¡
- åœ¨ä¸åŒæœºæˆ¿éƒ¨ç½²ä¸åŒæœåŠ¡  
- ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆå¼€å‘ä¸åŒæœåŠ¡
- æ ¹æ®ä¸šåŠ¡éœ€è¦ç‹¬ç«‹æ‰©å±•æœåŠ¡
- å®ç°çœŸæ­£çš„DevOpså’ŒCI/CD