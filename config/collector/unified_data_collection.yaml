# ç»Ÿä¸€æ•°æ®æ”¶é›†é…ç½®
# åŸºäºæ–°çš„WebSocketæ¶æ„ï¼Œæ”¯æŒå¤šäº¤æ˜“æ‰€ã€å¤šå¸‚åœºç±»å‹çš„æ•°æ®æ”¶é›†

# ç³»ç»Ÿé…ç½®
system:
  name: "marketprism-unified-collector"
  version: "2.0.0"
  environment: "production"
  debug: false
  
  # å¯ç”¨æ–°çš„ç»Ÿä¸€WebSocketæ¶æ„
  use_unified_websocket: true
  
  # æ—¥å¿—é…ç½®
  logging:
    level: "INFO"
    format: "json"
    file: "/tmp/unified-collector.log"
    max_size: "100MB"
    backup_count: 5

# ç½‘ç»œé…ç½®
networking:
  # WebSocketè¿æ¥é…ç½®
  websocket:
    timeout: 30
    max_retries: 3
    retry_delay: 5
    ping_interval: 20
    ping_timeout: 60
    max_size: 1048576  # 1MB

    # é•¿æœŸè¿è¡Œé…ç½®
    auto_reconnect: true
    max_reconnect_attempts: -1  # æ— é™é‡è¿
    reconnect_delay: 1.0
    max_reconnect_delay: 300.0
    backoff_multiplier: 2.0
    connection_timeout: 86400  # 24å°æ—¶

    # ä¸»åŠ¨é‡è¿é…ç½®
    proactive_reconnect_enabled: true
    proactive_reconnect_threshold: 86100  # 23å°æ—¶55åˆ†é’Ÿ
    dual_connection_enabled: true
    data_buffer_size: 1000

    # WebSocketç¨³å®šæ€§ä¼˜åŒ–é…ç½®
    stability:
      # å¿ƒè·³æœºåˆ¶é…ç½®
      heartbeat:
        binance_spot_interval: 20      # Binanceç°è´§å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
        binance_derivatives_interval: 180  # Binanceè¡ç”Ÿå“å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
        okx_interval: 25               # OKXå¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
        timeout: 60                    # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        max_consecutive_failures: 3   # æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°

      # é‡è¿æœºåˆ¶é…ç½®
      reconnection:
        enabled: true
        initial_delay: 1.0             # åˆå§‹é‡è¿å»¶è¿Ÿï¼ˆç§’ï¼‰
        max_delay: 30.0               # æœ€å¤§é‡è¿å»¶è¿Ÿï¼ˆç§’ï¼‰
        backoff_multiplier: 2.0       # æŒ‡æ•°é€€é¿å€æ•°
        max_attempts: -1              # æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆ-1ä¸ºæ— é™ï¼‰
        connection_timeout: 10.0      # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
        health_check_interval: 30.0   # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰

      # å†…å­˜ç®¡ç†é…ç½®
      memory_management:
        enabled: true
        max_orderbook_states: 1000    # æœ€å¤§è®¢å•ç°¿çŠ¶æ€æ•°é‡
        cleanup_interval: 300.0       # æ¸…ç†é—´éš”ï¼ˆç§’ï¼‰
        inactive_threshold: 3600.0    # éæ´»è·ƒé˜ˆå€¼ï¼ˆç§’ï¼‰
        memory_check_interval: 60.0   # å†…å­˜æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
        max_memory_mb: 512            # æœ€å¤§å†…å­˜ä½¿ç”¨ï¼ˆMBï¼‰
        memory_warning_threshold: 0.8 # å†…å­˜è­¦å‘Šé˜ˆå€¼ï¼ˆ80%ï¼‰

      # é”™è¯¯æ¢å¤é…ç½®
      error_recovery:
        enabled: true
        max_consecutive_errors: 5     # æœ€å¤§è¿ç»­é”™è¯¯æ¬¡æ•°
        error_reset_interval: 300.0   # é”™è¯¯é‡ç½®é—´éš”ï¼ˆç§’ï¼‰
        checksum_failure_threshold: 3 # checksumå¤±è´¥é˜ˆå€¼
        sequence_error_threshold: 3   # åºåˆ—é”™è¯¯é˜ˆå€¼
        auto_resync_enabled: true     # è‡ªåŠ¨é‡æ–°åŒæ­¥
        resync_delay: 5.0             # é‡æ–°åŒæ­¥å»¶è¿Ÿï¼ˆç§’ï¼‰
        max_resync_attempts: 3        # æœ€å¤§é‡æ–°åŒæ­¥å°è¯•æ¬¡æ•°

      # æ€§èƒ½ç›‘æ§é…ç½®ï¼ˆåŸºäºAPIæµ‹è¯•ä¼˜åŒ–ï¼‰
      performance_monitoring:
        enabled: true
        monitoring_interval: 60.0     # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
        latency_warning_threshold: 200.0  # å»¶è¿Ÿè­¦å‘Šé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼ŒåŸºäºAPIæµ‹è¯•ä¼˜åŒ–ï¼‰
        throughput_warning_threshold: 10.0 # ååé‡è­¦å‘Šé˜ˆå€¼ï¼ˆmsg/sï¼‰
        cpu_warning_threshold: 80.0   # CPUè­¦å‘Šé˜ˆå€¼ï¼ˆ%ï¼‰
        detailed_stats_interval: 300.0 # è¯¦ç»†ç»Ÿè®¡é—´éš”ï¼ˆç§’ï¼‰
        performance_history_size: 100 # æ€§èƒ½å†å²è®°å½•å¤§å°

      # æ—¥å¿—è®°å½•é…ç½®
      logging:
        enabled: true
        log_level: "INFO"             # DEBUG, INFO, WARNING, ERROR
        structured_logging: true      # ç»“æ„åŒ–æ—¥å¿—
        log_performance: true         # è®°å½•æ€§èƒ½æ—¥å¿—
        log_errors: true              # è®°å½•é”™è¯¯æ—¥å¿—
        log_connections: true         # è®°å½•è¿æ¥æ—¥å¿—
        log_data_flow: false          # è®°å½•æ•°æ®æµæ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
        sensitive_fields: ["api_key", "api_secret", "passphrase"]  # æ•æ„Ÿå­—æ®µ
  
  # HTTPé…ç½®
  http:
    timeout: 30
    connector_limit: 100
    connector_limit_per_host: 30
    retry_attempts: 3
  
  # ä»£ç†é…ç½®
  proxy:
    enabled: false
    # http_proxy: "http://proxy.example.com:8080"
    # https_proxy: "http://proxy.example.com:8080"

# äº¤æ˜“æ‰€é…ç½®
exchanges:
  # Binanceç°è´§
  binance_spot:
    name: "binance"
    exchange: "binance_spot"
    market_type: "spot"
    enabled: true
    
    # APIç«¯ç‚¹
    api:
      base_url: "https://api.binance.com"
      ws_url: "wss://stream.binance.com:9443"
    
    # äº¤æ˜“å¯¹é…ç½® - æµ‹è¯•ç°è´§å’Œè¡ç”Ÿå“åŒæ—¶è¿è¡Œ
    symbols: ["BTCUSDT", "ETHUSDT"]  # ç°è´§BTCå’ŒETH
    
    # æ•°æ®ç±»å‹ - ä¸“æ³¨è®¢å•ç°¿é—®é¢˜
    data_types: ["orderbook"]  # åªå¯ç”¨orderbook
    
    # è®¢å•ç°¿é…ç½®
    orderbook:
      depth_limit: 1000
      snapshot_interval: 60
      update_frequency: 100
      validation_enabled: true
  
  # Binanceè¡ç”Ÿå“ï¼ˆæ°¸ç»­åˆçº¦ï¼‰- é‡æ–°å¯ç”¨æµ‹è¯•
  binance_derivatives:
    name: "binance_derivatives"
    exchange: "binance_derivatives"
    market_type: "perpetual"
    enabled: true  # é‡æ–°å¯ç”¨è¡ç”Ÿå“æµ‹è¯•
    
    # APIç«¯ç‚¹ï¼ˆæ°¸ç»­åˆçº¦ï¼‰
    api:
      base_url: "https://fapi.binance.com"
      ws_url: "wss://fstream.binance.com"
    
    # æ°¸ç»­åˆçº¦äº¤æ˜“å¯¹ - æµ‹è¯•ç°è´§å’Œè¡ç”Ÿå“åŒæ—¶è¿è¡Œ
    symbols: ["BTCUSDT", "ETHUSDT"]  # è¡ç”Ÿå“BTCå’ŒETH
    
    # æ•°æ®ç±»å‹ - ä¸“æ³¨è®¢å•ç°¿é—®é¢˜
    data_types: ["orderbook"]  # åªå¯ç”¨orderbook
    
    # è®¢å•ç°¿é…ç½®
    orderbook:
      depth_limit: 1000
      snapshot_interval: 60
      update_frequency: 100
      validation_enabled: true
  
  # OKXç°è´§ - æš‚æ—¶ç¦ç”¨ä¸“æ³¨Binanceé—®é¢˜
  okx_spot:
    name: "okx_spot"
    exchange: "okx_spot"
    market_type: "spot"
    enabled: false  # ç¦ç”¨OKXç°è´§
    
    # APIç«¯ç‚¹
    api:
      base_url: "https://www.okx.com"
      ws_url: "wss://ws.okx.com:8443/ws/v5/public"
    
    # ç°è´§äº¤æ˜“å¯¹
    symbols: ["BTC-USDT", "ETH-USDT"]
    
    # æ•°æ®ç±»å‹
    data_types: ["orderbook", "trade"]
    
    # è®¢å•ç°¿é…ç½®
    orderbook:
      depth_limit: 1000
      snapshot_interval: 60
      update_frequency: 100
      validation_enabled: true
  
  # OKXè¡ç”Ÿå“ï¼ˆæ°¸ç»­åˆçº¦ï¼‰- æš‚æ—¶ç¦ç”¨ä¸“æ³¨Binanceé—®é¢˜
  okx_derivatives:
    name: "okx_derivatives"
    exchange: "okx_derivatives"
    market_type: "perpetual"
    enabled: false  # ç¦ç”¨OKXè¡ç”Ÿå“
    
    # APIç«¯ç‚¹
    api:
      base_url: "https://www.okx.com"
      ws_url: "wss://ws.okx.com:8443/ws/v5/public"
    
    # æ°¸ç»­åˆçº¦äº¤æ˜“å¯¹
    symbols: ["BTC-USDT-SWAP", "ETH-USDT-SWAP"]
    
    # æ•°æ®ç±»å‹
    data_types: ["orderbook", "trade", "funding_rate", "open_interest"]
    
    # è®¢å•ç°¿é…ç½®
    orderbook:
      depth_limit: 1000
      snapshot_interval: 60
      update_frequency: 100
      validation_enabled: true

# NATSé…ç½® - æš‚æ—¶ç¦ç”¨ä¸“æ³¨è®¢å•ç°¿é—®é¢˜
nats:
  # å¯ç”¨çŠ¶æ€
  enabled: false  # ç¦ç”¨NATSä¸“æ³¨è®¢å•ç°¿é—®é¢˜
  # è¿æ¥é…ç½®
  servers: ["nats://localhost:4222"]
  client_name: "unified-collector"
  max_reconnect_attempts: 10
  reconnect_time_wait: 2
  
  # æ•°æ®æµé…ç½®
  streams:
    # è®¢å•ç°¿æ•°æ®æµ
    orderbook: "orderbook-data.{exchange}.{market_type}.{symbol}"

    # äº¤æ˜“æ•°æ®æµ
    trade: "trade-data.{exchange}.{market_type}.{symbol}"

    # æ°¸ç»­åˆçº¦ç‰¹æœ‰æ•°æ®æµ
    funding_rate: "funding-rate.{exchange}.{market_type}.{symbol}"
    open_interest: "open-interest.{exchange}.{market_type}.{symbol}"

    # ğŸ”§ æ–°å¢ï¼šå¼ºå¹³è®¢å•æ•°æ®æµï¼ˆæ•´åˆè‡ªliquidation_collector.yamlï¼‰
    liquidation: "liquidation-data.{exchange}.{market_type}.{symbol}"
  
  # å‘å¸ƒé…ç½®
  publish:
    timeout: 5
    max_retries: 3
    batch_size: 100

  # ğŸ”§ JetStreamé…ç½® - ç¡®ä¿é‡‘èæ•°æ®ä¸ä¸¢å¤±
  jetstream:
    enabled: true  # å¯ç”¨JetStreamç¡®ä¿æ•°æ®æŒä¹…åŒ–
    streams:
      MARKET_DATA:
        name: "MARKET_DATA"
        subjects:
          - "orderbook-data.>"
          - "trade-data.>"
          - "funding-rate.>"
          - "open-interest.>"
          - "liquidation-data.>"  # ğŸ”§ æ›´æ–°ï¼šç»Ÿä¸€å¼ºå¹³æ•°æ®ä¸»é¢˜æ ¼å¼
          - "kline-data.>"
        retention: "limits"
        max_msgs: 5000000      # 500ä¸‡æ¡æ¶ˆæ¯
        max_bytes: 2147483648  # 2GB
        max_age: 172800        # 48å°æ—¶
        max_consumers: 50      # æ”¯æŒ50ä¸ªæ¶ˆè´¹è€…
        replicas: 1
        storage: "file"        # æ–‡ä»¶å­˜å‚¨ç¡®ä¿æŒä¹…åŒ–
        discard: "old"         # è¾¾åˆ°é™åˆ¶æ—¶ä¸¢å¼ƒæ—§æ¶ˆæ¯
        duplicate_window: 120  # 2åˆ†é’Ÿé‡å¤æ£€æµ‹

# ClickHouseé…ç½®
clickhouse:
  # è¿æ¥é…ç½®
  host: "localhost"
  port: 9000
  database: "marketprism"
  username: "default"
  password: ""
  
  # è¡¨é…ç½®
  tables:
    orderbook_spot: "orderbook_spot"
    orderbook_perpetual: "orderbook_perpetual"
    trades_spot: "trades_spot"
    trades_perpetual: "trades_perpetual"
    funding_rates: "funding_rates"
    open_interest: "open_interest"
  
  # æ‰¹é‡å†™å…¥é…ç½®
  batch:
    size: 1000
    timeout: 10
    max_retries: 3

# ç›‘æ§é…ç½®
monitoring:
  # æŒ‡æ ‡æ”¶é›†
  metrics:
    enabled: true
    port: 9093
    path: "/metrics"
  
  # å¥åº·æ£€æŸ¥
  health_check:
    enabled: true
    port: 8086  # å¥åº·æ£€æŸ¥ç«¯å£
    path: "/health"
    interval: 30
  
  # æ€§èƒ½ç›‘æ§
  performance:
    enabled: true
    sample_rate: 0.1
    track_memory: true
    track_cpu: true

# é”™è¯¯å¤„ç†é…ç½®
error_handling:
  # é‡è¯•é…ç½®
  retry:
    max_attempts: 3
    backoff_multiplier: 2.0
    max_backoff_seconds: 300
  
  # ç†”æ–­å™¨é…ç½®
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    recovery_timeout: 60
  
  # å‘Šè­¦é…ç½®
  alerts:
    enabled: true
    webhook_url: ""
    critical_errors: ["connection_failed", "data_corruption", "nats_publish_failed"]

# æ•°æ®è´¨é‡é…ç½®
data_quality:
  # éªŒè¯è§„åˆ™
  validation:
    enabled: true
    strict_mode: false
    max_price_deviation: 0.1  # 10%
    max_timestamp_drift: 5    # 5ç§’

  # æ•°æ®æ¸…æ´—
  cleaning:
    enabled: true
    remove_duplicates: true
    filter_invalid_prices: true
    normalize_timestamps: true

  # ğŸ”§ ä»data_collection_config.ymlè¿ç§»çš„å¢å¼ºé…ç½®
  deduplication_enabled: true
  anomaly_detection_enabled: true
  price_deviation_threshold: 0.1  # 10%
  volume_threshold: 1000
  completeness_target: 0.95  # 95%
  latency_target: 1000  # 1ç§’ï¼ˆæ¯«ç§’ï¼‰

# ğŸ”§ æ–°å¢ï¼šæ•°æ®ç±»å‹è¯¦ç»†é…ç½®ï¼ˆä»data_collection_config.ymlè¿ç§»ï¼‰
data_types:
  # è®¢å•ç°¿æ•°æ® - ä¸“æ³¨Binanceé—®é¢˜
  orderbook:
    method: "websocket"
    interval: null
    real_time: true
    historical: false
    exchanges: ["binance_spot", "binance_derivatives"]  # åªå¯ç”¨Binance

  # äº¤æ˜“æ•°æ® - æš‚æ—¶ç¦ç”¨ä¸“æ³¨è®¢å•ç°¿é—®é¢˜
  trade:
    method: "websocket"
    interval: null
    real_time: true
    historical: false
    exchanges: []  # ç¦ç”¨æ‰€æœ‰trade manager

  # ä»·æ ¼è¡Œæƒ…æ•°æ® - æš‚æ—¶ç¦ç”¨ä¸“æ³¨è®¢å•ç°¿é—®é¢˜
  ticker:
    method: "websocket"
    interval: null
    real_time: true
    historical: false
    exchanges: []  # ç¦ç”¨ticker

  # èµ„é‡‘è´¹ç‡ï¼ˆä»…è¡ç”Ÿå“ï¼‰- æš‚æ—¶ç¦ç”¨
  funding_rate:
    method: "rest_api"
    interval: 3600  # æ¯å°æ—¶
    real_time: false
    historical: true
    exchanges: []  # ç¦ç”¨

  # æŒä»“é‡ï¼ˆä»…è¡ç”Ÿå“ï¼‰- æš‚æ—¶ç¦ç”¨
  open_interest:
    method: "rest_api"
    interval: 300  # æ¯5åˆ†é’Ÿ
    real_time: false
    historical: true
    exchanges: []  # ç¦ç”¨

  # ğŸ”§ æ–°å¢ï¼šå¼ºå¹³è®¢å•æ•°æ®ï¼ˆæ•´åˆè‡ªliquidation_collector.yamlï¼‰- æš‚æ—¶ç¦ç”¨
  liquidation:
    method: "websocket"
    interval: null
    real_time: true
    historical: false
    exchanges: []  # ç¦ç”¨

    # å¼ºå¹³æ•°æ®è¿‡æ»¤é…ç½®
    filters:
      min_value_usd: 1000  # æœ€å°å¼ºå¹³ä»·å€¼ (ç¾å…ƒ)
      max_value_usd: 10000000  # æœ€å¤§å¼ºå¹³ä»·å€¼ (ç¾å…ƒ)

    # æ•°æ®éªŒè¯
    validation:
      required_fields: ["exchange_name", "symbol_name", "side", "price", "quantity"]
      price_range_check: true
      quantity_range_check: true

    # å‘Šè­¦é…ç½®
    alerts:
      large_liquidation_threshold: 100000  # å¤§é¢å¼ºå¹³é˜ˆå€¼ï¼ˆç¾å…ƒï¼‰

# ğŸ”§ æ–°å¢ï¼šå­˜å‚¨é…ç½®ï¼ˆä»data_collection_config.ymlè¿ç§»ï¼‰
storage:
  buffer_size: 1000
  batch_size: 100
  flush_interval: 10  # ç§’
  compression_enabled: true

# ğŸ”§ æ–°å¢ï¼šäº¤æ˜“ç­–ç•¥é…ç½®ï¼ˆä»trading_strategies.yamlè¿ç§»ï¼‰
trading_strategies:
  # é»˜è®¤ç­–ç•¥é…ç½®
  default:
    depth_config:
      exchanges:
        binance:
          spot:
            snapshot_depth: 1000
            websocket_depth: 1000
            api_weight: 10
            update_frequency: "100ms"
          perpetual:
            snapshot_depth: 1000
            websocket_depth: 1000
            api_weight: 10
            update_frequency: "100ms"
        okx:
          spot:
            snapshot_depth: 400
            websocket_depth: 400
            api_weight: 5
            update_frequency: "100ms"
          perpetual:
            snapshot_depth: 400
            websocket_depth: 400
            api_weight: 5
            update_frequency: "100ms"

    performance_config:
      snapshot_interval: 60
      max_latency_ms: 1000
      error_tolerance: "medium"

  # é«˜é¢‘äº¤æ˜“ç­–ç•¥
  high_frequency:
    depth_config:
      exchanges:
        binance:
          spot:
            snapshot_depth: 100
            websocket_depth: 100
            api_weight: 5
            update_frequency: "10ms"
        okx:
          spot:
            snapshot_depth: 100
            websocket_depth: 100
            api_weight: 3
            update_frequency: "10ms"

    performance_config:
      snapshot_interval: 10
      max_latency_ms: 100
      error_tolerance: "strict"
