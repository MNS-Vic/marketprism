#!/usr/bin/env python3\n\"\"\"\nç®€åŒ–çš„Deribitè¿žæŽ¥è°ƒè¯•è„šæœ¬\nç›´æŽ¥ä½¿ç”¨aiohttpæµ‹è¯•WebSocketè¿žæŽ¥\n\"\"\"\n\nimport asyncio\nimport aiohttp\nimport json\nimport os\nimport sys\nfrom datetime import datetime\n\n\nasync def test_deribit_direct():\n    \"\"\"ç›´æŽ¥æµ‹è¯•Deribit WebSocketè¿žæŽ¥\"\"\"\n    print(\"ðŸŸ£ å¼€å§‹æµ‹è¯•Deribitç›´æŽ¥WebSocketè¿žæŽ¥\")\n    print(\"=\" * 50)\n    \n    # WebSocket URL\n    ws_url = \"wss://www.deribit.com/ws/api/v2\"\n    \n    # èŽ·å–ä»£ç†è®¾ç½®\n    proxy = os.getenv('https_proxy') or os.getenv('http_proxy')\n    print(f\"ðŸ“¡ ä»£ç†è®¾ç½®: {proxy}\")\n    print(f\"ðŸŒ WebSocket URL: {ws_url}\")\n    \n    session = None\n    ws = None\n    \n    try:\n        # åˆ›å»ºsession\n        timeout = aiohttp.ClientTimeout(total=30)\n        session = aiohttp.ClientSession(timeout=timeout)\n        \n        print(\"ðŸ”— å°è¯•WebSocketè¿žæŽ¥...\")\n        start_time = datetime.now()\n        \n        # æ–¹å¼1ï¼šä½¿ç”¨ä»£ç†è¿žæŽ¥\n        if proxy:\n            print(f\"ðŸ”„ ä½¿ç”¨ä»£ç†è¿žæŽ¥: {proxy}\")\n            ws = await session.ws_connect(\n                ws_url,\n                proxy=proxy,\n                ssl=False,  # ç¦ç”¨SSLéªŒè¯\n                heartbeat=30\n            )\n        else:\n            print(\"ðŸ”„ ç›´æŽ¥è¿žæŽ¥ï¼ˆæ— ä»£ç†ï¼‰\")\n            ws = await session.ws_connect(\n                ws_url,\n                ssl=False,  # ç¦ç”¨SSLéªŒè¯\n                heartbeat=30\n            )\n        \n        connect_time = datetime.now()\n        print(f\"âœ… WebSocketè¿žæŽ¥æˆåŠŸï¼è€—æ—¶: {(connect_time - start_time).total_seconds():.2f}ç§’\")\n        \n        # æµ‹è¯•è®¢é˜…\n        subscribe_msg = {\n            \"jsonrpc\": \"2.0\",\n            \"id\": 1,\n            \"method\": \"public/subscribe\",\n            \"params\": {\n                \"channels\": [\"ticker.BTC-PERPETUAL.100ms\"]\n            }\n        }\n        \n        print(\"ðŸ“¤ å‘é€è®¢é˜…è¯·æ±‚...\")\n        await ws.send_str(json.dumps(subscribe_msg))\n        \n        # ç­‰å¾…å“åº”\n        message_count = 0\n        test_duration = 10  # æµ‹è¯•10ç§’\n        timeout_time = datetime.now().timestamp() + test_duration\n        \n        print(f\"â³ ç­‰å¾…æ¶ˆæ¯... ({test_duration}ç§’)\")\n        \n        async for msg in ws:\n            if datetime.now().timestamp() > timeout_time:\n                break\n                \n            if msg.type == aiohttp.WSMsgType.TEXT:\n                data = json.loads(msg.data)\n                message_count += 1\n                \n                if message_count <= 3:  # åªæ˜¾ç¤ºå‰3æ¡æ¶ˆæ¯\n                    print(f\"ðŸ“¨ æ¶ˆæ¯ {message_count}: {json.dumps(data, indent=2)[:200]}...\")\n                \n                if message_count == 1 and \"result\" in data:\n                    print(\"âœ… è®¢é˜…ç¡®è®¤æ”¶åˆ°\")\n                \n            elif msg.type == aiohttp.WSMsgType.ERROR:\n                print(f\"âŒ WebSocketé”™è¯¯: {msg.data}\")\n                break\n            elif msg.type == aiohttp.WSMsgType.CLOSE:\n                print(\"ðŸ”š WebSocketè¿žæŽ¥å…³é—­\")\n                break\n        \n        print(f\"\\nðŸ“Š æµ‹è¯•ç»“æžœ:\")\n        print(f\"   âœ… è¿žæŽ¥æˆåŠŸ: æ˜¯\")\n        print(f\"   ðŸ“¨ æ”¶åˆ°æ¶ˆæ¯æ•°: {message_count}\")\n        print(f\"   â±ï¸ æµ‹è¯•æ—¶é•¿: {test_duration}ç§’\")\n        \n        return True\n        \n    except asyncio.TimeoutError:\n        print(\"âŒ è¿žæŽ¥è¶…æ—¶\")\n        return False\n    except Exception as e:\n        print(f\"âŒ è¿žæŽ¥å¤±è´¥: {type(e).__name__}: {str(e)}\")\n        return False\n    finally:\n        # æ¸…ç†\n        if ws:\n            await ws.close()\n        if session:\n            await session.close()\n\n\nasync def test_curl_comparison():\n    \"\"\"å¯¹æ¯”curlæµ‹è¯•ç»“æžœ\"\"\"\n    print(\"\\nðŸŒ curlå¯¹æ¯”æµ‹è¯•\")\n    print(\"=\" * 30)\n    \n    import subprocess\n    \n    # æµ‹è¯•REST API\n    proxy = os.getenv('https_proxy') or os.getenv('http_proxy')\n    if proxy:\n        cmd = f\"curl -x {proxy} --connect-timeout 10 https://www.deribit.com/api/v2/public/get_time\"\n    else:\n        cmd = \"curl --connect-timeout 10 https://www.deribit.com/api/v2/public/get_time\"\n    \n    try:\n        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=15)\n        if result.returncode == 0:\n            print(f\"âœ… curl REST APIæˆåŠŸ: {result.stdout[:100]}...\")\n        else:\n            print(f\"âŒ curl REST APIå¤±è´¥: {result.stderr}\")\n    except Exception as e:\n        print(f\"âŒ curlæµ‹è¯•å¼‚å¸¸: {e}\")\n\n\nasync def main():\n    \"\"\"ä¸»å‡½æ•°\"\"\"\n    print(\"ðŸš€ Deribit WebSocket è¿žæŽ¥è°ƒè¯•\")\n    print(\"=\" * 60)\n    \n    # æ£€æŸ¥çŽ¯å¢ƒå˜é‡\n    print(f\"ðŸ”§ çŽ¯å¢ƒæ£€æŸ¥:\")\n    print(f\"   http_proxy: {os.getenv('http_proxy')}\")\n    print(f\"   https_proxy: {os.getenv('https_proxy')}\")\n    print(f\"   Pythonç‰ˆæœ¬: {sys.version}\")\n    \n    # æµ‹è¯•curlå¯¹æ¯”\n    await test_curl_comparison()\n    \n    # æµ‹è¯•WebSocketè¿žæŽ¥\n    success = await test_deribit_direct()\n    \n    if success:\n        print(\"\\nðŸŽ‰ Deribit WebSocketè¿žæŽ¥æµ‹è¯•æˆåŠŸï¼\")\n    else:\n        print(\"\\nâŒ Deribit WebSocketè¿žæŽ¥æµ‹è¯•å¤±è´¥\")\n    \n    return success\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n"