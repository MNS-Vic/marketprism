# ç»Ÿä¸€WebSocketæ¶æ„æ–‡æ¡£

## ğŸ¯ **æ¶æ„æ¦‚è¿°**

MarketPrismé¡¹ç›®å·²æˆåŠŸå®ç°ç»Ÿä¸€WebSocketæ¶æ„é‡æ„ï¼Œå®ç°äº†WebSocketè¿æ¥ç®¡ç†å’Œæ•°æ®å¤„ç†çš„èŒè´£åˆ†ç¦»ï¼Œæä¾›äº†æ›´å¥½çš„ä»£ç å¤ç”¨æ€§ã€å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚

## ğŸ—ï¸ **æ¶æ„è®¾è®¡**

### **æ ¸å¿ƒåŸåˆ™**
- **èŒè´£åˆ†ç¦»**ï¼šWebSocketè¿æ¥ç®¡ç† vs æ•°æ®å¤„ç†é€»è¾‘
- **ä»£ç å¤ç”¨**ï¼šç»Ÿä¸€çš„WebSocketè¿æ¥ç®¡ç†å™¨
- **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„äº¤æ˜“æ‰€å’Œæ•°æ®ç±»å‹
- **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰åŠŸèƒ½å®Œå…¨å¯ç”¨

### **æ¶æ„å±‚æ¬¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application Layer)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»Ÿä¸€æ•°æ®æ”¶é›†å™¨ (UnifiedDataCollector)                      â”‚
â”‚  - é…ç½®é©±åŠ¨å¯åŠ¨                                             â”‚
â”‚  - å¤šäº¤æ˜“æ‰€ç®¡ç†                                             â”‚
â”‚  - NATSæ¶ˆæ¯å‘å¸ƒ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å¤„ç†å±‚ (Data Processing Layer)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OrderBook Manager                                          â”‚
â”‚  - è®¢å•ç°¿ç‰¹å®šå¤„ç†é€»è¾‘                                       â”‚
â”‚  - Binanceå®˜æ–¹8æ­¥ç®—æ³•                                       â”‚
â”‚  - å¿«ç…§åŒæ­¥å’ŒéªŒè¯                                           â”‚
â”‚  - æ•°æ®æ ‡å‡†åŒ–                                               â”‚
â”‚                                                             â”‚
â”‚  WebSocket Adapter                                          â”‚
â”‚  - é€‚é…ç°æœ‰OrderBook Manager                                â”‚
â”‚  - ä¿æŒå‘åå…¼å®¹æ€§                                           â”‚
â”‚  - æ¶ˆæ¯è·¯ç”±å’Œå›è°ƒ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç½‘ç»œè¿æ¥å±‚ (Network Connection Layer)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  core/networking/                                           â”‚
â”‚                                                             â”‚
â”‚  WebSocketConnectionManager                                 â”‚
â”‚  - ç»Ÿä¸€WebSocketè¿æ¥ç®¡ç†                                    â”‚
â”‚  - å¤šæ•°æ®ç±»å‹è®¢é˜…å’Œåˆ†å‘                                     â”‚
â”‚  - æ¶ˆæ¯è·¯ç”±æœºåˆ¶                                             â”‚
â”‚  - è¿æ¥çŠ¶æ€ç›‘æ§                                             â”‚
â”‚                                                             â”‚
â”‚  NetworkConnectionManager                                   â”‚
â”‚  - HTTPä¼šè¯ç®¡ç†                                             â”‚
â”‚  - ä»£ç†é…ç½®ç®¡ç†                                             â”‚
â”‚  - SSL/TLSé…ç½®                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ **æ ¸å¿ƒç»„ä»¶**

### **1. ç»Ÿä¸€WebSocketç®¡ç†å™¨ (core/networking/websocket_manager.py)**

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- æ”¯æŒå¤šç§æ•°æ®ç±»å‹è®¢é˜… (orderbook, trade, funding_rate, etc.)
- è‡ªåŠ¨æ¶ˆæ¯è·¯ç”±å’Œåˆ†å‘
- äº¤æ˜“æ‰€ç‰¹å®šçš„æ¶ˆæ¯è§£æ (Binance, OKX)
- è¿æ¥çŠ¶æ€ç›‘æ§å’Œç»Ÿè®¡
- ä»£ç†æ”¯æŒå’ŒSSLé…ç½®

**å…³é”®ç±»**ï¼š
- `WebSocketConnectionManager`: ä¸»è¦ç®¡ç†å™¨
- `DataType`: æ•°æ®ç±»å‹æšä¸¾
- `DataSubscription`: è®¢é˜…é…ç½®
- `WebSocketConfig`: è¿æ¥é…ç½®

### **2. WebSocketé€‚é…å™¨ (services/data-collector/collector/websocket_adapter.py)**

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ä¸ºç°æœ‰OrderBook Manageræä¾›æ–°çš„WebSocketèƒ½åŠ›
- ä¿æŒç°æœ‰æ¥å£ä¸å˜
- æ”¯æŒå¤šäº¤æ˜“æ‰€å’Œå¤šå¸‚åœºç±»å‹
- è‡ªåŠ¨å¤„ç†è®¢é˜…å’Œæ¶ˆæ¯è·¯ç”±

**å…³é”®ç±»**ï¼š
- `WebSocketAdapter`: åŸºç¡€é€‚é…å™¨
- `OrderBookWebSocketAdapter`: OrderBookä¸“ç”¨é€‚é…å™¨

### **3. ç»Ÿä¸€æ•°æ®æ”¶é›†å™¨ (services/data-collector/unified_collector_main.py)**

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- é…ç½®é©±åŠ¨çš„å¯åŠ¨ç³»ç»Ÿ
- å¤šäº¤æ˜“æ‰€æ•°æ®æ”¶é›†
- NATSæ¶ˆæ¯å‘å¸ƒ
- ç›‘æ§å’Œå¥åº·æ£€æŸ¥

## ğŸ“Š **æ”¯æŒçš„äº¤æ˜“æ‰€å’Œå¸‚åœºç±»å‹**

### **äº¤æ˜“æ‰€æ”¯æŒ**
- **Binance**: ç°è´§ (spot) + æ°¸ç»­åˆçº¦ (swap)
- **OKX**: ç°è´§ (spot) + æ°¸ç»­åˆçº¦ (swap)

### **æ•°æ®ç±»å‹æ”¯æŒ**
- `orderbook`: è®¢å•ç°¿æ•°æ®
- `trade`: äº¤æ˜“æ•°æ®
- `funding_rate`: èµ„é‡‘è´¹ç‡ (æ°¸ç»­åˆçº¦)
- `open_interest`: æŒä»“é‡ (æ°¸ç»­åˆçº¦)
- `liquidation`: å¼ºå¹³æ•°æ® (æ°¸ç»­åˆçº¦)
- `ticker`: è¡Œæƒ…æ•°æ®


## ğŸš€ **ä½¿ç”¨æ–¹å¼**

### **1. é…ç½®é©±åŠ¨å¯åŠ¨**

```yaml
# config/collector/unified_data_collection.yaml
system:
  use_unified_websocket: true

exchanges:
  binance_spot:
    exchange: "binance"
    market_type: "spot"
    symbols: ["BTCUSDT", "ETHUSDT"]
    data_types: ["orderbook", "trade"]
  
  binance_swap:
    exchange: "binance"
    market_type: "swap"
    symbols: ["BTCUSDT", "ETHUSDT"]
    data_types: ["orderbook", "trade", "funding_rate"]
```

### **2. ç¨‹åºå¯åŠ¨**

```bash
# ç›´æ¥å¯åŠ¨
python services/data-collector/unified_collector_main.py

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
COLLECTOR_CONFIG_PATH=/path/to/config.yaml python services/data-collector/unified_collector_main.py
```

### **3. ä»£ç é›†æˆ**

```python
from collector.websocket_adapter import OrderBookWebSocketAdapter
from collector.data_types import Exchange, MarketType

# åˆ›å»ºé€‚é…å™¨
adapter = OrderBookWebSocketAdapter(
    exchange=Exchange.BINANCE,
    market_type=MarketType.SPOT,
    symbols=["BTCUSDT"],
    orderbook_manager=your_manager
)

# å»ºç«‹è¿æ¥
await adapter.connect()
```

## ğŸ”„ **è¿ç§»æŒ‡å—**

### **ä»æ—§æ¶æ„è¿ç§»**

1. **å¯ç”¨ç»Ÿä¸€WebSocket**ï¼š
   ```python
   config.use_unified_websocket = True
   ```

2. **ç§»é™¤æ—§çš„WebSocketå®¢æˆ·ç«¯**ï¼š
   - ä¸å†éœ€è¦ `BinanceWebSocketClient`
   - ä¸å†éœ€è¦ `OKXWebSocketClient`
   - ä¸å†éœ€è¦ `BinanceWebSocketManager`
   - ä¸å†éœ€è¦ `OKXWebSocketManager`

3. **ä½¿ç”¨æ–°çš„é€‚é…å™¨**ï¼š
   ```python
   # æ—§æ–¹å¼
   client = BinanceWebSocketClient(symbols, callback)
   
   # æ–°æ–¹å¼
   adapter = OrderBookWebSocketAdapter(exchange, market_type, symbols, manager)
   ```

## ğŸ“ˆ **æ€§èƒ½ä¼˜åŠ¿**

### **è¿æ¥æ•ˆç‡**
- **å‡å°‘è¿æ¥æ•°é‡**: ä¸€ä¸ªWebSocketè¿æ¥æ”¯æŒå¤šç§æ•°æ®ç±»å‹
- **ç»Ÿä¸€è¿æ¥ç®¡ç†**: é¿å…é‡å¤çš„è¿æ¥é€»è¾‘
- **æ™ºèƒ½é‡è¿**: ç»Ÿä¸€çš„é‡è¿å’Œé”™è¯¯å¤„ç†æœºåˆ¶

### **ä»£ç è´¨é‡**
- **æ¶ˆé™¤é‡å¤ä»£ç **: ç§»é™¤äº†å¤šä¸ªé‡å¤çš„WebSocketå®ç°
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰äº¤æ˜“æ‰€ä½¿ç”¨ç›¸åŒçš„æ¥å£
- **æ˜“äºæµ‹è¯•**: æ¸…æ™°çš„èŒè´£åˆ†ç¦»ä¾¿äºå•å…ƒæµ‹è¯•

### **å¯ç»´æŠ¤æ€§**
- **é›†ä¸­ç®¡ç†**: WebSocketé€»è¾‘é›†ä¸­åœ¨coreå±‚
- **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°äº¤æ˜“æ‰€åªéœ€å®ç°æ¶ˆæ¯è§£æ
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶æ‰€æœ‰è¡Œä¸º

## ğŸ§ª **æµ‹è¯•å’ŒéªŒè¯**

### **å•å…ƒæµ‹è¯•**
- `tests/unit/core/networking/test_websocket_manager.py`
- `tests/unit/core/networking/test_websocket_manager_tdd.py`

### **é›†æˆæµ‹è¯•**
- å¤šäº¤æ˜“æ‰€è¿æ¥æµ‹è¯•
- æ•°æ®ç±»å‹è®¢é˜…æµ‹è¯•
- æ¶ˆæ¯è·¯ç”±éªŒè¯æµ‹è¯•

### **æ€§èƒ½æµ‹è¯•**
- è¿æ¥æ•°é‡å¯¹æ¯”
- å†…å­˜ä½¿ç”¨å¯¹æ¯”
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿæµ‹è¯•

## ğŸ”§ **é…ç½®å‚è€ƒ**

### **WebSocketé…ç½®**
```yaml
networking:
  websocket:
    timeout: 30
    max_retries: 3
    ping_interval: 20
    ping_timeout: 60
```

### **äº¤æ˜“æ‰€é…ç½®**
```yaml
exchanges:
  binance_spot:
    api:
      ws_url: "wss://stream.binance.com:9443"
    symbols: ["BTCUSDT", "ETHUSDT"]
    data_types: ["orderbook", "trade"]
```

## ğŸš¨ **æ³¨æ„äº‹é¡¹**

### **å…¼å®¹æ€§**
- ç°æœ‰çš„OrderBook ManageråŠŸèƒ½å®Œå…¨ä¿ç•™
- å¯ä»¥é€‰æ‹©æ€§å¯ç”¨æ–°æ¶æ„ (`use_unified_websocket=True`)
- æ—§çš„WebSocketå®¢æˆ·ç«¯å·²è¢«ç§»é™¤

### **é…ç½®è¦æ±‚**
- éœ€è¦æ­£ç¡®é…ç½®äº¤æ˜“æ‰€APIç«¯ç‚¹
- ç¡®ä¿NATSæœåŠ¡å¯ç”¨
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»£ç†è®¾ç½®

### **ç›‘æ§å»ºè®®**
- ç›‘æ§WebSocketè¿æ¥çŠ¶æ€
- è·Ÿè¸ªæ¶ˆæ¯è·¯ç”±ç»Ÿè®¡
- å…³æ³¨é”™è¯¯ç‡å’Œé‡è¿é¢‘ç‡

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [é…ç½®ç®¡ç†æ–‡æ¡£](../configuration/config_management.md)
- [NATSé›†æˆæ–‡æ¡£](../messaging/nats_integration.md)
- [ç›‘æ§å’Œå‘Šè­¦æ–‡æ¡£](../monitoring/monitoring_setup.md)
- [éƒ¨ç½²æŒ‡å—](../deployment/deployment_guide.md)

## ğŸ‰ **æ€»ç»“**

ç»Ÿä¸€WebSocketæ¶æ„é‡æ„æˆåŠŸå®ç°äº†ï¼š

âœ… **èŒè´£æ¸…æ™°åˆ†ç¦»**: WebSocketè¿æ¥ vs æ•°æ®å¤„ç†  
âœ… **ä»£ç å¤ç”¨æ€§**: ç»Ÿä¸€çš„è¿æ¥ç®¡ç†å™¨  
âœ… **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°äº¤æ˜“æ‰€å’Œæ•°æ®ç±»å‹  
âœ… **å‘åå…¼å®¹æ€§**: ç°æœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™  
âœ… **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘è¿æ¥æ•°é‡å’Œé‡å¤ä»£ç   
âœ… **é…ç½®é©±åŠ¨**: å®Œå…¨åŸºäºé…ç½®æ–‡ä»¶çš„å¯åŠ¨ç³»ç»Ÿ  

è¿™ä¸ªæ¶æ„ä¸ºMarketPrismé¡¹ç›®æä¾›äº†åšå®çš„åŸºç¡€ï¼Œæ”¯æŒæœªæ¥çš„æ‰©å±•å’Œä¼˜åŒ–éœ€æ±‚ã€‚
