# MarketPrism 智能监控告警系统部署检查清单

## 部署前检查清单

### 1. 环境准备 ✅

#### 1.1 硬件资源检查
- [ ] **CPU**: 最低2核，推荐4核以上
- [ ] **内存**: 最低4GB，推荐8GB以上  
- [ ] **磁盘**: 最低20GB可用空间，推荐SSD
- [ ] **网络**: 稳定的网络连接，支持HTTP/HTTPS

#### 1.2 软件环境检查
- [ ] **操作系统**: Linux (Ubuntu 20.04+, CentOS 8+)
- [ ] **Docker**: 20.10+ (Docker部署)
- [ ] **Kubernetes**: 1.20+ (K8s部署)
- [ ] **Python**: 3.12+ (直接部署)

#### 1.3 依赖服务检查
- [ ] **Redis**: 7.0+ 可用
- [ ] **ClickHouse**: 最新版本可用
- [ ] **Prometheus**: 可选，用于指标收集
- [ ] **Grafana**: 可选，用于可视化

### 2. 配置文件准备 ✅

#### 2.1 环境变量配置
- [ ] 复制 `.env.example` 为 `.env`
- [ ] 配置数据库连接信息
  - [ ] `REDIS_PASSWORD`: Redis密码
  - [ ] `CLICKHOUSE_USER`: ClickHouse用户名
  - [ ] `CLICKHOUSE_PASSWORD`: ClickHouse密码
- [ ] 配置通知渠道
  - [ ] `SMTP_USERNAME`: 邮件用户名
  - [ ] `SMTP_PASSWORD`: 邮件密码
  - [ ] `SLACK_WEBHOOK_URL`: Slack Webhook URL
- [ ] 配置安全参数
  - [ ] `JWT_SECRET`: JWT密钥（至少32字符）
  - [ ] `API_KEY`: API访问密钥

#### 2.2 服务配置文件
- [ ] 检查 `monitoring-alerting-config.yaml` 配置
- [ ] 验证告警规则配置
- [ ] 确认通知渠道配置
- [ ] 检查性能参数设置

#### 2.3 SSL/TLS证书（生产环境）
- [ ] 准备SSL证书文件
- [ ] 配置证书路径
- [ ] 验证证书有效性

### 3. 网络和安全配置 ✅

#### 3.1 防火墙配置
- [ ] 开放必要端口
  - [ ] 8082: 监控告警服务
  - [ ] 6379: Redis (内部)
  - [ ] 8123: ClickHouse HTTP (内部)
  - [ ] 9000: ClickHouse TCP (内部)
  - [ ] 9090: Prometheus (可选)
  - [ ] 3000: Grafana (可选)

#### 3.2 网络安全
- [ ] 配置网络策略（Kubernetes）
- [ ] 设置访问控制列表
- [ ] 启用网络加密

#### 3.3 访问控制
- [ ] 配置API认证
- [ ] 设置用户权限
- [ ] 启用审计日志

### 4. 数据存储准备 ✅

#### 4.1 数据卷配置
- [ ] 创建持久化存储卷
- [ ] 配置数据备份策略
- [ ] 设置数据保留策略

#### 4.2 数据库初始化
- [ ] 创建数据库和表结构
- [ ] 配置数据库用户权限
- [ ] 测试数据库连接

### 5. 监控和日志配置 ✅

#### 5.1 日志配置
- [ ] 配置日志级别
- [ ] 设置日志轮转
- [ ] 配置日志收集

#### 5.2 监控配置
- [ ] 配置Prometheus抓取
- [ ] 设置Grafana仪表板
- [ ] 配置告警规则

---

## 部署执行检查清单

### 1. 部署前验证 ✅

#### 1.1 配置验证
```bash
# 验证配置文件
./scripts/validate-config.sh

# 检查环境变量
./scripts/check-environment.sh
```

#### 1.2 依赖检查
```bash
# 检查Docker环境
docker --version
docker-compose --version

# 检查Kubernetes环境
kubectl version --client
kubectl cluster-info
```

### 2. 部署执行 ✅

#### 2.1 Docker Compose部署
```bash
# 执行部署
./scripts/deploy.sh docker-compose production latest

# 验证部署状态
docker-compose ps
docker-compose logs monitoring-alerting
```

#### 2.2 Kubernetes部署
```bash
# 执行部署
./scripts/deploy.sh kubernetes production latest

# 验证部署状态
kubectl get pods -n marketprism-monitoring
kubectl get services -n marketprism-monitoring
```

### 3. 部署后验证 ✅

#### 3.1 服务健康检查
```bash
# 健康检查
curl http://localhost:8082/health

# 就绪检查
curl http://localhost:8082/ready

# API测试
curl http://localhost:8082/api/v1/alerts
```

#### 3.2 功能验证
```bash
# 执行功能测试
./scripts/test-deployment.sh

# 执行性能测试
./scripts/load-test.sh

# 执行安全测试
./scripts/security-test.sh
```

---

## 部署后验证清单

### 1. 基础功能验证 ✅

#### 1.1 服务状态检查
- [ ] 所有容器/Pod正常运行
- [ ] 服务端口正常监听
- [ ] 健康检查端点响应正常
- [ ] 就绪检查端点响应正常

#### 1.2 API功能验证
- [ ] 获取告警列表 API 正常
- [ ] 获取告警规则 API 正常
- [ ] 异常检测 API 正常
- [ ] 故障预测 API 正常
- [ ] 业务指标 API 正常

#### 1.3 数据库连接验证
- [ ] Redis连接正常
- [ ] ClickHouse连接正常
- [ ] 数据读写正常

### 2. 监控和告警验证 ✅

#### 2.1 指标收集验证
- [ ] Prometheus指标正常导出
- [ ] 业务指标正常收集
- [ ] 系统指标正常收集

#### 2.2 告警功能验证
- [ ] 告警规则正常加载
- [ ] 告警创建功能正常
- [ ] 告警通知功能正常
- [ ] 告警聚合功能正常

#### 2.3 通知渠道验证
- [ ] 邮件通知正常发送
- [ ] Slack通知正常发送
- [ ] 钉钉通知正常发送（如配置）

### 3. 性能和安全验证 ✅

#### 3.1 性能验证
- [ ] API响应时间 < 500ms
- [ ] 并发处理能力 > 100 req/s
- [ ] 内存使用率 < 80%
- [ ] CPU使用率 < 70%

#### 3.2 安全验证
- [ ] 未授权访问被正确拒绝
- [ ] 输入验证功能正常
- [ ] 安全头配置正确
- [ ] 敏感信息不泄露

#### 3.3 故障恢复验证
- [ ] 服务重启后正常恢复
- [ ] 数据持久化正常
- [ ] 故障转移功能正常

---

## 生产环境特殊检查

### 1. 高可用配置 ✅

#### 1.1 多实例部署
- [ ] 至少部署2个实例
- [ ] 负载均衡配置正确
- [ ] 故障转移机制正常

#### 1.2 数据备份
- [ ] 自动备份策略配置
- [ ] 备份恢复测试通过
- [ ] 备份存储安全

### 2. 监控和告警 ✅

#### 2.1 系统监控
- [ ] 服务可用性监控
- [ ] 性能指标监控
- [ ] 资源使用监控
- [ ] 错误率监控

#### 2.2 业务监控
- [ ] 告警处理监控
- [ ] 通知发送监控
- [ ] 数据质量监控

### 3. 运维工具 ✅

#### 3.1 日志管理
- [ ] 日志收集正常
- [ ] 日志查询功能
- [ ] 日志告警配置

#### 3.2 维护工具
- [ ] 健康检查脚本
- [ ] 备份恢复脚本
- [ ] 性能监控脚本
- [ ] 故障排除工具

---

## 检查清单使用说明

### 1. 检查流程

1. **部署前**: 按顺序完成所有部署前检查项
2. **部署中**: 执行部署脚本并监控部署过程
3. **部署后**: 完成所有验证检查项
4. **生产环境**: 额外完成生产环境特殊检查

### 2. 检查记录

建议为每次部署创建检查记录：

```
部署信息:
- 部署时间: ___________
- 部署环境: ___________
- 部署版本: ___________
- 部署人员: ___________

检查结果:
- 部署前检查: [ ] 通过 [ ] 失败
- 部署执行: [ ] 成功 [ ] 失败  
- 部署后验证: [ ] 通过 [ ] 失败
- 生产环境检查: [ ] 通过 [ ] 失败

问题记录:
- 问题描述: ___________
- 解决方案: ___________
- 负责人员: ___________
```

### 3. 故障处理

如果检查项失败：

1. **记录问题**: 详细记录失败的检查项和错误信息
2. **分析原因**: 查看日志和错误信息，分析根本原因
3. **制定方案**: 制定解决方案和回滚计划
4. **执行修复**: 执行修复措施
5. **重新验证**: 重新执行相关检查项
6. **文档更新**: 更新部署文档和检查清单

### 4. 持续改进

- 定期回顾检查清单的有效性
- 根据实际部署经验更新检查项
- 收集团队反馈并持续优化
- 自动化更多的检查项目
