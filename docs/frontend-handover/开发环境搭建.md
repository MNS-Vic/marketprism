# MarketPrism 开发环境搭建指南

## 📋 概述
本文档指导前端团队搭建MarketPrism项目的开发环境，包含后端API服务、数据库、第三方服务等完整开发环境。

## 🛠️ 系统要求

### 硬件要求
- **CPU**: 4核心以上 (推荐8核心)
- **内存**: 8GB以上 (推荐16GB)
- **存储**: 50GB可用空间 (SSD推荐)
- **网络**: 稳定的互联网连接

### 软件要求
- **操作系统**: macOS 10.15+, Ubuntu 18.04+, Windows 10+
- **Python**: 3.11.0+ (项目标准)
- **Node.js**: 16.0+ (前端开发)
- **Git**: 2.0+
- **Docker**: 20.0+ (可选，用于容器化部署)

## 🐍 Python后端环境搭建

### 1. 克隆项目
```bash
# 克隆MarketPrism项目
git clone https://github.com/your-org/marketprism.git
cd marketprism

# 检查Python版本
python --version
# 输出应为: Python 3.11.x
```

### 2. 创建虚拟环境
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 确认虚拟环境已激活
which python
```

### 3. 安装Python依赖
```bash
# 安装项目依赖
pip install -r requirements.txt

# 验证关键依赖安装
pip list | grep -E "(fastapi|uvicorn|aiohttp|pydantic)"
```

### 4. 环境配置
```bash
# 复制环境配置模板
cp config/app_config.example.yaml config/app_config.yaml
cp config/services.example.yaml config/services.yaml

# 编辑配置文件（根据实际情况调整）
nano config/app_config.yaml
```

## 🗄️ 数据库环境

### 1. ClickHouse安装（可选，用于完整功能测试）
```bash
# macOS (使用Homebrew)
brew install clickhouse

# Ubuntu
sudo apt-get install -y apt-transport-https ca-certificates dirmngr
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754
echo "deb https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
sudo apt-get update
sudo apt-get install -y clickhouse-server clickhouse-client

# 启动ClickHouse
sudo systemctl start clickhouse-server
```

### 2. Redis安装（可选，用于缓存）
```bash
# macOS
brew install redis
brew services start redis

# Ubuntu
sudo apt update
sudo apt install redis-server
sudo systemctl start redis-server

# 验证Redis连接
redis-cli ping
# 输出: PONG
```

### 3. NATS安装（可选，用于消息队列）
```bash
# 下载NATS Server
wget https://github.com/nats-io/nats-server/releases/download/v2.9.21/nats-server-v2.9.21-linux-amd64.zip
unzip nats-server-v2.9.21-linux-amd64.zip
sudo mv nats-server-v2.9.21-linux-amd64/nats-server /usr/local/bin/

# 启动NATS Server
nats-server --jetstream
```

## 🚀 服务启动

### 1. 快速启动脚本
```bash
# 给脚本执行权限
chmod +x scripts/start-*.sh

# 启动核心服务
./scripts/start-monitoring-dashboard.sh    # 端口8086
./scripts/start-api-gateway.sh            # 端口8080
./scripts/start-data-collector.sh         # 端口8081
```

### 2. 手动启动服务
```bash
# 启动监控仪表板 (前端开发主要对接)
cd services/monitoring-dashboard
python main.py

# 启动API网关
cd services/api-gateway-service
python main.py

# 启动数据收集器
cd services/data-collector
python main.py
```

### 3. 验证服务状态
```bash
# 检查服务健康状态
curl http://localhost:8086/health
curl http://localhost:8080/health
curl http://localhost:8081/health

# 访问现代化UI界面
open http://localhost:8086/modern
```

## 🌐 网络代理配置（如需要）

### 1. 设置代理环境变量
```bash
# 如果需要代理访问外部API
export http_proxy=http://127.0.0.1:1087
export https_proxy=http://127.0.0.1:1087
export ALL_PROXY=socks5://127.0.0.1:1080

# 添加到shell配置文件
echo 'export http_proxy=http://127.0.0.1:1087' >> ~/.bashrc
echo 'export https_proxy=http://127.0.0.1:1087' >> ~/.bashrc
```

### 2. 代理配置文件
```yaml
# config/proxy.yaml
proxy:
  development:
    data-collector:
      enabled: true
      http_proxy: "http://127.0.0.1:1087"
      https_proxy: "http://127.0.0.1:1087"
    api-gateway:
      enabled: false
```

## 📦 前端开发环境

### 1. Node.js环境
```bash
# 安装Node.js (使用nvm推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18

# 验证安装
node --version  # v18.x.x
npm --version   # 9.x.x
```

### 2. 创建前端项目
```bash
# 创建React项目 (推荐)
npx create-react-app marketprism-frontend --template typescript
cd marketprism-frontend

# 或创建Vue项目
npm create vue@latest marketprism-frontend
cd marketprism-frontend

# 或创建Next.js项目
npx create-next-app@latest marketprism-frontend --typescript --tailwind --eslint
cd marketprism-frontend
```

### 3. 安装推荐依赖
```bash
# React项目依赖
npm install axios @tanstack/react-query
npm install @radix-ui/react-* tailwindcss
npm install recharts framer-motion
npm install @types/node @types/react @types/react-dom

# Vue项目依赖
npm install axios @tanstack/vue-query
npm install @headlessui/vue @heroicons/vue
npm install chart.js vue-chartjs

# 开发工具
npm install -D @typescript-eslint/eslint-plugin
npm install -D prettier eslint-config-prettier
npm install -D @testing-library/react @testing-library/jest-dom
```

## 🔗 API接口配置

### 1. 环境变量配置
```bash
# 创建.env文件
cat > .env << EOF
REACT_APP_API_BASE_URL=http://localhost:8080
REACT_APP_WS_URL=ws://localhost:8086/ws
REACT_APP_MONITORING_URL=http://localhost:8086
REACT_APP_ENVIRONMENT=development
EOF
```

### 2. API客户端配置
```typescript
// src/api/client.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: process.env.REACT_APP_API_BASE_URL || 'http://localhost:8080',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('authToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    console.error('API Error:', error);
    return Promise.reject(error);
  }
);

export default apiClient;
```

### 3. WebSocket连接配置
```typescript
// src/hooks/useWebSocket.ts
import { useEffect, useState, useRef } from 'react';

interface UseWebSocketProps {
  url: string;
  onMessage?: (data: any) => void;
  onError?: (error: Event) => void;
}

export function useWebSocket({ url, onMessage, onError }: UseWebSocketProps) {
  const [isConnected, setIsConnected] = useState(false);
  const wsRef = useRef<WebSocket | null>(null);

  useEffect(() => {
    const ws = new WebSocket(url);
    wsRef.current = ws;

    ws.onopen = () => setIsConnected(true);
    ws.onclose = () => setIsConnected(false);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      onMessage?.(data);
    };
    ws.onerror = (error) => onError?.(error);

    return () => ws.close();
  }, [url, onMessage, onError]);

  const sendMessage = (message: any) => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify(message));
    }
  };

  return { isConnected, sendMessage };
}
```

## 🧪 开发工具配置

### 1. VS Code配置
```json
// .vscode/settings.json
{
  "python.defaultInterpreterPath": "./venv/bin/python",
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.yaml": "yaml"
  }
}
```

### 2. Git配置
```bash
# 配置Git hooks
cat > .githooks/pre-commit << EOF
#!/bin/sh
# 运行前端代码检查
cd frontend && npm run lint
cd ../backend && python -m pytest tests/
EOF

chmod +x .githooks/pre-commit
git config core.hooksPath .githooks
```

### 3. 调试配置
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: FastAPI",
      "type": "python",
      "request": "launch",
      "program": "${workspaceFolder}/services/monitoring-dashboard/main.py",
      "console": "integratedTerminal",
      "env": {
        "PYTHONPATH": "${workspaceFolder}"
      }
    },
    {
      "name": "Debug React App",
      "type": "node",
      "request": "launch",
      "cwd": "${workspaceFolder}/frontend",
      "runtimeExecutable": "npm",
      "runtimeArgs": ["start"]
    }
  ]
}
```

## 📊 开发环境验证

### 1. 后端服务验证
```bash
# 检查所有服务状态
curl -s http://localhost:8086/health | jq
curl -s http://localhost:8080/health | jq
curl -s http://localhost:8081/health | jq

# 测试API接口
curl -s http://localhost:8086/api/v1/monitoring/overview | jq
curl -s http://localhost:8086/api/v1/monitoring/services | jq
```

### 2. WebSocket连接验证
```javascript
// 浏览器控制台测试
const ws = new WebSocket('ws://localhost:8086/ws');
ws.onopen = () => console.log('Connected');
ws.onmessage = (event) => console.log('Message:', JSON.parse(event.data));
ws.send(JSON.stringify({
  type: 'subscribe',
  channel: 'system'
}));
```

### 3. 前端环境验证
```bash
# 启动前端开发服务器
cd frontend
npm start

# 验证构建
npm run build

# 运行测试
npm test
```

## 🔧 常见问题解决

### 1. Python版本问题
```bash
# 如果Python版本不对
pyenv install 3.11.0
pyenv local 3.11.0

# 或使用conda
conda create -n marketprism python=3.11
conda activate marketprism
```

### 2. 端口冲突
```bash
# 查找占用端口的进程
lsof -i :8086
lsof -i :8080

# 杀死占用进程
kill -9 <PID>

# 或修改配置文件中的端口
```

### 3. 依赖安装失败
```bash
# 清理pip缓存
pip cache purge

# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/

# Node.js依赖问题
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### 4. 网络连接问题
```bash
# 测试网络连接
ping api.binance.com
ping api.okx.com

# 配置代理（如果需要）
export http_proxy=http://your-proxy:port
export https_proxy=http://your-proxy:port
```

## 📞 技术支持

### 联系方式
- **技术负责人**: [姓名] - [邮箱]
- **后端支持**: [姓名] - [邮箱]
- **环境支持**: [姓名] - [邮箱]

### 常用命令快速参考
```bash
# 启动开发环境
source venv/bin/activate
./scripts/start-monitoring-dashboard.sh

# 检查服务状态
curl http://localhost:8086/health

# 查看日志
tail -f services/monitoring-dashboard/logs/app.log

# 重启服务
pkill -f "python.*main.py"
./scripts/start-monitoring-dashboard.sh
```

通过以上配置，前端团队应该能够成功搭建完整的MarketPrism开发环境，开始前端开发工作。