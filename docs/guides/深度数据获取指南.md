# MarketPrism æ·±åº¦æ•°æ®è·å–æŒ‡å—

> å®Œæ•´çš„æ·±åº¦æ•°æ®è·å–æ–¹æ³•å’Œæœ€ä½³å®è·µ

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è·å–æ–¹å¼å¯¹æ¯”](#è·å–æ–¹å¼å¯¹æ¯”)
3. [ç›´æ¥APIè·å–](#ç›´æ¥apiè·å–)
4. [é€šè¿‡OrderBook Managerè·å–](#é€šè¿‡orderbook-managerè·å–)
5. [é€šè¿‡REST APIè·å–](#é€šè¿‡rest-apiè·å–)
6. [é€šè¿‡NATSæ¶ˆæ¯é˜Ÿåˆ—è·å–](#é€šè¿‡natsæ¶ˆæ¯é˜Ÿåˆ—è·å–)
7. [å®æ—¶ç›‘æ§ç¤ºä¾‹](#å®æ—¶ç›‘æ§ç¤ºä¾‹)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ğŸ¯ æ¦‚è¿°

MarketPrismç³»ç»Ÿæä¾›äº†å¤šç§æ–¹å¼æ¥è·å–äº¤æ˜“æ‰€æ·±åº¦æ•°æ®ï¼Œæ”¯æŒï¼š

- **400æ¡£æ·±åº¦**: Binanceå’ŒOKXç»Ÿä¸€ä½¿ç”¨400æ¡£æ·±åº¦
- **å®æ—¶æ›´æ–°**: æ¯«ç§’çº§å»¶è¿Ÿçš„å¢é‡æ›´æ–°
- **å¤šäº¤æ˜“æ‰€**: æ”¯æŒBinanceã€OKXã€Deribitç­‰
- **é«˜å¯é æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

## ğŸ“Š è·å–æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | å»¶è¿Ÿ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ | ä¾èµ– |
|------|------|--------|----------|------|
| **ç›´æ¥API** | ä½ | ç®€å• | å¿«é€Ÿæµ‹è¯•ã€ç®€å•åº”ç”¨ | æ—  |
| **OrderBook Manager** | æä½ | ä¸­ç­‰ | é«˜é¢‘äº¤æ˜“ã€å®æ—¶åº”ç”¨ | Pythonç¯å¢ƒ |
| **REST API** | ä½ | ç®€å• | Webåº”ç”¨ã€ç§»åŠ¨åº”ç”¨ | CollectoræœåŠ¡ |
| **NATSæ¶ˆæ¯é˜Ÿåˆ—** | æä½ | é«˜ | åˆ†å¸ƒå¼ç³»ç»Ÿã€å¾®æœåŠ¡ | NATSæœåŠ¡ |

## ğŸš€ ç›´æ¥APIè·å–

### ç‰¹ç‚¹
- âœ… æœ€ç®€å•çš„æ–¹å¼
- âœ… æ— éœ€å¯åŠ¨ä»»ä½•æœåŠ¡
- âœ… é€‚åˆå¿«é€Ÿæµ‹è¯•å’ŒåŸå‹å¼€å‘
- âŒ éœ€è¦è‡ªå·±å¤„ç†APIé™åˆ¶å’Œé”™è¯¯

### ç¤ºä¾‹ä»£ç 

```python
import asyncio
import aiohttp
from decimal import Decimal

async def get_binance_depth(symbol: str, limit: int = 400):
    """è·å–Binanceæ·±åº¦æ•°æ®"""
    async with aiohttp.ClientSession() as session:
        url = "https://api.binance.com/api/v3/depth"
        params = {"symbol": symbol, "limit": limit}
        
        async with session.get(url, params=params) as response:
            if response.status == 200:
                data = await response.json()
                return {
                    "exchange": "binance",
                    "symbol": symbol,
                    "last_update_id": data["lastUpdateId"],
                    "bids": [(Decimal(p), Decimal(q)) for p, q in data["bids"]],
                    "asks": [(Decimal(p), Decimal(q)) for p, q in data["asks"]],
                    "depth_levels": len(data["bids"]) + len(data["asks"])
                }
    return None

# ä½¿ç”¨ç¤ºä¾‹
depth = await get_binance_depth("BTCUSDT", 400)
print(f"æ·±åº¦æ¡£æ•°: {depth['depth_levels']}")
print(f"æœ€ä½³ä¹°ä»·: {depth['bids'][0][0]}")
print(f"æœ€ä½³å–ä»·: {depth['asks'][0][0]}")
```

### è¿è¡Œç¤ºä¾‹
```bash
python simple_depth_example.py
```

## ğŸ”§ é€šè¿‡OrderBook Managerè·å–

### ç‰¹ç‚¹
- âœ… å®æ—¶ç»´æŠ¤æœ¬åœ°è®¢å•ç°¿
- âœ… è‡ªåŠ¨å¤„ç†å¢é‡æ›´æ–°
- âœ… å®Œå–„çš„åºåˆ—éªŒè¯
- âœ… æ”¯æŒå¤šäº¤æ˜“æ‰€
- âŒ éœ€è¦Pythonç¯å¢ƒå’Œä¾èµ–

### ç¤ºä¾‹ä»£ç 

```python
import asyncio
import sys
import os

# è®¾ç½®ä»£ç†
os.environ['http_proxy'] = 'http://127.0.0.1:1087'
os.environ['https_proxy'] = 'http://127.0.0.1:1087'

sys.path.append('services/python-collector/src')

from marketprism_collector.types import Exchange, MarketType, ExchangeConfig, DataType
from marketprism_collector.normalizer import DataNormalizer
from marketprism_collector.orderbook_manager import OrderBookManager

async def setup_orderbook_manager():
    """è®¾ç½®OrderBook Manager"""
    config = ExchangeConfig(
        exchange=Exchange.BINANCE,
        market_type=MarketType.SPOT,
        base_url="https://api.binance.com",
        ws_url="wss://stream.binance.com:9443/ws",
        data_types=[DataType.ORDERBOOK],
        symbols=["BTCUSDT", "ETHUSDT"],
        depth_limit=400,
        snapshot_interval=300
    )
    
    normalizer = DataNormalizer()
    manager = OrderBookManager(config, normalizer)
    
    # å¯åŠ¨ç®¡ç†å™¨
    await manager.start(["BTCUSDT", "ETHUSDT"])
    
    return manager

async def get_current_depth(manager, symbol: str):
    """è·å–å½“å‰æ·±åº¦"""
    orderbook = manager.get_current_orderbook(symbol)
    if orderbook:
        return {
            "exchange": orderbook.exchange_name,
            "symbol": orderbook.symbol_name,
            "last_update_id": orderbook.last_update_id,
            "bids": [(level.price, level.quantity) for level in orderbook.bids],
            "asks": [(level.price, level.quantity) for level in orderbook.asks],
            "depth_levels": orderbook.depth_levels,
            "timestamp": orderbook.timestamp
        }
    return None

# ä½¿ç”¨ç¤ºä¾‹
manager = await setup_orderbook_manager()
await asyncio.sleep(5)  # ç­‰å¾…åˆå§‹åŒ–

depth = await get_current_depth(manager, "BTCUSDT")
if depth:
    print(f"æ·±åº¦æ¡£æ•°: {depth['depth_levels']}")
    print(f"æœ€ä½³ä¹°ä»·: {depth['bids'][0][0]}")
    print(f"æœ€ä½³å–ä»·: {depth['asks'][0][0]}")

await manager.stop()
```

### è¿è¡Œç¤ºä¾‹
```bash
python example_direct_orderbook.py
```

## ğŸŒ é€šè¿‡REST APIè·å–

### ç‰¹ç‚¹
- âœ… æ ‡å‡†HTTPæ¥å£
- âœ… æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€
- âœ… é€‚åˆWebåº”ç”¨é›†æˆ
- âŒ éœ€è¦CollectoræœåŠ¡è¿è¡Œ

### APIç«¯ç‚¹

```bash
# è·å–æŒ‡å®šäº¤æ˜“æ‰€å’Œäº¤æ˜“å¯¹çš„æ·±åº¦
GET /api/v1/orderbook/{exchange}/{symbol}

# ç¤ºä¾‹
curl http://localhost:8080/api/v1/orderbook/binance/BTCUSDT
curl http://localhost:8080/api/v1/orderbook/okx/BTC-USDT
```

### å“åº”æ ¼å¼

```json
{
  "exchange_name": "binance",
  "symbol_name": "BTCUSDT",
  "last_update_id": 69944761001,
  "bids": [
    {"price": "108817.43", "quantity": "0.01234"},
    {"price": "108817.42", "quantity": "0.05678"}
  ],
  "asks": [
    {"price": "108817.44", "quantity": "0.02345"},
    {"price": "108817.45", "quantity": "0.06789"}
  ],
  "timestamp": "2025-01-27T12:30:00Z",
  "depth_levels": 800,
  "update_type": "snapshot"
}
```

### Pythonå®¢æˆ·ç«¯ç¤ºä¾‹

```python
import aiohttp
import asyncio

async def get_depth_via_api(exchange: str, symbol: str):
    """é€šè¿‡REST APIè·å–æ·±åº¦"""
    url = f"http://localhost:8080/api/v1/orderbook/{exchange}/{symbol}"
    
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            if response.status == 200:
                return await response.json()
    return None

# ä½¿ç”¨ç¤ºä¾‹
depth = await get_depth_via_api("binance", "BTCUSDT")
print(f"æ·±åº¦æ¡£æ•°: {depth['depth_levels']}")
```

### å¯åŠ¨CollectoræœåŠ¡

```bash
# å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose -f docker/docker-compose.infrastructure.yml up -d

# å¯åŠ¨Collector
docker-compose up -d python-collector

# éªŒè¯æœåŠ¡
curl http://localhost:8080/health
```

## ğŸ“¡ é€šè¿‡NATSæ¶ˆæ¯é˜Ÿåˆ—è·å–

### ç‰¹ç‚¹
- âœ… æœ€ä½å»¶è¿Ÿ
- âœ… æ”¯æŒåˆ†å¸ƒå¼è®¢é˜…
- âœ… å¯é çš„æ¶ˆæ¯ä¼ é€’
- âŒ éœ€è¦NATSæœåŠ¡å’Œå¤æ‚é…ç½®

### è®¢é˜…ä¸»é¢˜

```
market.orderbook.*                    # æ‰€æœ‰è®¢å•ç°¿æ•°æ®
market.orderbook.binance.*           # Binanceæ‰€æœ‰äº¤æ˜“å¯¹
market.orderbook.binance.BTCUSDT     # Binance BTCUSDT
market.orderbook.okx.*               # OKXæ‰€æœ‰äº¤æ˜“å¯¹
market.orderbook.okx.BTC-USDT        # OKX BTC-USDT
```

### Pythonè®¢é˜…ç¤ºä¾‹

```python
import asyncio
import json
import nats
from nats.js import JetStreamContext

async def subscribe_depth_updates():
    """è®¢é˜…æ·±åº¦æ›´æ–°"""
    nc = await nats.connect("nats://localhost:4222")
    js = nc.jetstream()
    
    # è®¢é˜…Binance BTCUSDT
    subscription = await js.subscribe(
        "market.orderbook.binance.BTCUSDT",
        durable_name="depth_consumer"
    )
    
    async for msg in subscription.messages:
        data = json.loads(msg.data.decode())
        
        print(f"ğŸ“Š {data['exchange_name']} {data['symbol_name']}")
        print(f"   æ·±åº¦æ¡£æ•°: {data['depth_levels']}")
        print(f"   æœ€ä½³ä¹°ä»·: {data['bids'][0]['price']}")
        print(f"   æœ€ä½³å–ä»·: {data['asks'][0]['price']}")
        
        await msg.ack()

# ä½¿ç”¨ç¤ºä¾‹
await subscribe_depth_updates()
```

### è¿è¡Œç¤ºä¾‹
```bash
python example_nats_depth_consumer.py
```

## ğŸ“ˆ å®æ—¶ç›‘æ§ç¤ºä¾‹

### æ·±åº¦å˜åŒ–ç›‘æ§

```python
async def monitor_depth_changes(client, exchange: str, symbol: str, duration: int = 60):
    """ç›‘æ§æ·±åº¦å˜åŒ–"""
    start_time = asyncio.get_event_loop().time()
    last_update_id = 0
    update_count = 0
    
    while (asyncio.get_event_loop().time() - start_time) < duration:
        depth = await client.get_depth(exchange, symbol)
        
        if depth and depth['last_update_id'] != last_update_id:
            update_count += 1
            last_update_id = depth['last_update_id']
            
            print(f"ğŸ“Š æ›´æ–° #{update_count}")
            print(f"   æ›´æ–°ID: {depth['last_update_id']}")
            print(f"   æœ€ä½³ä¹°ä»·: {depth['bids'][0][0]}")
            print(f"   æœ€ä½³å–ä»·: {depth['asks'][0][0]}")
            
            if depth['bids'] and depth['asks']:
                spread = depth['asks'][0][0] - depth['bids'][0][0]
                print(f"   ä»·å·®: {spread}")
        
        await asyncio.sleep(1)
    
    print(f"âœ… ç›‘æ§å®Œæˆï¼Œå…±æ•è· {update_count} æ¬¡æ›´æ–°")
```

### å¥—åˆ©æœºä¼šç›‘æ§

```python
async def monitor_arbitrage(client):
    """ç›‘æ§å¥—åˆ©æœºä¼š"""
    while True:
        # å¹¶å‘è·å–ä¸¤ä¸ªäº¤æ˜“æ‰€çš„æ•°æ®
        binance_task = client.get_depth("binance", "BTCUSDT")
        okx_task = client.get_depth("okx", "BTC-USDT")
        
        binance_depth, okx_depth = await asyncio.gather(binance_task, okx_task)
        
        if binance_depth and okx_depth:
            binance_ask = binance_depth['asks'][0][0]
            okx_bid = okx_depth['bids'][0][0]
            
            if binance_ask < okx_bid:
                arbitrage = okx_bid - binance_ask
                if arbitrage > 10:  # å¥—åˆ©ç©ºé—´å¤§äº10 USDT
                    print(f"ğŸš€ å¥—åˆ©æœºä¼š: {arbitrage} USDT")
                    print(f"   Binanceä¹°å…¥: {binance_ask}")
                    print(f"   OKXå–å‡º: {okx_bid}")
        
        await asyncio.sleep(5)
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„è·å–æ–¹å¼

```python
# å¿«é€Ÿæµ‹è¯•å’ŒåŸå‹ â†’ ç›´æ¥API
depth = await get_binance_depth("BTCUSDT")

# é«˜é¢‘äº¤æ˜“åº”ç”¨ â†’ OrderBook Manager
manager = await setup_orderbook_manager()
depth = manager.get_current_orderbook("BTCUSDT")

# Webåº”ç”¨é›†æˆ â†’ REST API
depth = await get_depth_via_api("binance", "BTCUSDT")

# åˆ†å¸ƒå¼ç³»ç»Ÿ â†’ NATSæ¶ˆæ¯é˜Ÿåˆ—
await subscribe_depth_updates()
```

### 2. é”™è¯¯å¤„ç†

```python
async def robust_get_depth(exchange: str, symbol: str, max_retries: int = 3):
    """å¥å£®çš„æ·±åº¦è·å–"""
    for attempt in range(max_retries):
        try:
            depth = await get_depth(exchange, symbol)
            if depth:
                return depth
        except Exception as e:
            print(f"å°è¯• {attempt + 1} å¤±è´¥: {e}")
            if attempt < max_retries - 1:
                await asyncio.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
    
    return None
```

### 3. é¢‘ç‡é™åˆ¶

```python
import time
from collections import defaultdict

class RateLimiter:
    def __init__(self, max_requests: int = 10, window: int = 60):
        self.max_requests = max_requests
        self.window = window
        self.requests = defaultdict(list)
    
    async def acquire(self, key: str):
        now = time.time()
        # æ¸…ç†è¿‡æœŸè¯·æ±‚
        self.requests[key] = [
            req_time for req_time in self.requests[key]
            if now - req_time < self.window
        ]
        
        if len(self.requests[key]) >= self.max_requests:
            wait_time = self.window - (now - self.requests[key][0])
            await asyncio.sleep(wait_time)
        
        self.requests[key].append(now)

# ä½¿ç”¨ç¤ºä¾‹
limiter = RateLimiter(max_requests=5, window=60)

async def get_depth_with_limit(exchange: str, symbol: str):
    await limiter.acquire(f"{exchange}_{symbol}")
    return await get_depth(exchange, symbol)
```

### 4. æ•°æ®éªŒè¯

```python
def validate_depth_data(depth: dict) -> bool:
    """éªŒè¯æ·±åº¦æ•°æ®å®Œæ•´æ€§"""
    required_fields = ['bids', 'asks', 'last_update_id', 'timestamp']
    
    # æ£€æŸ¥å¿…éœ€å­—æ®µ
    if not all(field in depth for field in required_fields):
        return False
    
    # æ£€æŸ¥ä¹°å–ç›˜æ•°æ®
    if not depth['bids'] or not depth['asks']:
        return False
    
    # æ£€æŸ¥ä»·æ ¼æ’åº
    bid_prices = [float(bid[0]) for bid in depth['bids']]
    ask_prices = [float(ask[0]) for ask in depth['asks']]
    
    if bid_prices != sorted(bid_prices, reverse=True):
        return False  # ä¹°ç›˜åº”è¯¥ä»é«˜åˆ°ä½
    
    if ask_prices != sorted(ask_prices):
        return False  # å–ç›˜åº”è¯¥ä»ä½åˆ°é«˜
    
    # æ£€æŸ¥ä»·å·®åˆç†æ€§
    best_bid = float(depth['bids'][0][0])
    best_ask = float(depth['asks'][0][0])
    
    if best_bid >= best_ask:
        return False  # ä¹°ä»·ä¸åº”è¯¥é«˜äºå–ä»·
    
    return True
```

### 5. æ€§èƒ½ä¼˜åŒ–

```python
import asyncio
from asyncio import Semaphore

class DepthDataPool:
    """æ·±åº¦æ•°æ®è¿æ¥æ± """
    
    def __init__(self, max_connections: int = 10):
        self.semaphore = Semaphore(max_connections)
        self.session = None
    
    async def __aenter__(self):
        await self.semaphore.acquire()
        if not self.session:
            self.session = aiohttp.ClientSession()
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        self.semaphore.release()
    
    async def get_depth(self, exchange: str, symbol: str):
        # å¤ç”¨è¿æ¥è·å–æ·±åº¦æ•°æ®
        pass

# ä½¿ç”¨ç¤ºä¾‹
pool = DepthDataPool(max_connections=5)

async def batch_get_depths(symbols: list):
    """æ‰¹é‡è·å–æ·±åº¦æ•°æ®"""
    tasks = []
    for symbol in symbols:
        async with pool as client:
            task = client.get_depth("binance", symbol)
            tasks.append(task)
    
    return await asyncio.gather(*tasks)
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ä»£ç†è®¾ç½®
   export http_proxy=http://127.0.0.1:1087
   export https_proxy=http://127.0.0.1:1087
   ```

2. **APIé™åˆ¶**
   ```python
   # ä½¿ç”¨é¢‘ç‡é™åˆ¶å™¨
   await limiter.acquire("binance_BTCUSDT")
   ```

3. **æ•°æ®ä¸ä¸€è‡´**
   ```python
   # éªŒè¯æ•°æ®å®Œæ•´æ€§
   if not validate_depth_data(depth):
       print("æ•°æ®éªŒè¯å¤±è´¥")
   ```

4. **æœåŠ¡æœªå¯åŠ¨**
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   curl http://localhost:8080/health
   docker-compose ps
   ```

### è°ƒè¯•æŠ€å·§

```python
import logging

# å¯ç”¨è¯¦ç»†æ—¥å¿—
logging.basicConfig(level=logging.DEBUG)

# æ·»åŠ æ€§èƒ½ç›‘æ§
import time

async def timed_get_depth(exchange: str, symbol: str):
    start_time = time.time()
    depth = await get_depth(exchange, symbol)
    elapsed = time.time() - start_time
    print(f"è·å–æ·±åº¦è€—æ—¶: {elapsed:.3f}s")
    return depth
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [OrderBook Manager è¯¦ç»†æ–‡æ¡£](services/python-collector/README.md)
- [REST API æ–‡æ¡£](docs/api/rest-api.md)
- [NATS é…ç½®æŒ‡å—](docs/deployment/nats-setup.md)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](docs/operations/performance-tuning.md)

---

**ğŸ’¡ æç¤º**: é€‰æ‹©æœ€é€‚åˆæ‚¨åº”ç”¨åœºæ™¯çš„è·å–æ–¹å¼ï¼Œå¹¶éµå¾ªæœ€ä½³å®è·µä»¥ç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚