# MarketPrism 架构优化建议

## 🚨 紧急问题

### 1. 数据标准化重复 (严重)
**问题**: 3个DataNormalizer实现，代码重复率70%
- `services/data_normalizer/normalizer.py` (754行)
- `services/python-collector/src/marketprism_collector/normalizer.py` (167行)  
- `services/data_normalizer/internal/normalizer/data_normalizer.py` (159行)

**解决方案**: 保留python-collector实现，删除其他两个

### 2. 数据模型重复 (中等)
**问题**: 2套数据模型定义，类型不兼容
- `src/marketprism/models/market_data.py` (dataclass)
- `services/python-collector/src/marketprism_collector/types.py` (Pydantic)

**解决方案**: 统一使用Pydantic模型

## 🗑️ 未使用模块

### 需要删除
- `src/marketprism/` - 早期设计，已被替代
- `services/data_normalizer/` - 功能重复

### 需要确认状态
- `services/data_archiver/` - 部分使用，需确认
- `services/ingestion/` - 使用状态不明

## 📋 立即行动清单

### 第1步: 确认服务状态 (1天)
```bash
# 检查哪些服务在运行
docker-compose ps
ps aux | grep python

# 检查日志
ls -la logs/
```

### 第2步: 删除重复模块 (2-3天)
1. 备份重要代码
2. 删除`services/data_normalizer/`
3. 删除`src/marketprism/`
4. 更新所有导入引用

### 第3步: 统一数据模型 (2-3天)
1. 迁移到Pydantic模型
2. 更新测试文件
3. 验证功能正常

## 🎯 预期效果

- **代码减少**: 30-40%重复代码清理
- **维护简化**: 单一数据标准化实现
- **性能提升**: 减少内存使用和启动时间
- **开发效率**: 明确的模块职责

## ⚠️ 风险控制

1. **备份重要代码**: 删除前确保备份
2. **分步执行**: 逐个模块清理，避免大规模破坏
3. **测试验证**: 每步完成后运行测试
4. **回滚准备**: 保留Git历史，便于回滚

## 📞 需要决策的问题

1. **data_archiver服务**: 是否继续使用？
2. **ingestion服务**: 与python-collector的关系？
3. **配置管理**: 是否需要统一重构？

---

**建议优先级**: 数据标准化重复 > 未使用模块清理 > 数据模型统一 > 配置重构 