# MarketPrism 配置管理规范

## 📋 配置管理统一规范

**制定时间**: 2025-05-24  
**适用范围**: 所有MarketPrism服务和组件  
**强制执行**: ✅ 必须遵循  

## 🎯 统一命名规范

### 环境变量前缀标准

所有MarketPrism相关环境变量必须使用 `MP_` 前缀：

```bash
# ✅ 正确格式
MP_ENVIRONMENT=production
MP_NATS_URL=nats://localhost:4222
MP_CLICKHOUSE_HOST=localhost

# ❌ 错误格式
ENVIRONMENT=production
NATS_URL=nats://localhost:4222
CLICKHOUSE_HOST=localhost
```

### 命名层次结构

```
MP_<服务/组件>_<功能>_<具体配置>
```

**示例**:
- `MP_COLLECTOR_HTTP_PORT` - 收集器HTTP端口
- `MP_BINANCE_API_KEY` - Binance API密钥
- `MP_CLICKHOUSE_DATABASE` - ClickHouse数据库名

## 📁 配置文件组织

### 统一配置目录结构

```
config/
├── environments/           # 环境配置
│   ├── .env.development   # 开发环境
│   ├── .env.production    # 生产环境
│   └── .env.testing       # 测试环境
├── exchanges/             # 交易所配置
│   ├── binance.yaml
│   ├── okx.yaml
│   └── deribit.yaml
├── services/              # 服务配置
│   ├── python-collector.yaml
│   ├── reliability.yaml
│   └── data-archiver.yaml
└── infrastructure/        # 基础设施配置
    ├── nats.yaml
    ├── clickhouse.yaml
    └── monitoring.yaml
```

## 🔧 标准环境变量定义

### 核心系统配置

```bash
# 系统环境
MP_ENVIRONMENT=development|production|testing
MP_DEBUG=true|false
MP_LOG_LEVEL=DEBUG|INFO|WARN|ERROR

# 服务端口
MP_API_PORT=8080
MP_METRICS_PORT=9090
MP_HEALTH_PORT=8081
```

### 基础设施配置

```bash
# NATS消息队列
MP_NATS_URL=nats://localhost:4222
MP_NATS_CLUSTER_ID=marketprism
MP_NATS_CLIENT_ID=mp-collector

# ClickHouse数据库
MP_CLICKHOUSE_HOST=localhost
MP_CLICKHOUSE_PORT=9000
MP_CLICKHOUSE_DATABASE=marketprism
MP_CLICKHOUSE_USER=default
MP_CLICKHOUSE_PASSWORD=

# 监控系统
MP_PROMETHEUS_ENABLED=true
MP_GRAFANA_ENABLED=true
```

### 交易所API配置

```bash
# Binance
MP_BINANCE_API_KEY=your_api_key
MP_BINANCE_SECRET=your_secret
MP_BINANCE_TESTNET=false

# OKX
MP_OKX_API_KEY=your_api_key
MP_OKX_SECRET=your_secret
MP_OKX_PASSPHRASE=your_passphrase
MP_OKX_SANDBOX=false

# Deribit
MP_DERIBIT_API_KEY=your_api_key
MP_DERIBIT_SECRET=your_secret
MP_DERIBIT_TESTNET=false
```

### 网络和代理配置

```bash
# 代理设置
MP_HTTP_PROXY=http://127.0.0.1:7890
MP_HTTPS_PROXY=http://127.0.0.1:7890
MP_ALL_PROXY=socks5://127.0.0.1:7890
MP_NO_PROXY=localhost,127.0.0.1

# 镜像加速
MP_GOPROXY=https://goproxy.io,direct
MP_PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple
```

## 🔄 配置迁移计划

### 第一阶段：环境变量重命名

**目标**: 统一所有环境变量为MP_前缀

**迁移映射表**:
| 旧变量名 | 新变量名 | 状态 |
|---------|----------|------|
| `ENVIRONMENT` | `MP_ENVIRONMENT` | 🔄 待迁移 |
| `API_PORT` | `MP_API_PORT` | 🔄 待迁移 |
| `NATS_URL` | `MP_NATS_URL` | 🔄 待迁移 |
| `CLICKHOUSE_HOST` | `MP_CLICKHOUSE_HOST` | 🔄 待迁移 |
| `DEV_MODE` | `MP_ENVIRONMENT` | 🔄 待迁移 |

### 第二阶段：配置文件整合

**目标**: 合并重复配置，建立统一配置体系

**整合计划**:
1. **合并环境配置**: `.env.development` + `.env.production` → `config/environments/`
2. **统一交易所配置**: 分散的API配置 → `config/exchanges/`
3. **服务配置标准化**: 各服务配置 → `config/services/`

### 第三阶段：配置验证

**目标**: 建立配置验证和管理机制

**实施内容**:
- 配置验证脚本
- 配置模板生成
- 环境配置检查
- 配置热重载支持

## 🛠️ 配置管理工具

### 配置验证脚本

```bash
#!/bin/bash
# scripts/validate-config.sh

echo "=== MarketPrism 配置验证 ==="

# 检查必需的环境变量
required_vars=(
    "MP_ENVIRONMENT"
    "MP_NATS_URL"
    "MP_CLICKHOUSE_HOST"
    "MP_API_PORT"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "❌ 缺少必需环境变量: $var"
        exit 1
    else
        echo "✅ $var = ${!var}"
    fi
done

echo "✅ 配置验证通过"
```

### 配置生成脚本

```bash
#!/bin/bash
# scripts/generate-config.sh

echo "=== MarketPrism 配置生成 ==="

# 生成开发环境配置
cat > config/environments/.env.development << EOF
# MarketPrism 开发环境配置
MP_ENVIRONMENT=development
MP_DEBUG=true
MP_LOG_LEVEL=DEBUG
MP_API_PORT=8080
MP_NATS_URL=nats://localhost:4222
MP_CLICKHOUSE_HOST=localhost
MP_CLICKHOUSE_PORT=9000
EOF

echo "✅ 开发环境配置已生成"
```

## 📊 配置管理最佳实践

### 1. 安全性原则

- **敏感信息**: API密钥、密码等不得提交到版本控制
- **环境隔离**: 开发/测试/生产环境配置严格分离
- **权限控制**: 生产环境配置仅授权人员可访问

### 2. 可维护性原则

- **统一命名**: 所有配置遵循统一命名规范
- **文档同步**: 配置变更必须同步更新文档
- **版本管理**: 配置变更记录和版本追踪

### 3. 可扩展性原则

- **模块化配置**: 按功能模块组织配置文件
- **环境适配**: 支持多环境配置切换
- **动态配置**: 支持运行时配置更新

## 🔍 配置审计检查

### 定期检查项目

- [ ] 所有环境变量是否使用MP_前缀
- [ ] 配置文件是否按规范组织
- [ ] 敏感信息是否正确保护
- [ ] 配置文档是否及时更新
- [ ] 配置验证脚本是否正常工作

### 配置健康度评分

| 检查项目 | 权重 | 当前状态 | 目标状态 |
|---------|------|----------|----------|
| 命名规范 | 30% | 40% | 100% |
| 文件组织 | 25% | 60% | 100% |
| 安全性 | 25% | 80% | 100% |
| 文档完整性 | 20% | 70% | 100% |
| **总分** | **100%** | **62%** | **100%** |

## 🎯 实施时间表

### 本周内完成

- [x] 制定配置管理规范
- [ ] 更新环境变量命名
- [ ] 创建配置验证脚本
- [ ] 整合重复配置文件

### 下周内完成

- [ ] 实施配置热重载
- [ ] 建立配置版本管理
- [ ] 完善配置文档
- [ ] 配置安全性审计

---

## ✅ 配置管理规范状态: **已制定完成**

**制定时间**: 2025-05-24  
**覆盖范围**: ✅ 全面  
**可执行性**: ✅ 高  
**预期效果**: ✅ 显著  

MarketPrism配置管理规范已制定完成，为系统配置统一和管理优化提供了完整的指导方案。 