# MarketPrism 技术栈迁移检查清单

## 目的

本文档为MarketPrism项目的技术栈迁移提供标准化的检查清单，确保在进行技术组件更新或替换时，所有相关配置、代码和文档都得到一致性更新。

## 使用方法

在进行任何技术栈变更（如从Redis迁移到NATS）时，请遵循以下步骤：

1. 创建一个新的分支用于技术迁移
2. 按照本清单逐项检查和更新
3. 在提交前使用配置验证工具确认一致性
4. 在PR描述中引用本清单，并标注已完成的项目

## 通用迁移检查清单

### 1. 配置文件更新

- [ ] 更新主配置文件，添加新组件配置
- [ ] 移除或标记为过时的旧组件配置
- [ ] 更新配置文件版本号和最后修改日期
- [ ] 验证所有配置文件中的组件引用都已更新

### 2. Docker相关文件

- [ ] 更新`docker-compose.yml`中的服务定义
- [ ] 移除已不再使用的服务
- [ ] 更新服务间的依赖关系
- [ ] 移除旧组件的数据卷定义
- [ ] 更新环境变量，移除旧组件的引用
- [ ] 检查健康检查配置

### 3. 代码更新

- [ ] 更新客户端库和依赖
- [ ] 修改业务逻辑中对旧组件的调用
- [ ] 更新或创建新的适配器类
- [ ] 更新单元测试
- [ ] 更新集成测试

### 4. 文档更新

- [ ] 更新README.md中的描述
- [ ] 更新架构图
- [ ] 更新安装和配置指南
- [ ] 更新示例代码
- [ ] 更新FAQ和故障排除部分
- [ ] 更新API文档（如适用）

### 5. 监控和告警

- [ ] 添加新组件的监控指标
- [ ] 更新Prometheus配置
- [ ] 更新Grafana仪表板
- [ ] 更新告警规则
- [ ] 移除旧组件的监控指标

### 6. 迁移和数据处理

- [ ] 设计数据迁移策略（如需要）
- [ ] 创建数据迁移脚本
- [ ] 验证迁移后的数据完整性

### 7. 验证和测试

- [ ] 运行`python scripts/config_validator.py`验证配置一致性
- [ ] 执行所有单元测试
- [ ] 执行集成测试
- [ ] 测试部署流程
- [ ] 测试备份和恢复功能

## 特定技术迁移案例

### Redis 到 NATS 迁移检查清单

- [ ] 移除`docker-compose.yml`中的Redis服务定义
- [ ] 移除对Redis服务的依赖引用
- [ ] 移除Redis相关环境变量
- [ ] 移除Redis数据卷
- [ ] 更新`config/nats_base.yaml`，移除Redis配置或标记为已弃用
- [ ] 更新客户端代码，将Redis客户端替换为NATS客户端
- [ ] 修改消息发布和订阅逻辑
- [ ] 更新README.md中的Redis相关说明和示例
- [ ] 添加NATS相关监控指标
- [ ] 创建NATS监控仪表板
- [ ] 验证消息队列功能正常工作

## 迁移后验证

在完成所有迁移步骤后，请执行以下命令验证配置一致性：

```bash
# 运行配置验证工具
python scripts/config_validator.py --verbose

# 检查docker-compose配置
docker-compose config

# 确保系统可以成功启动
docker-compose up -d

# 验证关键服务正常运行
docker-compose ps
```

## 回滚计划

如果迁移过程中出现问题，请遵循以下回滚步骤：

1. 停止当前服务：`docker-compose down`
2. 切换回旧版本分支
3. 启动旧版本服务：`docker-compose up -d`
4. 验证系统功能恢复正常
5. 分析迁移失败原因，制定新的迁移计划

---

最后更新日期：2025-04-30
版本：1.2.0 