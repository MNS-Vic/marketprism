# MarketPrism TDD æµ‹è¯•ä¼˜åŒ–è®¡åˆ’
*çœŸå®ç¯å¢ƒ - é—®é¢˜å¯¼å‘ - æµ‹è¯•å…ˆè¡Œ*

## ğŸ¯ TDD æ ¸å¿ƒç›®æ ‡

### æµ‹è¯•åŸåˆ™
1. **ğŸ”¬ çœŸå®ç¯å¢ƒæµ‹è¯•**ï¼šä¸ä½¿ç”¨Mockï¼Œè¿æ¥çœŸå®äº¤æ˜“æ‰€APIã€æ•°æ®åº“
2. **ğŸ§ª æµ‹è¯•å…ˆè¡Œ**ï¼šå…ˆå†™æµ‹è¯•æè¿°éœ€æ±‚ï¼Œå†å®ç°åŠŸèƒ½
3. **âš¡ å¿«é€Ÿåé¦ˆ**ï¼šå°æ­¥è¿­ä»£ï¼Œç«‹å³å‘ç°é—®é¢˜å’Œè®¾è®¡ç¼ºé™·
4. **ğŸ¯ é—®é¢˜å¯¼å‘**ï¼šæ¯ä¸ªæµ‹è¯•å¯¹åº”å…·ä½“çš„åŠŸèƒ½éœ€æ±‚æˆ–è®¾è®¡é—®é¢˜

### è´¨é‡ç›®æ ‡
- âœ… **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ‰€æœ‰å¾®æœåŠ¡çœŸå®å¯ç”¨
- âœ… **æ€§èƒ½è¾¾æ ‡**ï¼šå“åº”æ—¶é—´ã€ååé‡æ»¡è¶³è¦æ±‚
- âœ… **ç¨³å®šæ€§ä¿è¯**ï¼šé•¿æ—¶é—´è¿è¡Œæ— æ•…éšœ
- âœ… **é›†æˆæ­£ç¡®æ€§**ï¼šæœåŠ¡é—´é€šä¿¡æ­£å¸¸

## ğŸ“‹ TDD æµ‹è¯•é˜¶æ®µè§„åˆ’

### Phase 1: åŸºç¡€æœåŠ¡çœŸå®æ€§éªŒè¯ (Week 1)
**ç›®æ ‡**ï¼šç¡®ä¿æ¯ä¸ªå¾®æœåŠ¡éƒ½èƒ½çœŸå®å·¥ä½œï¼Œä¸ä¾èµ–æ¨¡æ‹Ÿ

#### 1.1 æ•°æ®å­˜å‚¨æœåŠ¡çœŸå®æ€§æµ‹è¯•
```python
# TDD: å…ˆå†™æµ‹è¯•ï¼Œæè¿°æœŸæœ›çš„è¡Œä¸º
def test_real_clickhouse_connection():
    """æµ‹è¯•ï¼šæ•°æ®å­˜å‚¨æœåŠ¡åº”è¯¥èƒ½è¿æ¥çœŸå®çš„ClickHouse"""
    # Given: ClickHouseæœåŠ¡è¿è¡Œä¸­
    # When: è°ƒç”¨å­˜å‚¨æœåŠ¡API
    # Then: åº”è¯¥æˆåŠŸè¿æ¥å¹¶è¿”å›çŠ¶æ€
    pass  # å®ç°å°†é©±åŠ¨ä»£ç ç¼–å†™

def test_real_redis_caching():
    """æµ‹è¯•ï¼šç¼“å­˜åŠŸèƒ½åº”è¯¥ä½¿ç”¨çœŸå®Redis"""
    # Given: RedisæœåŠ¡è¿è¡Œä¸­
    # When: å­˜å‚¨å’Œè¯»å–ç¼“å­˜æ•°æ®
    # Then: æ•°æ®åº”è¯¥æ­£ç¡®ç¼“å­˜å’Œæ£€ç´¢
    pass

def test_hot_cold_data_lifecycle():
    """æµ‹è¯•ï¼šçƒ­å†·æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†åº”è¯¥çœŸå®å·¥ä½œ"""
    # Given: æœ‰çƒ­æ•°æ®å­˜å‚¨
    # When: è§¦å‘æ•°æ®å½’æ¡£
    # Then: æ•°æ®åº”è¯¥æ­£ç¡®è¿ç§»åˆ°å†·å­˜å‚¨
    pass
```

#### 1.2 å¸‚åœºæ•°æ®é‡‡é›†çœŸå®æ€§æµ‹è¯•
```python
def test_real_binance_connection():
    """æµ‹è¯•ï¼šåº”è¯¥èƒ½è¿æ¥çœŸå®çš„Binance Testnet"""
    # Given: ä»£ç†é…ç½®æ­£ç¡®ï¼Œæœ‰Testnet APIå¯†é’¥
    # When: è¿æ¥Binance WebSocket
    # Then: åº”è¯¥æˆåŠŸè¿æ¥å¹¶æ¥æ”¶æ•°æ®
    pass

def test_real_data_normalization():
    """æµ‹è¯•ï¼šåº”è¯¥æ­£ç¡®è§„èŒƒåŒ–çœŸå®å¸‚åœºæ•°æ®"""
    # Given: æ¥æ”¶åˆ°BinanceåŸå§‹æ•°æ®
    # When: è¿›è¡Œæ•°æ®è§„èŒƒåŒ–
    # Then: è¾“å‡ºåº”è¯¥ç¬¦åˆå†…éƒ¨æ•°æ®æ ¼å¼
    pass

def test_multi_exchange_real_data():
    """æµ‹è¯•ï¼šåº”è¯¥åŒæ—¶å¤„ç†å¤šä¸ªäº¤æ˜“æ‰€çš„çœŸå®æ•°æ®"""
    # Given: è¿æ¥Binanceå’ŒOKX
    # When: åŒæ—¶è®¢é˜…ç›¸åŒäº¤æ˜“å¯¹
    # Then: åº”è¯¥æ­£ç¡®å¤„ç†å¹¶åŒºåˆ†æ•°æ®æº
    pass
```

#### 1.3 APIç½‘å…³çœŸå®è·¯ç”±æµ‹è¯•
```python
def test_real_service_discovery():
    """æµ‹è¯•ï¼šAPIç½‘å…³åº”è¯¥å‘ç°çœŸå®è¿è¡Œçš„æœåŠ¡"""
    # Given: å¾®æœåŠ¡éƒ½åœ¨è¿è¡Œ
    # When: æŸ¥è¯¢æœåŠ¡æ³¨å†Œè¡¨
    # Then: åº”è¯¥è¿”å›æ‰€æœ‰å¥åº·çš„æœåŠ¡
    pass

def test_real_load_balancing():
    """æµ‹è¯•ï¼šè´Ÿè½½å‡è¡¡åº”è¯¥åˆ†å‘åˆ°çœŸå®æœåŠ¡å®ä¾‹"""
    # Given: æœ‰å¤šä¸ªæœåŠ¡å®ä¾‹
    # When: å‘é€å¤šä¸ªè¯·æ±‚
    # Then: è¯·æ±‚åº”è¯¥å‡åŒ€åˆ†å‘
    pass
```

### Phase 2: ç«¯åˆ°ç«¯é›†æˆçœŸå®æ€§éªŒè¯ (Week 2)
**ç›®æ ‡**ï¼šéªŒè¯å®Œæ•´çš„æ•°æ®æµå’ŒæœåŠ¡åä½œ

#### 2.1 çœŸå®æ•°æ®æµæµ‹è¯•
```python
def test_end_to_end_data_flow():
    """æµ‹è¯•ï¼šä»æ•°æ®é‡‡é›†åˆ°å­˜å‚¨çš„å®Œæ•´æµç¨‹"""
    # Given: æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
    # When: å¯åŠ¨å¸‚åœºæ•°æ®é‡‡é›†
    # Then: æ•°æ®åº”è¯¥æ­£ç¡®æµè½¬å¹¶å­˜å‚¨
    
    # è¯¦ç»†æ­¥éª¤ï¼š
    # 1. é‡‡é›†å™¨è¿æ¥äº¤æ˜“æ‰€
    # 2. æ¥æ”¶çœŸå®å¸‚åœºæ•°æ®
    # 3. æ•°æ®è§„èŒƒåŒ–å¤„ç†
    # 4. å‘å¸ƒåˆ°æ¶ˆæ¯é˜Ÿåˆ—
    # 5. å­˜å‚¨æœåŠ¡æ¥æ”¶å¹¶ä¿å­˜
    # 6. å¯ä»¥é€šè¿‡APIæŸ¥è¯¢åˆ°æ•°æ®
    pass

def test_real_time_data_processing():
    """æµ‹è¯•ï¼šå®æ—¶æ•°æ®å¤„ç†çš„æ€§èƒ½å’Œå‡†ç¡®æ€§"""
    # Given: é«˜é¢‘æ•°æ®æµ
    # When: ç³»ç»Ÿå¤„ç†å®æ—¶æ•°æ®
    # Then: å»¶è¿Ÿåº”è¯¥å°äºæŒ‡å®šé˜ˆå€¼
    pass

def test_error_recovery_in_real_scenario():
    """æµ‹è¯•ï¼šçœŸå®åœºæ™¯ä¸‹çš„é”™è¯¯æ¢å¤"""
    # Given: ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
    # When: æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­æˆ–æœåŠ¡æ•…éšœ
    # Then: ç³»ç»Ÿåº”è¯¥è‡ªåŠ¨æ¢å¤å¹¶é‡æ–°è¿æ¥
    pass
```

#### 2.2 æ€§èƒ½å‹åŠ›çœŸå®æ€§æµ‹è¯•
```python
def test_real_load_performance():
    """æµ‹è¯•ï¼šçœŸå®è´Ÿè½½ä¸‹çš„ç³»ç»Ÿæ€§èƒ½"""
    # Given: ç³»ç»Ÿæ¥æ”¶çœŸå®å¸‚åœºæ•°æ®
    # When: åŒæ—¶å¤„ç†å¤šä¸ªäº¤æ˜“æ‰€çš„é«˜é¢‘æ•°æ®
    # Then: ç³»ç»Ÿåº”è¯¥ä¿æŒç¨³å®šæ€§èƒ½
    pass

def test_memory_usage_under_real_load():
    """æµ‹è¯•ï¼šçœŸå®è´Ÿè½½ä¸‹çš„å†…å­˜ä½¿ç”¨"""
    # Given: é•¿æ—¶é—´è¿è¡Œ
    # When: å¤„ç†å¤§é‡çœŸå®æ•°æ®
    # Then: å†…å­˜ä½¿ç”¨åº”è¯¥ç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼
    pass
```

### Phase 3: ç”Ÿäº§åœºæ™¯æ¨¡æ‹Ÿæµ‹è¯• (Week 3)
**ç›®æ ‡**ï¼šæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„å¤æ‚åœºæ™¯

#### 3.1 é«˜å¯ç”¨æ€§æµ‹è¯•
```python
def test_service_failure_recovery():
    """æµ‹è¯•ï¼šå•ä¸ªæœåŠ¡æ•…éšœæ—¶çš„ç³»ç»Ÿæ¢å¤"""
    # Given: ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
    # When: å•ä¸ªæœåŠ¡å´©æºƒ
    # Then: å…¶ä»–æœåŠ¡åº”è¯¥ç»§ç»­å·¥ä½œï¼Œæ•…éšœæœåŠ¡åº”è¯¥è‡ªåŠ¨é‡å¯
    pass

def test_database_failover():
    """æµ‹è¯•ï¼šæ•°æ®åº“æ•…éšœæ—¶çš„æ•…éšœè½¬ç§»"""
    # Given: ä¸»æ•°æ®åº“æ•…éšœ
    # When: åˆ‡æ¢åˆ°å¤‡ä»½æ•°æ®åº“
    # Then: æ•°æ®è®¿é—®åº”è¯¥æ— ç¼åˆ‡æ¢
    pass
```

#### 3.2 æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
```python
def test_data_consistency_across_services():
    """æµ‹è¯•ï¼šè·¨æœåŠ¡æ•°æ®ä¸€è‡´æ€§"""
    # Given: å¤šä¸ªæœåŠ¡å¤„ç†ç›¸åŒæ•°æ®
    # When: å¹¶å‘æ›´æ–°æ•°æ®
    # Then: æ‰€æœ‰æœåŠ¡çœ‹åˆ°çš„æ•°æ®åº”è¯¥ä¸€è‡´
    pass

def test_transaction_integrity():
    """æµ‹è¯•ï¼šäº‹åŠ¡å®Œæ•´æ€§"""
    # Given: è·¨æœåŠ¡äº‹åŠ¡
    # When: éƒ¨åˆ†æœåŠ¡å¤±è´¥
    # Then: äº‹åŠ¡åº”è¯¥æ­£ç¡®å›æ»š
    pass
```

### Phase 4: å®‰å…¨æ€§å’Œç›‘æ§çœŸå®æ€§æµ‹è¯• (Week 4)
**ç›®æ ‡**ï¼šéªŒè¯å®‰å…¨é˜²æŠ¤å’Œç›‘æ§å‘Šè­¦

#### 4.1 å®‰å…¨æ€§æµ‹è¯•
```python
def test_real_api_rate_limiting():
    """æµ‹è¯•ï¼šçœŸå®APIé€Ÿç‡é™åˆ¶"""
    # Given: é…ç½®äº†é€Ÿç‡é™åˆ¶
    # When: è¶…è¿‡é™åˆ¶é¢‘ç‡å‘é€è¯·æ±‚
    # Then: åº”è¯¥æ­£ç¡®æ‹’ç»è¿‡é‡è¯·æ±‚
    pass

def test_authentication_with_real_tokens():
    """æµ‹è¯•ï¼šä½¿ç”¨çœŸå®tokençš„è®¤è¯"""
    # Given: çœŸå®çš„JWT token
    # When: è®¿é—®å—ä¿æŠ¤çš„API
    # Then: åº”è¯¥æ­£ç¡®éªŒè¯å¹¶æˆæƒ
    pass
```

#### 4.2 ç›‘æ§å‘Šè­¦æµ‹è¯•
```python
def test_real_prometheus_metrics():
    """æµ‹è¯•ï¼šPrometheusæŒ‡æ ‡æ”¶é›†"""
    # Given: ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
    # When: æŸ¥è¯¢PrometheusæŒ‡æ ‡
    # Then: åº”è¯¥æœ‰å®Œæ•´çš„æœåŠ¡æŒ‡æ ‡æ•°æ®
    pass

def test_alert_triggering():
    """æµ‹è¯•ï¼šå‘Šè­¦è§¦å‘æœºåˆ¶"""
    # Given: é…ç½®äº†å‘Šè­¦è§„åˆ™
    # When: ç³»ç»ŸæŒ‡æ ‡è¶…è¿‡é˜ˆå€¼
    # Then: åº”è¯¥æ­£ç¡®è§¦å‘å‘Šè­¦
    pass
```

## ğŸ› ï¸ TDD å·¥å…·å’ŒåŸºç¡€è®¾æ–½

### æµ‹è¯•ç¯å¢ƒé…ç½®
```yaml
# config/test_config.yaml ç¤ºä¾‹
proxy:
  enabled: true
  http_proxy: "http://127.0.0.1:7890"
  https_proxy: "http://127.0.0.1:7890"

exchanges:
  binance:
    testnet: true
    base_url: "https://testnet.binance.vision"
    ws_url: "wss://testnet.binance.vision/ws"
    
databases:
  clickhouse:
    host: "localhost"
    port: 8123
    database: "marketprism_test"
    
  redis:
    host: "localhost"
    port: 6379
    db: 1  # æµ‹è¯•ä¸“ç”¨æ•°æ®åº“
```

### æµ‹è¯•æ¡†æ¶ä½¿ç”¨
```python
# ä½¿ç”¨çœŸå®æµ‹è¯•åŸºç¡€ç±»
from tests.tdd_framework.real_test_base import RealTestBase, real_test_environment

class TestMarketDataCollector(RealTestBase):
    
    @pytest.mark.asyncio
    async def test_binance_real_connection(self):
        """TDD: æµ‹è¯•çœŸå®Binanceè¿æ¥"""
        async with real_test_environment() as env:
            # è¿™é‡Œå†™å…·ä½“çš„æµ‹è¯•é€»è¾‘
            pass
```

### æµ‹è¯•æ•°æ®ç®¡ç†
```python
# æµ‹è¯•æ•°æ®ç”Ÿå‘½å‘¨æœŸ
def setup_test_data():
    """å‡†å¤‡æµ‹è¯•æ•°æ®"""
    pass

def cleanup_test_data():
    """æ¸…ç†æµ‹è¯•æ•°æ®"""
    pass

def verify_test_data_integrity():
    """éªŒè¯æµ‹è¯•æ•°æ®å®Œæ•´æ€§"""
    pass
```

## ğŸ“Š TDD æ‰§è¡Œè®¡åˆ’

### Week 1: åŸºç¡€æœåŠ¡éªŒè¯
- [ ] è®¾ç½®TDDæµ‹è¯•ç¯å¢ƒå’Œä»£ç†é…ç½®
- [ ] å®ç°æ•°æ®å­˜å‚¨æœåŠ¡çœŸå®æ€§æµ‹è¯•
- [ ] å®ç°å¸‚åœºæ•°æ®é‡‡é›†çœŸå®æ€§æµ‹è¯•
- [ ] å®ç°APIç½‘å…³çœŸå®è·¯ç”±æµ‹è¯•
- [ ] éªŒè¯æ‰€æœ‰åŸºç¡€æœåŠ¡å¯ä»¥çœŸå®å·¥ä½œ

### Week 2: é›†æˆæµç¨‹éªŒè¯
- [ ] å®ç°ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•
- [ ] å®ç°æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] éªŒè¯æœåŠ¡é—´çœŸå®é€šä¿¡
- [ ] æµ‹è¯•é”™è¯¯æ¢å¤æœºåˆ¶

### Week 3: ç”Ÿäº§åœºæ™¯æµ‹è¯•
- [ ] å®ç°é«˜å¯ç”¨æ€§æµ‹è¯•
- [ ] å®ç°æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
- [ ] æ¨¡æ‹Ÿå¤æ‚æ•…éšœåœºæ™¯
- [ ] éªŒè¯ç³»ç»Ÿç¨³å®šæ€§

### Week 4: å®‰å…¨ç›‘æ§æµ‹è¯•
- [ ] å®ç°å®‰å…¨æ€§æµ‹è¯•
- [ ] å®ç°ç›‘æ§å‘Šè­¦æµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†å»ºç«‹
- [ ] æœ€ç»ˆé›†æˆéªŒè¯

## ğŸ¯ TDD æˆåŠŸæ ‡å‡†

### åŠŸèƒ½æŒ‡æ ‡
- âœ… æ‰€æœ‰å¾®æœåŠ¡å¯ä»¥è¿æ¥çœŸå®å¤–éƒ¨æœåŠ¡
- âœ… ç«¯åˆ°ç«¯æ•°æ®æµæ­£å¸¸å·¥ä½œ
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æœ‰æ•ˆ
- âœ… æ€§èƒ½æ»¡è¶³é¢„æœŸè¦æ±‚

### è´¨é‡æŒ‡æ ‡
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 90%
- âœ… æ‰€æœ‰æµ‹è¯•ä½¿ç”¨çœŸå®ç¯å¢ƒ
- âœ… æµ‹è¯•æ‰§è¡Œæ—¶é—´ < 30åˆ†é’Ÿ
- âœ… é›¶Mockä¾èµ–

### ç”Ÿäº§å°±ç»ªæŒ‡æ ‡
- âœ… ç³»ç»Ÿå¯ä»¥è¿ç»­è¿è¡Œ24å°æ—¶æ— æ•…éšœ
- âœ… å“åº”æ—¶é—´ < 100ms (P95)
- âœ… ååé‡ > 1000 req/s
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®šæ— æ³„æ¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# é…ç½®ä»£ç†
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890

# å®‰è£…æµ‹è¯•ä¾èµ–
pip install -r requirements-test.txt

# å¯åŠ¨åŸºç¡€è®¾æ–½
docker-compose -f docker-compose-test.yml up -d
```

### 2. è¿è¡ŒTDDæµ‹è¯•
```bash
# æµ‹è¯•ç¯å¢ƒéªŒè¯
python tests/tdd_framework/real_test_base.py

# è¿è¡Œç¬¬ä¸€ä¸ªTDDæµ‹è¯•
pytest tests/tdd/test_data_storage_real.py -v

# è¿è¡Œå®Œæ•´TDDæµ‹è¯•å¥—ä»¶
pytest tests/tdd/ -v --tb=short
```

### 3. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š
```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=services tests/tdd/

# ç”ŸæˆHTMLæŠ¥å‘Š
pytest --html=reports/tdd_report.html
```

## ğŸ“ TDD æœ€ä½³å®è·µ

### ç¼–å†™æµ‹è¯•çš„åŸåˆ™
1. **æè¿°æ¸…æ™°**ï¼šæ¯ä¸ªæµ‹è¯•éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰
2. **ç‹¬ç«‹æ€§**ï¼šæµ‹è¯•ä¹‹é—´ä¸ç›¸äº’ä¾èµ–
3. **å¯é‡å¤**ï¼šåŒæ ·çš„æµ‹è¯•å¤šæ¬¡è¿è¡Œç»“æœä¸€è‡´
4. **å¿«é€Ÿåé¦ˆ**ï¼šæµ‹è¯•è¿è¡Œæ—¶é—´å°½å¯èƒ½çŸ­

### æµ‹è¯•å‘½åè§„èŒƒ
```python
def test_should_connect_to_real_binance_when_proxy_configured():
    """
    æµ‹è¯•ï¼šé…ç½®ä»£ç†ååº”è¯¥èƒ½è¿æ¥åˆ°çœŸå®Binance
    Given: ä»£ç†å·²é…ç½®
    When: å°è¯•è¿æ¥Binance Testnet
    Then: è¿æ¥åº”è¯¥æˆåŠŸ
    """
    pass
```

### é”™è¯¯å¤„ç†ç­–ç•¥
```python
def test_should_retry_when_network_temporarily_fails():
    """
    æµ‹è¯•ï¼šç½‘ç»œä¸´æ—¶æ•…éšœæ—¶åº”è¯¥é‡è¯•
    """
    # æ¨¡æ‹Ÿç½‘ç»œæ•…éšœ
    # éªŒè¯é‡è¯•æœºåˆ¶
    # ç¡®è®¤æœ€ç»ˆæˆåŠŸ
    pass
```

---

**ğŸ¯ TDDç›®æ ‡**ï¼šé€šè¿‡çœŸå®ç¯å¢ƒæµ‹è¯•ï¼Œç¡®ä¿MarketPrismå¾®æœåŠ¡æ¶æ„åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šå¯é è¿è¡Œ