# ğŸ“Š MarketPrism ç»Ÿä¸€äº¤æ˜“æ•°æ®æ ‡å‡†åŒ–å™¨

## ğŸ¯ **æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†MarketPrismç³»ç»Ÿä¸­ç»Ÿä¸€äº¤æ˜“æ•°æ®æ ‡å‡†åŒ–å¤„ç†æ–¹æ¡ˆï¼Œæ”¯æŒBinanceç°è´§ã€BinanceæœŸè´§ã€OKXç­‰å¤šç§äº¤æ˜“ç±»å‹çš„æ•°æ®é‡‡é›†ã€æ ‡å‡†åŒ–ã€å­˜å‚¨å’Œåˆ†æã€‚

## ğŸ” **æ”¯æŒçš„äº¤æ˜“ç±»å‹**

### **äº¤æ˜“ç±»å‹å¯¹æ¯”**

| äº¤æ˜“æ‰€ | äº¤æ˜“ç±»å‹ | APIç±»å‹ | æ•°æ®ç‰¹ç‚¹ |
|--------|----------|---------|----------|
| **Binance** | ç°è´§ | WebSocketé€ç¬”äº¤æ˜“ | å•ç¬”äº¤æ˜“ï¼Œå®æ—¶æ€§é«˜ |
| **Binance** | æœŸè´§ | WebSocketå½’é›†äº¤æ˜“ | å¤šç¬”å½’é›†ï¼Œå‡å°‘æ•°æ®é‡ |
| **OKX** | ç°è´§/æœŸè´§/æ°¸ç»­ | WebSocketäº¤æ˜“é¢‘é“ | ç»Ÿä¸€æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ«ç±»å‹ |

### **æ•°æ®æ ¼å¼å·®å¼‚**

#### **å­—æ®µå‘½åå¯¹æ¯”**
| æ•°æ®é¡¹ | Binanceç°è´§ | BinanceæœŸè´§ | OKX |
|--------|-------------|-------------|-----|
| **ä»·æ ¼** | "p" | "p" | "px" |
| **æ•°é‡** | "q" | "q" | "sz" |
| **æ—¶é—´** | "T" | "T" | "ts" |
| **äº¤æ˜“ID** | "t" | "a" (å½’é›†ID) | "tradeId" |
| **æ–¹å‘** | "m" (åšå¸‚æ–¹æ ‡è¯†) | "m" (åšå¸‚æ–¹æ ‡è¯†) | "side" (ç›´æ¥æ–¹å‘) |

#### **äº¤æ˜“æ–¹å‘è¡¨ç¤º**
- **Binance**: `m=true`è¡¨ç¤ºä¸»åŠ¨å–å‡ºï¼Œ`m=false`è¡¨ç¤ºä¸»åŠ¨ä¹°å…¥
- **OKX**: `side="buy"`è¡¨ç¤ºä¸»åŠ¨ä¹°å…¥ï¼Œ`side="sell"`è¡¨ç¤ºä¸»åŠ¨å–å‡º

## ğŸ“¡ **APIæ•°æ®ç»“æ„è¯¦è§£**

### **Binanceç°è´§é€ç¬”äº¤æ˜“**
```json
{
  "e": "trade",        // äº‹ä»¶ç±»å‹
  "E": 1672515782136,  // äº‹ä»¶æ—¶é—´
  "s": "BNBBTC",       // äº¤æ˜“å¯¹
  "t": 12345,          // äº¤æ˜“ID
  "p": "0.001",        // æˆäº¤ä»·æ ¼
  "q": "100",          // æˆäº¤æ•°é‡
  "T": 1672515782136,  // æˆäº¤æ—¶é—´
  "m": true            // ä¹°æ–¹æ˜¯å¦æ˜¯åšå¸‚æ–¹
}
```

### **BinanceæœŸè´§å½’é›†äº¤æ˜“**
```json
{
  "e": "aggTrade",  // äº‹ä»¶ç±»å‹
  "E": 123456789,   // äº‹ä»¶æ—¶é—´
  "s": "BNBUSDT",   // äº¤æ˜“å¯¹
  "a": 5933014,     // å½’é›†æˆäº¤ID
  "p": "0.001",     // æˆäº¤ä»·æ ¼
  "q": "100",       // æˆäº¤é‡
  "f": 100,         // è¢«å½’é›†çš„é¦–ä¸ªäº¤æ˜“ID
  "l": 105,         // è¢«å½’é›†çš„æœ«æ¬¡äº¤æ˜“ID
  "T": 123456785,   // æˆäº¤æ—¶é—´
  "m": true         // ä¹°æ–¹æ˜¯å¦æ˜¯åšå¸‚æ–¹
}
```

### **OKXäº¤æ˜“é¢‘é“**
```json
{
  "arg": {
    "channel": "trades",
    "instId": "BTC-USDT"
  },
  "data": [{
    "instId": "BTC-USDT",
    "tradeId": "130639474",
    "px": "42219.9",
    "sz": "0.12060306",
    "side": "buy",
    "ts": "1629386781174"
  }]
}
```

## ğŸ“‹ **ç»Ÿä¸€æ•°æ®ç±»å‹è®¾è®¡**

### **NormalizedTrade (æ›´æ–°ç‰ˆ)**
```python
class NormalizedTrade(BaseModel):
    # åŸºç¡€ä¿¡æ¯
    exchange_name: str              # äº¤æ˜“æ‰€åç§° (binance/okx)
    symbol_name: str                # æ ‡å‡†äº¤æ˜“å¯¹æ ¼å¼ (BTC-USDT)
    currency: str                   # å¸ç§åç§° (BTC)
    
    # æ ¸å¿ƒäº¤æ˜“æ•°æ®
    trade_id: str                   # äº¤æ˜“ID (ç»Ÿä¸€ä¸ºå­—ç¬¦ä¸²)
    price: Decimal                  # æˆäº¤ä»·æ ¼
    quantity: Decimal               # æˆäº¤æ•°é‡
    quote_quantity: Optional[Decimal]    # æˆäº¤é‡‘é¢
    side: str                       # äº¤æ˜“æ–¹å‘ (buy/sell)
    
    # æ—¶é—´ä¿¡æ¯
    timestamp: datetime             # æˆäº¤æ—¶é—´
    event_time: Optional[datetime]  # äº‹ä»¶æ—¶é—´
    
    # äº¤æ˜“ç±»å‹å’Œå…ƒæ•°æ®
    trade_type: str                 # äº¤æ˜“ç±»å‹ (spot/futures/swap)
    is_maker: Optional[bool]        # æ˜¯å¦ä¸ºåšå¸‚æ–¹
    
    # å½’é›†äº¤æ˜“ç‰¹æœ‰å­—æ®µ (BinanceæœŸè´§)
    agg_trade_id: Optional[str]     # å½’é›†äº¤æ˜“ID
    first_trade_id: Optional[str]   # é¦–ä¸ªäº¤æ˜“ID
    last_trade_id: Optional[str]    # æœ«æ¬¡äº¤æ˜“ID
    
    # å…ƒæ•°æ®
    raw_data: Optional[Dict[str, Any]]  # åŸå§‹æ•°æ®
    collected_at: datetime          # é‡‡é›†æ—¶é—´
```

## ğŸ”„ **æ ‡å‡†åŒ–å¤„ç†å™¨**

### **1. Binanceç°è´§æ ‡å‡†åŒ–å™¨**
```python
def normalize_binance_spot_trade(self, data: Dict[str, Any]) -> Optional[NormalizedTrade]:
    """
    æ ‡å‡†åŒ–Binanceç°è´§é€ç¬”äº¤æ˜“æ•°æ®
    
    ç‰¹ç‚¹:
    - å¤„ç†å•ç¬”äº¤æ˜“æ•°æ®
    - è½¬æ¢åšå¸‚æ–¹æ ‡è¯†ä¸ºäº¤æ˜“æ–¹å‘
    - æ ‡å‡†åŒ–äº¤æ˜“å¯¹æ ¼å¼
    - è®¡ç®—æˆäº¤é‡‘é¢
    """
```

**å…³é”®è½¬æ¢é€»è¾‘:**
- äº¤æ˜“å¯¹: `BNBBTC` â†’ `BNB-BTC`
- äº¤æ˜“æ–¹å‘: `m=true` â†’ `side="sell"`, `m=false` â†’ `side="buy"`
- å¸ç§æå–: `BNB-BTC` â†’ `BNB`

### **2. BinanceæœŸè´§æ ‡å‡†åŒ–å™¨**
```python
def normalize_binance_futures_trade(self, data: Dict[str, Any]) -> Optional[NormalizedTrade]:
    """
    æ ‡å‡†åŒ–BinanceæœŸè´§å½’é›†äº¤æ˜“æ•°æ®
    
    ç‰¹ç‚¹:
    - å¤„ç†å½’é›†äº¤æ˜“æ•°æ®
    - ä¿ç•™å½’é›†ä¿¡æ¯ (é¦–ä¸ª/æœ«æ¬¡äº¤æ˜“ID)
    - ä½¿ç”¨å½’é›†IDä½œä¸ºä¸»è¦äº¤æ˜“ID
    - æ ‡è®°ä¸ºæœŸè´§ç±»å‹
    """
```

**å½’é›†äº¤æ˜“ç‰¹æ®Šå¤„ç†:**
- ä¸»äº¤æ˜“ID: ä½¿ç”¨å½’é›†ID (`a`å­—æ®µ)
- ä¿ç•™å½’é›†èŒƒå›´: `first_trade_id` å’Œ `last_trade_id`
- äº¤æ˜“ç±»å‹: æ ‡è®°ä¸º `futures`

### **3. OKXç»Ÿä¸€æ ‡å‡†åŒ–å™¨**
```python
def normalize_okx_trade(self, data: Dict[str, Any], trade_type: str = "spot") -> Optional[NormalizedTrade]:
    """
    æ ‡å‡†åŒ–OKXäº¤æ˜“æ•°æ®
    
    ç‰¹ç‚¹:
    - å¤„ç†WebSocketåŒ…è£…æ ¼å¼
    - ç›´æ¥ä½¿ç”¨äº¤æ˜“æ–¹å‘
    - è‡ªåŠ¨è¯†åˆ«äº¤æ˜“ç±»å‹
    - æ”¯æŒç°è´§/æœŸè´§/æ°¸ç»­åˆçº¦
    """
```

**è‡ªåŠ¨ç±»å‹è¯†åˆ«:**
```python
if "-SWAP" in symbol:
    trade_type = "swap"
elif any(month in symbol for month in ["0329", "0628", "0927", "1228"]):
    trade_type = "futures"
else:
    trade_type = "spot"
```

## ğŸ”§ **ç»Ÿä¸€åŒ–å¤„ç†é€»è¾‘**

### **1. äº¤æ˜“å¯¹æ ¼å¼æ ‡å‡†åŒ–**
```python
def _normalize_symbol_format(self, symbol: str) -> str:
    """ç»Ÿä¸€äº¤æ˜“å¯¹æ ¼å¼ä¸º BASE-QUOTE"""
    if 'USDT' in symbol and '-' not in symbol:
        base = symbol.replace('USDT', '')
        return f"{base}-USDT"
    # å…¶ä»–æ ¼å¼å¤„ç†...
    return symbol
```

### **2. äº¤æ˜“æ–¹å‘ç»Ÿä¸€**
| åŸå§‹æ ¼å¼ | ç»Ÿä¸€æ ¼å¼ | è¯´æ˜ |
|----------|----------|------|
| Binance: `m=true` | `side="sell"` | ä¸»åŠ¨å–å‡º |
| Binance: `m=false` | `side="buy"` | ä¸»åŠ¨ä¹°å…¥ |
| OKX: `side="buy"` | `side="buy"` | ä¿æŒä¸å˜ |
| OKX: `side="sell"` | `side="sell"` | ä¿æŒä¸å˜ |

### **3. æ—¶é—´æˆ³ç»Ÿä¸€**
- ç»Ÿä¸€è½¬æ¢ä¸ºUTC datetimeå¯¹è±¡
- ä¿ç•™æ¯«ç§’ç²¾åº¦
- åŒºåˆ†æˆäº¤æ—¶é—´å’Œäº‹ä»¶æ—¶é—´

### **4. æ•°æ®ç±»å‹ç»Ÿä¸€**
- ä»·æ ¼å’Œæ•°é‡: ç»Ÿä¸€ä¸º `Decimal` ç±»å‹
- äº¤æ˜“ID: ç»Ÿä¸€ä¸º `str` ç±»å‹
- æˆäº¤é‡‘é¢: è‡ªåŠ¨è®¡ç®— `price * quantity`

## ğŸ“Š **ä½¿ç”¨ç¤ºä¾‹**

### **æ ‡å‡†åŒ–ä¸åŒç±»å‹çš„äº¤æ˜“æ•°æ®**
```python
from collector.normalizer import DataNormalizer

normalizer = DataNormalizer()

# Binanceç°è´§æ•°æ®
binance_spot = {
    "e": "trade", "s": "BNBBTC", "t": 12345,
    "p": "0.001", "q": "100", "T": 1672515782136, "m": True
}
spot_result = normalizer.normalize_binance_spot_trade(binance_spot)

# BinanceæœŸè´§æ•°æ®
binance_futures = {
    "e": "aggTrade", "s": "BNBUSDT", "a": 5933014,
    "p": "0.001", "q": "100", "f": 100, "l": 105,
    "T": 123456785, "m": False
}
futures_result = normalizer.normalize_binance_futures_trade(binance_futures)

# OKXæ•°æ®
okx_data = {
    "arg": {"channel": "trades", "instId": "BTC-USDT"},
    "data": [{
        "instId": "BTC-USDT", "tradeId": "130639474",
        "px": "42219.9", "sz": "0.12060306",
        "side": "buy", "ts": "1629386781174"
    }]
}
okx_result = normalizer.normalize_okx_trade(okx_data, trade_type="spot")
```

### **ç»Ÿä¸€æ•°æ®è®¿é—®**
```python
# æ‰€æœ‰æ ‡å‡†åŒ–åçš„äº¤æ˜“æ•°æ®éƒ½æœ‰ç›¸åŒçš„æ¥å£
for trade in [spot_result, futures_result, okx_result]:
    print(f"äº¤æ˜“æ‰€: {trade.exchange_name}")
    print(f"äº¤æ˜“å¯¹: {trade.symbol_name}")
    print(f"ä»·æ ¼: {trade.price}")
    print(f"æ•°é‡: {trade.quantity}")
    print(f"æ–¹å‘: {trade.side}")
    print(f"ç±»å‹: {trade.trade_type}")
    print("---")
```

## ğŸš€ **ä¼˜åŠ¿ä¸ç‰¹ç‚¹**

### **1. ç»Ÿä¸€æ¥å£**
- ä¸åŒäº¤æ˜“æ‰€çš„æ•°æ®ä½¿ç”¨ç›¸åŒçš„æ•°æ®ç»“æ„
- ç®€åŒ–ä¸Šå±‚åº”ç”¨çš„å¼€å‘å¤æ‚åº¦
- ä¾¿äºæ•°æ®åˆ†æå’Œå¤„ç†

### **2. å®Œæ•´ä¿¡æ¯ä¿ç•™**
- ä¿ç•™åŸå§‹æ•°æ®ç”¨äºè°ƒè¯•å’Œå®¡è®¡
- ç‰¹æ®Šå­—æ®µï¼ˆå¦‚å½’é›†ä¿¡æ¯ï¼‰å¾—åˆ°ä¿ç•™
- æ”¯æŒä¸åŒäº¤æ˜“ç±»å‹çš„ç‰¹æœ‰å±æ€§

### **3. è‡ªåŠ¨ç±»å‹è¯†åˆ«**
- OKXæ•°æ®å¯ä»¥è‡ªåŠ¨è¯†åˆ«äº¤æ˜“ç±»å‹
- æ”¯æŒç°è´§ã€æœŸè´§ã€æ°¸ç»­åˆçº¦
- çµæ´»çš„ç±»å‹æŒ‡å®šæœºåˆ¶

### **4. æ•°æ®è´¨é‡ä¿è¯**
- ç»Ÿä¸€çš„æ•°æ®ç±»å‹è½¬æ¢
- å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

## âœ… **éªŒè¯ä¸æµ‹è¯•**

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š
- ä¸‰ç§äº¤æ˜“ç±»å‹çš„æ ‡å‡†åŒ–æµ‹è¯•
- æ•°æ®æ ¼å¼è½¬æ¢éªŒè¯
- é”™è¯¯å¤„ç†æœºåˆ¶æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

è¿è¡Œæµ‹è¯•ï¼š
```bash
python3 test_trade_normalizers.py
```

## ğŸ“ˆ **æ€§èƒ½æŒ‡æ ‡**

- **æ•°æ®å¤„ç†å»¶è¿Ÿ**: < 50ms
- **æ ‡å‡†åŒ–å‡†ç¡®ç‡**: > 99.9%
- **å†…å­˜ä½¿ç”¨**: ä¼˜åŒ–çš„Decimalç±»å‹
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•è·

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-12-19  
**ç»´æŠ¤è€…**: MarketPrismå¼€å‘å›¢é˜Ÿ
