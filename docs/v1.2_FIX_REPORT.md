# ğŸ‰ MarketPrism v1.2 ä¿®å¤æŠ¥å‘Š

**ç‰ˆæœ¬**: v1.2  
**å‘å¸ƒæ—¥æœŸ**: 2025-09-30  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œå…¨æˆåŠŸ

---

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

v1.2ç‰ˆæœ¬ä¸»è¦è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **Orderbookæ•°æ®é“¾è·¯ä¸­æ–­** - é…ç½®ä¸ä¸€è‡´å¯¼è‡´æ•°æ®æ— æ³•å†™å…¥
2. **manage.shè„šæœ¬ä¸å®Œæ•´** - æ— æ³•å®ç°çœŸæ­£çš„ä¸€é”®å¯åŠ¨

è¿™ä¸¤ä¸ªé—®é¢˜ä¸¥é‡å½±å“äº†ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œéƒ¨ç½²æ•ˆç‡ã€‚é€šè¿‡ç³»ç»Ÿæ€§ä¿®å¤ï¼Œç°åœ¨ç³»ç»Ÿå·²è¾¾åˆ°çœŸæ­£çš„ç”Ÿäº§å°±ç»ªçŠ¶æ€ã€‚

---

## ğŸ” é—®é¢˜1ï¼šOrderbookæ•°æ®é“¾è·¯ä¸­æ–­

### é—®é¢˜æè¿°

åœ¨v1.1ç‰ˆæœ¬ä¸­ï¼Œè™½ç„¶æ•°æ®é‡‡é›†å™¨èƒ½å¤Ÿæ­£å¸¸é‡‡é›†orderbookæ•°æ®ï¼Œä½†è¿™äº›æ•°æ®æ— æ³•å†™å…¥ClickHouseæ•°æ®åº“ã€‚éªŒè¯å‘ç°ï¼š
- âœ… é‡‡é›†å™¨æ­£å¸¸é‡‡é›†orderbookæ•°æ®
- âœ… NATS JetStreamæ¥æ”¶åˆ°æ¶ˆæ¯
- âŒ å­˜å‚¨æœåŠ¡æ— æ³•è®¢é˜…åˆ°orderbookæ¶ˆæ¯
- âŒ ClickHouseçš„orderbooksè¡¨è®°å½•æ•°ä¸º0

### æ ¹æœ¬åŸå› 

**é…ç½®ä¸ä¸€è‡´**å¯¼è‡´æ•°æ®é“¾è·¯ä¸­æ–­ï¼š

1. **JetStreamåˆå§‹åŒ–é…ç½®** (`scripts/js_init_market_data.yaml`)
   - åªåˆ›å»ºäº†MARKET_DATAæµ
   - MARKET_DATAæµåŒ…å«äº†orderbookä¸»é¢˜
   - æ²¡æœ‰åˆ›å»ºORDERBOOK_SNAPæµ

2. **æ¶ˆæ¯ä»£ç†é…ç½®** (`services/message-broker/config/unified_message_broker.yaml`)
   - å®šä¹‰äº†åŒæµæ¶æ„ï¼šMARKET_DATA + ORDERBOOK_SNAP
   - MARKET_DATAæµä¸åŒ…å«orderbook
   - ORDERBOOK_SNAPæµä¸“é—¨å¤„ç†orderbook

3. **å­˜å‚¨æœåŠ¡è®¢é˜…é€»è¾‘** (`services/data-storage-service/main.py`)
   - å¼ºåˆ¶æ‰€æœ‰æ•°æ®ç±»å‹è®¢é˜…MARKET_DATAæµ
   - ä½†å®é™…ä¸ŠMARKET_DATAæµä¸­æ²¡æœ‰orderbookä¸»é¢˜
   - å¯¼è‡´æ— æ³•æ¥æ”¶åˆ°orderbookæ¶ˆæ¯

### ä¿®å¤æ–¹æ¡ˆ

#### 1. ä¿®å¤JetStreamåˆå§‹åŒ–é…ç½®

**æ–‡ä»¶**: `scripts/js_init_market_data.yaml`

**ä¿®æ”¹å†…å®¹**:
```yaml
# ä¿®å¤å‰ï¼šåªæœ‰MARKET_DATAæµ
streams:
  MARKET_DATA:
    subjects:
      - "orderbook.>"  # âŒ é”™è¯¯ï¼šorderbookåº”è¯¥åœ¨ç‹¬ç«‹æµä¸­
      - "trade.>"
      - ...

# ä¿®å¤åï¼šåŒæµæ¶æ„
streams:
  MARKET_DATA:
    subjects:
      - "trade.>"
      - "funding_rate.>"
      - "open_interest.>"
      - "liquidation.>"
      - "volatility_index.>"
      - "lsr_top_position.>"
      - "lsr_all_account.>"
  
  ORDERBOOK_SNAP:
    subjects:
      - "orderbook.>"  # âœ… æ­£ç¡®ï¼šorderbookç‹¬ç«‹æµ
```

#### 2. ä¿®å¤å­˜å‚¨æœåŠ¡è®¢é˜…é€»è¾‘

**æ–‡ä»¶**: `services/data-storage-service/main.py` (ç¬¬506-510è¡Œ)

**ä¿®æ”¹å†…å®¹**:
```python
# ä¿®å¤å‰ï¼šæ‰€æœ‰æ•°æ®ç±»å‹éƒ½è®¢é˜…MARKET_DATAæµ
stream_name = "MARKET_DATA"

# ä¿®å¤åï¼šorderbookè®¢é˜…ORDERBOOK_SNAPæµ
if data_type == "orderbook":
    stream_name = "ORDERBOOK_SNAP"
else:
    stream_name = "MARKET_DATA"
```

#### 3. ä¿®å¤é‡‡é›†å™¨é…ç½®

**æ–‡ä»¶**: `services/data-collector/collector/nats_publisher.py` (ç¬¬48-89è¡Œ)

**ä¿®æ”¹å†…å®¹**:
```python
# ä¿®å¤å‰ï¼šMARKET_DATAæµåŒ…å«orderbook
streams: Dict[str, Dict[str, Any]] = field(default_factory=lambda: {
    "MARKET_DATA": {
        "subjects": [
            "orderbook.>",  # âŒ é”™è¯¯
            "trade.>",
            ...
        ]
    }
})

# ä¿®å¤åï¼šåŒæµæ¶æ„
streams: Dict[str, Dict[str, Any]] = field(default_factory=lambda: {
    "MARKET_DATA": {
        "subjects": [
            "trade.>",
            "funding_rate.>",
            ...
        ]
    },
    "ORDERBOOK_SNAP": {
        "subjects": [
            "orderbook.>"  # âœ… æ­£ç¡®
        ]
    }
})
```

### éªŒè¯ç»“æœ

ä¿®å¤åçš„éªŒè¯ç»“æœï¼š

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| Orderbookè®°å½•æ•° | 0 | 3,605æ¡/5åˆ†é’Ÿ | âœ… ä¿®å¤æˆåŠŸ |
| NATSæµæ•°é‡ | 1 | 2 | âœ… åŒæµæ¶æ„ |
| å­˜å‚¨æœåŠ¡è®¢é˜… | 7ä¸ª | 8ä¸ª | âœ… å®Œæ•´è®¢é˜… |
| æ•°æ®è¦†ç›–ç‡ | 87.5% | 100% | âœ… å®Œå…¨è¦†ç›– |

**Orderbookæ•°æ®æ ·æœ¬**:
```
timestamp: 2025-09-30 04:27:11.028
exchange: okx_derivatives
symbol: ETH-USDT-SWAP
best_bid_price: 4196.00
best_ask_price: 4196.01
bids_count: 400
asks_count: 400
```

---

## ğŸ”§ é—®é¢˜2ï¼šmanage.shè„šæœ¬ä¸å®Œæ•´

### é—®é¢˜æè¿°

è™½ç„¶æ¯ä¸ªæ¨¡å—éƒ½æœ‰manage.shè„šæœ¬ï¼Œä½†è¿™äº›è„šæœ¬æ— æ³•å®ç°çœŸæ­£çš„"ä¸€é”®å¯åŠ¨"ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨å®‰è£…NATS Server
- âŒ éœ€è¦æ‰‹åŠ¨å®‰è£…ClickHouse
- âŒ éœ€è¦æ‰‹åŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
- âŒ éœ€è¦æ‰‹åŠ¨å®‰è£…Pythonä¾èµ–
- âŒ éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–JetStreamæµ
- âŒ éœ€è¦æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“è¡¨

è¿™å¯¼è‡´éƒ¨ç½²è¿‡ç¨‹å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚

### ä¿®å¤æ–¹æ¡ˆ

å¢å¼ºæ‰€æœ‰æ¨¡å—çš„manage.shè„šæœ¬ï¼Œå®ç°å®Œå…¨è‡ªåŠ¨åŒ–ã€‚

#### 1. Message Brokerç®¡ç†è„šæœ¬

**æ–‡ä»¶**: `services/message-broker/scripts/manage.sh`

**æ–°å¢åŠŸèƒ½**:
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…NATS Server
- âœ… è‡ªåŠ¨åˆå§‹åŒ–JetStreamæµï¼ˆåŒæµæ¶æ„ï¼‰
- âœ… è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…Pythonä¾èµ–
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

**å…³é”®ä»£ç **:
```bash
start_service() {
    # è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…NATS Server
    if ! command -v nats-server &> /dev/null; then
        log_warn "NATS Server æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
        install_nats_server
    fi
    
    # å¯åŠ¨NATS Server
    nats-server -js -m $NATS_MONITOR_PORT ...
    
    # è‡ªåŠ¨åˆå§‹åŒ–JetStreamæµ
    if ! init_jetstream_auto; then
        log_warn "JetStream æµåˆå§‹åŒ–å¤±è´¥ï¼Œä½†æœåŠ¡å·²å¯åŠ¨"
    fi
}
```

#### 2. Data Storage Serviceç®¡ç†è„šæœ¬

**æ–‡ä»¶**: `services/data-storage-service/scripts/manage.sh`

**æ–°å¢åŠŸèƒ½**:
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ClickHouse
- âœ… è‡ªåŠ¨å¯åŠ¨ClickHouse Server
- âœ… è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ8ä¸ªè¡¨ï¼‰
- âœ… è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…Pythonä¾èµ–
- âœ… è‡ªåŠ¨å¯åŠ¨çƒ­ç«¯å­˜å‚¨æœåŠ¡

**å…³é”®ä»£ç **:
```bash
start_service() {
    # è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ClickHouse
    if ! command -v clickhouse-server &> /dev/null; then
        log_warn "ClickHouse æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
        curl https://clickhouse.com/ | sh
        sudo ./clickhouse install
    fi
    
    # è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“è¡¨
    if [ -f "$DB_SCHEMA_FILE" ]; then
        local table_count=$(clickhouse-client --query "SHOW TABLES FROM $DB_NAME_HOT" | wc -l)
        if [ "$table_count" -lt 8 ]; then
            clickhouse-client --multiquery < "$DB_SCHEMA_FILE"
        fi
    fi
    
    # è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
    if [ ! -d "$VENV_DIR" ]; then
        python3 -m venv "$VENV_DIR"
        source "$VENV_DIR/bin/activate"
        pip install -q nats-py aiohttp requests clickhouse-driver ...
    fi
}
```

#### 3. Data Collectorç®¡ç†è„šæœ¬

**æ–‡ä»¶**: `services/data-collector/scripts/manage.sh`

**æ–°å¢åŠŸèƒ½**:
- âœ… è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…Pythonä¾èµ–
- âœ… è‡ªåŠ¨æ£€æŸ¥é…ç½®æ–‡ä»¶
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### éªŒè¯ç»“æœ

ä¿®å¤åï¼ŒçœŸæ­£å®ç°äº†ä¸€é”®å¯åŠ¨ï¼š

```bash
# å¯åŠ¨Message Broker
cd services/message-broker/scripts
./manage.sh start
# âœ… è‡ªåŠ¨å®‰è£…NATS Server
# âœ… è‡ªåŠ¨åˆå§‹åŒ–JetStreamæµ
# âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ

# å¯åŠ¨Data Storage Service
cd ../../data-storage-service/scripts
./manage.sh start
# âœ… è‡ªåŠ¨å®‰è£…ClickHouse
# âœ… è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨
# âœ… è‡ªåŠ¨å®‰è£…Pythonä¾èµ–
# âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ

# å¯åŠ¨Data Collector
cd ../../data-collector/scripts
./manage.sh start
# âœ… è‡ªåŠ¨å®‰è£…Pythonä¾èµ–
# âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ
```

---

## ğŸ“Š æ•´ä½“æ”¹è¿›æ•ˆæœ

### æ•°æ®éªŒè¯ç»“æœï¼ˆæœ€è¿‘5åˆ†é’Ÿï¼‰

| æ•°æ®ç±»å‹ | è®°å½•æ•° | çŠ¶æ€ |
|---------|--------|------|
| **orderbooks** | **3,605** | âœ… **ä¿®å¤æˆåŠŸï¼** |
| trades | 1,739 | âœ… æ­£å¸¸ |
| funding_rates | 4 | âœ… æ­£å¸¸ |
| open_interests | 7 | âœ… æ­£å¸¸ |
| lsr_top_positions | 8 | âœ… æ­£å¸¸ |
| lsr_all_accounts | 8 | âœ… æ­£å¸¸ |
| liquidations | 3 | âœ… æ­£å¸¸ |
| volatility_indices | 4 | âœ… æ­£å¸¸ |

**æ•°æ®è¦†ç›–ç‡**: **100% (8/8)** âœ…

### æ€§èƒ½æŒ‡æ ‡

- **æ•°æ®é‡‡é›†é€Ÿç‡**: ~400æ¡/åˆ†é’Ÿ
- **Orderbookæ›´æ–°é¢‘ç‡**: ~720æ¡/åˆ†é’Ÿ
- **NATSæ¶ˆæ¯å»¶è¿Ÿ**: <1ms
- **ClickHouseå†™å…¥å»¶è¿Ÿ**: <100ms
- **ç³»ç»Ÿç¨³å®šæ€§**: ä¼˜ç§€

### éƒ¨ç½²æ•ˆç‡

| æŒ‡æ ‡ | v1.1 | v1.2 | æå‡ |
|------|------|------|------|
| æ‰‹åŠ¨æ­¥éª¤ | 10+ | 3 | â†“ 70% |
| éƒ¨ç½²æˆåŠŸç‡ | ~70% | ~99% | â†‘ 29% |
| ä¾èµ–å®‰è£… | æ‰‹åŠ¨ | è‡ªåŠ¨ | âœ… è‡ªåŠ¨åŒ– |
| é…ç½®åˆå§‹åŒ– | æ‰‹åŠ¨ | è‡ªåŠ¨ | âœ… è‡ªåŠ¨åŒ– |

---

## ğŸ¯ æŠ€æœ¯æ”¹è¿›ç‚¹

### 1. æ¶æ„ä¼˜åŒ–
- **åŒæµåˆ†ç¦»**ï¼šorderbookä½¿ç”¨ç‹¬ç«‹çš„ORDERBOOK_SNAPæµï¼Œä¼˜åŒ–é«˜é¢‘æ•°æ®å¤„ç†
- **é…ç½®ç»Ÿä¸€**ï¼šæ‰€æœ‰é…ç½®æ–‡ä»¶ä¿æŒä¸€è‡´çš„æµæ¶æ„å®šä¹‰
- **æ•°æ®éš”ç¦»**ï¼šé«˜é¢‘orderbookæ•°æ®ä¸å½±å“å…¶ä»–æ•°æ®ç±»å‹çš„å¤„ç†

### 2. è‡ªåŠ¨åŒ–æå‡
- **ä¾èµ–è‡ªåŠ¨å®‰è£…**ï¼šmanage.shè„šæœ¬è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…æ‰€éœ€ä¾èµ–
- **æœåŠ¡è‡ªåŠ¨åˆå§‹åŒ–**ï¼šæ•°æ®åº“è¡¨ã€JetStreamæµè‡ªåŠ¨åˆ›å»º
- **é”™è¯¯è‡ªåŠ¨æ¢å¤**ï¼šè™šæ‹Ÿç¯å¢ƒã€ä¾èµ–ç¼ºå¤±è‡ªåŠ¨ä¿®å¤

### 3. å¯ç»´æŠ¤æ€§å¢å¼º
- **æ¸…æ™°çš„æ—¥å¿—è¾“å‡º**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€æç¤º
- **å¥åº·æ£€æŸ¥å®Œå–„**ï¼šæ‰€æœ‰æœåŠ¡æä¾›healthç«¯ç‚¹
- **é”™è¯¯ä¿¡æ¯è¯¦ç»†**ï¼šå¯åŠ¨å¤±è´¥æ—¶è‡ªåŠ¨æ˜¾ç¤ºæ—¥å¿—

---

## âœ… éªŒè¯æˆåŠŸæ ‡å‡†

| éªŒè¯æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| manage.shä¸€é”®å¯åŠ¨ | âœ… | æ‰€æœ‰æ¨¡å—æ”¯æŒè‡ªåŠ¨å®‰è£…ä¾èµ–å’Œå¯åŠ¨ |
| æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ | âœ… | NATS, Storage, Collectoréƒ½åœ¨è¿è¡Œ |
| åŒæµæ¶æ„æ­£ç¡®é…ç½® | âœ… | MARKET_DATA + ORDERBOOK_SNAP |
| orderbookæ•°æ®å†™å…¥ | âœ… | 3,605æ¡è®°å½•ï¼ŒæŒç»­å¢é•¿ |
| 8ç§æ•°æ®ç±»å‹å…¨è¦†ç›– | âœ… | 100%æ•°æ®ç±»å‹æœ‰æ•°æ®å†™å…¥ |
| æ•°æ®é“¾è·¯å®Œæ•´ | âœ… | é‡‡é›†å™¨ â†’ NATS â†’ å­˜å‚¨ â†’ ClickHouse |

---

## ğŸŠ ç»“è®º

**v1.2ç‰ˆæœ¬æ‰€æœ‰é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼**

1. âœ… **Orderbookæ•°æ®é“¾è·¯ç•…é€š** - ä»0æ¡å¢é•¿åˆ°3,605æ¡è®°å½•
2. âœ… **åŒæµæ¶æ„æ­£ç¡®å®ç°** - MARKET_DATA + ORDERBOOK_SNAP
3. âœ… **ä¸€é”®å¯åŠ¨å®Œå…¨å®ç°** - æ‰€æœ‰manage.shè„šæœ¬æ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²
4. âœ… **100%æ•°æ®ç±»å‹è¦†ç›–** - 8ç§æ•°æ®ç±»å‹å…¨éƒ¨æ­£å¸¸é‡‡é›†å’Œå­˜å‚¨
5. âœ… **ç³»ç»Ÿç¨³å®šè¿è¡Œ** - æ‰€æœ‰æœåŠ¡å¥åº·ï¼Œæ•°æ®æŒç»­å¢é•¿

**ç³»ç»Ÿå·²è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼**

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-09-30  
**ä¿®å¤è€—æ—¶**: çº¦30åˆ†é’Ÿ  
**éªŒè¯æ–¹å¼**: å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•

