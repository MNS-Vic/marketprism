# MarketPrism 技术上下文

## 核心技术栈
- **Go**: 高性能WebSocket数据收集器
- **Python**: 数据处理和业务逻辑
- **NATS JetStream**: 高性能消息队列
- **ClickHouse**: 列式时序数据库
- **Docker & Docker Compose**: 容器化部署
- **Prometheus & Grafana**: 监控和可视化

## 开发策略：本地构建优先

### 🎯 核心理念
**本地构建优先，网络依赖最小化**，确保开发环境的稳定性和高效性。

### 📦 构建策略层级

#### 🥇 **优先级1：完全离线构建**
- **Go服务**: 使用 `./scripts/local_build.sh` 进行本地编译
- **容器**: 使用 `Dockerfile.offline` 进行离线构建
- **优势**: 无网络依赖，构建时间稳定（10-30秒）

#### 🥈 **优先级2：本地缓存构建**
- **预构建**: 使用 `./scripts/prebuild_images.sh` 预下载依赖
- **缓存复用**: Docker层缓存机制
- **优势**: 首次联网后，后续离线可用

#### 🥉 **优先级3：开发环境（零构建）**
- **代码挂载**: `docker-compose.dev.yml` 直接挂载源码
- **热重载**: 代码修改立即生效
- **优势**: 开发体验最佳，启动时间<10秒

#### ⚠️ **备选方案：网络优化构建**
- **优化网络**: `./scripts/build_with_optimal_config.sh`
- **使用场景**: 仅在网络环境良好且首次设置时使用

## 技术约束与解决方案

### 构建环境约束
- **网络依赖**: 最小化外部网络依赖
- **构建速度**: 本地构建<30秒，开发启动<10秒
- **环境一致性**: 通过本地构建确保跨平台一致性

### 运行时约束
- **延迟要求**: 数据采集和处理延迟必须在微秒级
- **可靠性要求**: 系统需要7x24小时稳定运行
- **跨平台**: 支持Linux和macOS
- **资源利用**: 优化CPU和内存使用，支持在有限资源环境中运行

## API和集成
- **币安API**: 实时交易数据源
- **CCXT库**: 标准化交易所API访问
- **REST API**: 提供数据和系统管理接口
- **WebSocket API**: 提供实时数据推送

## 关键技术选择

### 构建工具链
- **本地构建**: `local_build.sh` - Go服务本地编译
- **容器构建**: `Dockerfile.offline` - 离线容器构建
- **开发环境**: `docker-compose.dev.yml` - 代码挂载模式
- **预构建**: `prebuild_images.sh` - 依赖预下载

### 核心服务
- **主要语言**: Go (高性能服务), Python (辅助工具和数据分析)
- **消息队列**: NATS 与 JetStream 持久化
- **数据库**: ClickHouse 时序数据库
- **监控**: Prometheus + Grafana
- **容器化**: Docker & Docker Compose

## 架构模式
- **微服务架构**：服务间通过NATS消息队列通信
- **流处理模式**：用于实时数据处理
- **发布/订阅模式**：用于多服务间数据分发
- **冷热分层存储**：根据数据访问频率自动分层
- **本地优先模式**：优先使用本地构建和缓存

## 技术挑战与解决方案

### 1. **构建环境依赖问题**
   - **问题**：Go模块依赖GitHub路径，网络构建不稳定
   - **解决**：
     - 本地构建：使用replace指令，绕过网络依赖
     - 离线模式：`GOPROXY=direct` + `GOSUMDB=off`
     - 构建产物缓存：将编译结果保存到 `bin/` 目录

### 2. **Docker构建网络问题**
   - **问题**：容器构建依赖外部镜像源，经常超时失败
   - **解决**：
     - 离线构建：`Dockerfile.offline` 使用最小基础镜像
     - 缓存策略：预构建基础镜像，复用Docker层缓存
     - 开发模式：直接挂载代码，无需重建

### 3. **高频数据处理**
   - **问题**：交易所数据吞吐量大，需高效处理
   - **解决**：使用Go高性能WebSocket客户端，批量数据处理

### 4. **数据规范化**
   - **问题**：不同交易所数据格式不统一
   - **解决**：创建统一数据模型，实现适配器转换

### 5. **数据持久化**
   - **问题**：海量时序数据存储与查询
   - **解决**：ClickHouse优化表结构，分层存储策略

### 6. **系统弹性**
   - **问题**：外部API偶发性故障
   - **解决**：智能重连，指数退避算法，降级机制

## 主要工具与脚本

### 构建工具
- **local_build.sh**: 本地离线Go服务构建（推荐）
- **prebuild_images.sh**: Docker依赖预构建
- **docker_build_with_proxy.sh**: 代理环境构建
- **build_with_optimal_config.sh**: 网络优化构建（备选）

### 服务组件
- **go-collector**: 高性能数据收集服务
- **data-normalizer**: 数据规范化和存储服务
- **data-archiver**: 数据归档管理服务

### 测试工具
- **run_local_tests.sh**: 本地离线测试套件
- **test_data_flow_offline.py**: 离线数据流测试工具
- **run_migration_checks.sh**: 数据迁移验证

## 构建性能基准

| 构建方式 | 首次构建 | 增量构建 | 网络依赖 | 稳定性 | 推荐度 |
|----------|----------|----------|----------|--------|--------|
| **本地离线** | 30秒 | 10秒 | ❌ 无 | ✅ 极高 | 🥇 推荐 |
| **开发挂载** | 10秒 | 0秒 | ❌ 无 | ✅ 极高 | 🥇 推荐 |
| **缓存构建** | 2分钟 | 30秒 | 🟡 首次 | ✅ 高 | 🥈 良好 |
| **网络构建** | 5-10分钟 | 2-5分钟 | ❌ 强依赖 | ⚠️ 低 | ⚠️ 备选 |

## 运行时性能基准
- WebSocket连接：能同时维持>100个连接
- 数据处理：每秒>10,000个市场事件
- 数据写入：每秒>5,000条记录
- 查询延迟：简单查询<50ms，复杂聚合<200ms

## 开发环境配置

### Go环境（本地构建）
```bash
export GOPROXY=direct     # 离线模式
export GOSUMDB=off        # 禁用校验和验证
export GO111MODULE=on     # 启用Go模块
export CGO_ENABLED=0      # 静态编译
```

### Docker环境（离线优先）
```bash
# 移除网络依赖配置
mv ~/.docker/daemon.json ~/.docker/daemon.json.bak

# 使用本地构建
docker build -f Dockerfile.offline -t marketprism:local .
```

### Python环境（虚拟环境）
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## 最佳实践

### 构建实践
- ✅ **优先使用本地构建** (`./scripts/local_build.sh`)
- ✅ **开发使用代码挂载** (`docker-compose.dev.yml`)
- ✅ **预构建依赖缓存** (`./scripts/prebuild_images.sh`)
- ✅ **保持构建产物** (编译到 `bin/` 目录)
- ⚠️ **网络构建作为备选** (仅在必要时使用)

### 开发实践
- ✅ **本地编译优先**：确保开发环境稳定
- ✅ **离线测试优先**：减少外部依赖
- ✅ **增量构建**：充分利用缓存机制
- ✅ **环境一致性**：通过容器化确保一致性

---

**技术策略核心**：本地构建优先，网络依赖最小化，开发体验最大化！
