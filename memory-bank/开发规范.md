# MarketPrism 开发规范

## 🎯 核心原则

### 1. 单一职责原则 (SRP)
**避免重复实现** - 每个功能只能有一个权威实现

- ✅ **正确**: 数据标准化只在`python-collector`中实现
- ❌ **错误**: 在多个服务中重复实现标准化逻辑

### 2. DRY原则 (Don't Repeat Yourself)
**代码复用优于重写** - 发现重复代码立即重构

- ✅ **正确**: 提取公共模块，多处引用
- ❌ **错误**: 复制粘贴相同逻辑到不同文件

### 3. 明确模块边界
**清晰的服务职责** - 每个服务有明确的功能边界

- ✅ **正确**: `python-collector`负责数据收集+标准化
- ❌ **错误**: 多个服务都包含数据标准化功能

## 📁 目录结构规范

### 核心服务目录
```
services/
├── python-collector/     # 主要数据收集服务 (权威实现)
├── reliability/          # 可靠性组件 (独立功能)
├── data_archiver/        # 数据归档 (可选服务)
└── ingestion/           # 数据摄取 (需明确与collector关系)
```

### 禁止的目录结构
```
❌ 禁止: 多个标准化实现
services/
├── data_normalizer/      # 与python-collector重复
├── python-collector/
└── another_normalizer/   # 又一个重复实现

❌ 禁止: 功能不明确的目录
src/
└── marketprism/         # 早期设计，功能与services重复
```

## 🔧 代码组织规范

### 1. 数据模型统一
**强制使用Pydantic模型** - 类型安全和验证

```python
# ✅ 正确: 使用统一的Pydantic模型
from marketprism_collector.types import NormalizedTrade

# ❌ 错误: 使用不同的数据模型
from src.marketprism.models import Trade  # dataclass版本
```

### 2. 配置管理统一
**集中配置管理** - 避免配置文件分散

```
✅ 推荐结构:
config/
├── global/              # 全局配置
├── exchanges/           # 交易所配置
├── services/           # 服务特定配置
└── environments/       # 环境配置

❌ 禁止结构:
config/                 # 全局配置
services/collector/config/  # 分散配置
services/normalizer/config/ # 又一个分散配置
```

### 3. 导入规范
**明确的导入路径** - 避免循环依赖

```python
# ✅ 正确: 从权威模块导入
from services.python_collector.src.marketprism_collector.types import NormalizedTrade

# ❌ 错误: 从重复模块导入
from services.data_normalizer.models import Trade
from src.marketprism.models import Trade
```

## 🚫 严格禁止事项

### 1. 重复功能实现
- **禁止**: 创建新的数据标准化服务
- **禁止**: 重复实现交易所适配器
- **禁止**: 复制现有的数据模型定义

### 2. 未经审查的新服务
- **必须**: 新服务创建前进行架构审查
- **必须**: 确认功能不与现有服务重复
- **必须**: 明确服务边界和职责

### 3. 配置文件分散
- **禁止**: 在服务目录下创建独立配置
- **禁止**: 重复定义相同的配置项
- **禁止**: 硬编码配置值

## ✅ 开发流程规范

### 1. 新功能开发流程
```
1. 架构设计审查
   ├── 确认功能边界
   ├── 检查是否存在重复实现
   └── 明确服务职责

2. 代码实现
   ├── 使用统一的数据模型
   ├── 遵循目录结构规范
   └── 避免重复代码

3. 代码审查
   ├── 检查重复实现
   ├── 验证架构合理性
   └── 确认测试覆盖
```

### 2. 重构流程
```
1. 识别重复代码
   ├── 使用工具扫描重复
   ├── 人工审查功能重叠
   └── 量化重复程度

2. 制定重构计划
   ├── 选择权威实现
   ├── 制定迁移计划
   └── 评估风险

3. 执行重构
   ├── 备份重要代码
   ├── 分步骤执行
   └── 验证功能正常
```

## 📋 代码审查清单

### 架构层面
- [ ] 新功能是否与现有服务重复？
- [ ] 服务职责是否明确？
- [ ] 是否遵循单一职责原则？

### 实现层面
- [ ] 是否使用统一的数据模型？
- [ ] 是否遵循目录结构规范？
- [ ] 是否存在重复代码？

### 配置层面
- [ ] 配置是否集中管理？
- [ ] 是否避免硬编码？
- [ ] 是否重复定义配置？

## 🔍 重复检测工具

### 1. 自动化检测
```bash
# 检测重复的类定义
grep -r "class.*Normalizer" services/

# 检测重复的函数定义
grep -r "def normalize_" services/

# 检测重复的导入
grep -r "from.*types import" services/
```

### 2. 定期审查
- **每月**: 架构审查会议
- **每季度**: 重复代码扫描
- **每半年**: 服务边界重新评估

## 📚 最佳实践

### 1. 模块设计
- **高内聚**: 相关功能放在同一模块
- **低耦合**: 减少模块间依赖
- **单一入口**: 每个功能域只有一个权威实现

### 2. 代码复用
- **提取公共库**: 将通用功能提取为独立包
- **接口抽象**: 使用抽象基类定义接口
- **依赖注入**: 通过配置控制实现选择

### 3. 文档维护
- **架构图更新**: 新服务必须更新架构图
- **API文档**: 接口变更必须更新文档
- **变更记录**: 重要变更必须记录原因

## ⚠️ 违规处理

### 1. 发现重复实现
- **立即停止**: 停止重复功能的开发
- **评估影响**: 分析重复代码的影响范围
- **制定计划**: 制定重构或删除计划

### 2. 架构违规
- **代码回滚**: 严重违规代码必须回滚
- **重新设计**: 重新进行架构设计
- **团队讨论**: 组织架构讨论会议

## 🎖️ 架构守护者职责

### 指定架构守护者
- **职责**: 审查所有架构变更
- **权限**: 拒绝不符合规范的代码
- **义务**: 维护架构文档和规范

### 守护者检查项
- [ ] 新服务是否必要？
- [ ] 是否存在功能重复？
- [ ] 架构是否合理？
- [ ] 文档是否更新？

---

## 📖 参考资料

- [架构分析报告](架构分析报告.md)
- [架构优化建议](架构优化建议.md)
- [项目说明文档](../docs/项目说明.md)

**记住**: 预防胜于治疗，严格的开发规范是避免架构混乱的最佳方式！ 