# MarketPrism Python Collector Dockerfile - Dockeréƒ¨ç½²ç®€åŒ–ç‰ˆ
# ğŸ”„ Dockeréƒ¨ç½²ç®€åŒ–æ”¹é€  (2025-08-02)
#
# ç®€åŒ–æ”¹é€ å†…å®¹:
# - âœ… è¿è¡Œæ¨¡å¼ç®€åŒ–: ä¸“æ³¨launcheræ¨¡å¼ï¼ˆå®Œæ•´æ•°æ®æ”¶é›†ç³»ç»Ÿï¼‰
# - âœ… å¥åº·æ£€æŸ¥ç®€åŒ–: åªä¿ç•™8086ç«¯å£å¥åº·æ£€æŸ¥
# - âœ… ç«¯å£æš´éœ²ç®€åŒ–: 8086(å¥åº·æ£€æŸ¥) + 9093(ç›‘æ§)
# - âœ… å¯åŠ¨å‘½ä»¤å›ºå®š: ç›´æ¥å¯åŠ¨launcheræ¨¡å¼
# - âœ… é…ç½®è·¯å¾„ç»Ÿä¸€: ä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶
#
# éªŒè¯ç»“æœ:
# - âœ… é•œåƒæ„å»ºæˆåŠŸï¼Œå®¹å™¨å¯åŠ¨æ­£å¸¸
# - âœ… ä¸ç»Ÿä¸€NATSå®¹å™¨é›†æˆæˆåŠŸ
# - âœ… 8ç§æ•°æ®ç±»å‹Ã—5ä¸ªäº¤æ˜“æ‰€å…¨éƒ¨æ­£å¸¸å·¥ä½œ
FROM python:3.12-slim

LABEL maintainer="MarketPrism Team"
LABEL description="MarketPrism Pythonæ•°æ®æ”¶é›†å™¨"
LABEL version="1.0.0"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH=/app
ENV RATE_LIMIT_ENABLED=true
ENV API_TIMEOUT=15
ENV LOG_LEVEL=INFO

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    libc6-dev \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ– (ä½¿ç”¨--root-user-action=ignoreæŠ‘åˆ¶è­¦å‘Š)
RUN pip install --no-cache-dir --upgrade pip --root-user-action=ignore && \
    pip install --no-cache-dir -r requirements.txt --root-user-action=ignore && \
    # ç¡®ä¿nats-pyç‰ˆæœ¬æ­£ç¡®ï¼ˆè§£å†³asyncioå…¼å®¹æ€§é—®é¢˜ï¼‰
    pip install --no-cache-dir nats-py==2.2.0 --root-user-action=ignore

# å¤åˆ¶æºä»£ç å’Œé…ç½®
COPY services/data-collector/ ./services/data-collector/
COPY core/ ./core/
COPY config/ ./config/

# å¤åˆ¶å…¥å£è„šæœ¬å¹¶è®¾ç½®æƒé™ï¼ˆrooté˜¶æ®µï¼‰
COPY services/data-collector/entrypoint.sh /entrypoint.sh
RUN chmod 755 /entrypoint.sh

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 collector && \
    chown -R collector:collector /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER collector

# å¥åº·æ£€æŸ¥ï¼ˆlauncheræ¨¡å¼ä¸“ç”¨ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8086/health || exit 1

# æš´éœ²ç«¯å£ï¼ˆlauncheræ¨¡å¼ä¸“ç”¨ï¼‰
EXPOSE 8086 9093

# è®¾ç½®ç»Ÿä¸€å¯åŠ¨å…¥å£å’Œé…ç½®
# å›ºå®šä½¿ç”¨launcheræ¨¡å¼ - å®Œæ•´æ•°æ®æ”¶é›†ç³»ç»Ÿ
ENV COLLECTOR_MODE=launcher
ENV COLLECTOR_CONFIG_PATH=/app/config/collector/unified_data_collection.yaml

# å·¥ä½œç›®å½•è®¾ç½®ä¸ºdata-collector
WORKDIR /app/services/data-collector

# å…¥å£ï¼šå…ˆå¯åŠ¨ç‹¬ç«‹å¥åº·æ£€æŸ¥å†æ‰§è¡Œä¸»è¿›ç¨‹
ENTRYPOINT ["/entrypoint.sh"]