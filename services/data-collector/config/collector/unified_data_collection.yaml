system:
  name: marketprism-unified-collector
  version: 2.0.0
  environment: production
  debug: false
  use_unified_websocket: true
  logging:
    level: INFO
    format: json
    file: ./logs/unified-collector.log
    max_size: 100MB
    backup_count: 5
  observability:
    ping_pong_verbose: true
    ws_summary_enabled: true   # 新增：启用BINANCE心跳摘要日志（INFO级，每interval一条）
    ws_summary_interval_sec: 60  # 可调：60~300秒
    warn_reconnects_per_interval: 2
    warn_heartbeat_failures_per_interval: 3
    metrics_enabled: true
    metrics_port: 8080
    metrics_path: /metrics
networking:
  websocket:
    timeout: 60
    max_retries: 3
    retry_delay: 5
    ping_interval: 20
    ping_timeout: 60
    max_size: 1048576
    auto_reconnect: true
    max_reconnect_attempts: -1
    reconnect_delay: 1.0
    max_reconnect_delay: 300.0
    backoff_multiplier: 2.0
    connection_timeout: 86400
    proactive_reconnect_enabled: true
    proactive_reconnect_threshold: 86100
    dual_connection_enabled: true
    data_buffer_size: 1000
    stability:
      heartbeat:
        binance_spot_interval: 20
        binance_derivatives_interval: 180
        okx_interval: 25
        timeout: 60
        max_consecutive_failures: 3
      reconnection:
        enabled: true
        initial_delay: 1.0
        max_delay: 30.0
        backoff_multiplier: 2.0
        max_attempts: -1
        connection_timeout: 30.0
        health_check_interval: 30.0
      memory_management:
        enabled: true
        max_orderbook_states: 1000
        cleanup_interval: 300.0
        inactive_threshold: 3600.0
        memory_check_interval: 60.0
        max_memory_mb: 512
        memory_warning_threshold: 0.8
      error_recovery:
        enabled: true
        max_consecutive_errors: 5
        error_reset_interval: 300.0
        checksum_failure_threshold: 3
        sequence_error_threshold: 3
        auto_resync_enabled: true
        resync_delay: 5.0
        max_resync_attempts: 3
      performance_monitoring:
        enabled: true
        monitoring_interval: 60.0
        latency_warning_threshold: 500.0
        throughput_warning_threshold: 0.1
        cpu_warning_threshold: 90.0
        detailed_stats_interval: 300.0
        performance_history_size: 100
      logging:
        enabled: true
        log_level: INFO
        structured_logging: true
        log_performance: true
        log_errors: true
        log_connections: true
        log_data_flow: false
        sensitive_fields:
        - api_key
        - api_secret
        - passphrase
  http:
    timeout: 60
    connector_limit: 100
    connector_limit_per_host: 30
    retry_attempts: 3
  proxy:
    enabled: false
exchanges:
  binance_spot:
    name: binance
    exchange: binance_spot
    market_type: spot
    enabled: true
    api:
      base_url: https://api.binance.com
      ws_url: wss://stream.binance.com:9443
    symbols:
    - BTCUSDT
    - ETHUSDT
    data_types:
    - orderbook
    - trade
    orderbook:
      depth_limit: 500
      nats_publish_depth: 200
      update_frequency: 100
      validation_enabled: true
  binance_derivatives:
    name: binance_derivatives
    exchange: binance_derivatives
    market_type: perpetual
    enabled: true
    api:
      base_url: https://fapi.binance.com
      ws_url: wss://fstream.binance.com
    symbols:
    - BTCUSDT
    - ETHUSDT
    data_types:
    - orderbook
    - trade
    - funding_rate
    - open_interest
    - liquidation
    - lsr_top_position
    - lsr_all_account
    orderbook:
      depth_limit: 500
      nats_publish_depth: 200
      update_frequency: 100
      validation_enabled: true
  okx_spot:
    name: okx_spot
    exchange: okx_spot
    market_type: spot
    enabled: true
    api:
      base_url: https://www.okx.com
      ws_url: wss://ws.okx.com:8443/ws/v5/public
    symbols:
    - BTC-USDT
    - ETH-USDT
    data_types:
    - orderbook
    - trade
    orderbook:
      depth_limit: 500
      nats_publish_depth: 200
      update_frequency: 100
      validation_enabled: true
      buffer_max_size: 1000    # 🔧 修复：大幅提高缓冲区容量（200→1000），解决高频溢出问题
      buffer_timeout: 5.0      # 🔧 修复：延长缓冲超时（3→5秒），减少误触发重同步
      publish_queue_maxsize: 100  # 🚀 异步发布队列大小（默认10→100）
      publish_interval: 0.1    # 🎯 限流发布间隔（秒），每个symbol每100ms最多发布一次
  okx_derivatives:
    name: okx_derivatives
    exchange: okx_derivatives
    market_type: perpetual
    enabled: true
    api:
      base_url: https://www.okx.com
      ws_url: wss://ws.okx.com:8443/ws/v5/public
    symbols:
    - BTC-USDT-SWAP
    - ETH-USDT-SWAP
    data_types:
    - orderbook
    - trade
    - funding_rate
    - open_interest
    - liquidation
    - lsr_top_position
    - lsr_all_account
    orderbook:
      depth_limit: 400
      nats_publish_depth: 200
      update_frequency: 100
      validation_enabled: true
      buffer_max_size: 1000    # 🔧 修复：大幅提高缓冲区容量（200→1000），解决高频溢出问题
      buffer_timeout: 5.0      # 🔧 修复：延长缓冲超时（3→5秒），减少误触发重同步
      publish_queue_maxsize: 100  # 🚀 异步发布队列大小（默认10→100）
      publish_interval: 0.1    # 🎯 限流发布间隔（秒），每个symbol每100ms最多发布一次
  deribit_derivatives:
    name: deribit_derivatives
    exchange: deribit_derivatives
    market_type: perpetual
    enabled: true
    api:
      base_url: https://www.deribit.com
      ws_url: wss://www.deribit.com/ws/api/v2
    symbols:
    - BTC
    - ETH
    data_types:
    - volatility_index
    volatility_index:
      collection_interval_minutes: 1
      resolution: '60'
      timeout: 30
      max_retries: 3
      retry_delay: 1.0
nats:
  enabled: true
  servers:
  - nats://127.0.0.1:4222
  client_name: unified-collector
  max_reconnect_attempts: 10
  reconnect_time_wait: 2
  streams:
    orderbook: orderbook.{exchange}.{market_type}.{symbol}
    trade: trade.{exchange}.{market_type}.{symbol}
    funding_rate: funding_rate.{exchange}.{market_type}.{symbol}
    open_interest: open_interest.{exchange}.{market_type}.{symbol}
    liquidation: liquidation.{exchange}.{market_type}.{symbol}
    volatility_index: volatility_index.{exchange}.{market_type}.{symbol}
    lsr_top_position: lsr_top_position.{exchange}.{market_type}.{symbol}
    lsr_all_account: lsr_all_account.{exchange}.{market_type}.{symbol}
  publish:
    timeout: 5
    max_retries: 3
    batch_size: 100

  jetstream:
    enabled: true
    streams:
      # 主数据流 - 处理除订单簿外的所有数据类型
      MARKET_DATA:
        name: MARKET_DATA
        subjects:
        - trade.>
        - funding_rate.>
        - open_interest.>
        - liquidation.>
        - volatility_index.>
        - lsr_top_position.>
        - lsr_all_account.>
        retention: limits
        max_msgs: 5000000
        max_bytes: 2147483648  # 2GB
        max_age: 172800        # 48小时
        max_consumers: 50
        replicas: 1
        storage: file
        discard: old
        duplicate_window: 120

      # 订单簿独立流 - 性能优化，避免高频订单簿数据影响其他数据类型
      ORDERBOOK_SNAP:
        name: ORDERBOOK_SNAP
        subjects:
        - orderbook.>
        retention: limits
        max_msgs: 2000000
        max_bytes: 5368709120  # 5GB（订单簿数据量大）
        max_age: 86400         # 24小时（订单簿保留时间短）
        max_consumers: 20
        replicas: 1
        storage: file
        discard: old
        duplicate_window: 60   # 订单簿去重窗口短

clickhouse:
  host: localhost
  port: 9000
  database: marketprism
  username: default
  password: ''
  tables:
    orderbook_spot: orderbook_spot
    orderbook_perpetual: orderbook_perpetual
    trades_spot: trades_spot
    trades_perpetual: trades_perpetual
    funding_rates: funding_rates
    open_interest: open_interest
  batch:
    size: 1000
    timeout: 10
    max_retries: 3
monitoring:
  metrics:
    enabled: true
    port: 9092
    path: /metrics
  health_check:
    enabled: true
    port: 8087  # 修改端口避免与冷端存储服务(8086)冲突
    path: /health
    interval: 30
  performance:
    enabled: true
    sample_rate: 0.1
    track_memory: true
    track_cpu: true
error_handling:
  retry:
    max_attempts: 3
    backoff_multiplier: 2.0
    max_backoff_seconds: 300
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    recovery_timeout: 60
  alerts:
    enabled: true
    webhook_url: ''
    critical_errors:
    - connection_failed
    - data_corruption
    - nats_publish_failed
data_quality:
  validation:
    enabled: true
    strict_mode: false
    max_price_deviation: 0.1
    max_timestamp_drift: 5
  cleaning:
    enabled: true
    remove_duplicates: true
    filter_invalid_prices: true
    normalize_timestamps: true
  deduplication_enabled: true
  anomaly_detection_enabled: true
  price_deviation_threshold: 0.1
  volume_threshold: 1000
  completeness_target: 0.95
  latency_target: 1000
data_types:
  orderbook:
    enabled: true
    method: websocket
    interval: null
    real_time: true
    historical: false
    exchanges:
    - binance_spot
    - binance_derivatives
    - okx_spot
    - okx_derivatives
  trade:
    enabled: true
    method: websocket
    interval: null
    real_time: true
    historical: false
    exchanges:
    - binance_spot
    - binance_derivatives
    - okx_spot
    - okx_derivatives
  funding_rate:
    enabled: true
    method: rest_api
    interval: 30
    real_time: false
    historical: false
    exchanges:
      binance_derivatives:
        enabled: true
        symbols:
        - BTC-USDT
        - ETH-USDT
        api_endpoint: /fapi/v1/premiumIndex
        base_url: https://fapi.binance.com
      okx_derivatives:
        enabled: true
        symbols:
        - BTC-USDT
        - ETH-USDT
        api_endpoint: /api/v5/public/funding-rate
        base_url: https://www.okx.com
  open_interest:
    enabled: true
    method: rest_api
    interval: 30
    real_time: false
    historical: false
    exchanges:
      binance_derivatives:
        enabled: true
        symbols:
        - BTC-USDT
        - ETH-USDT
        api_endpoint: /fapi/v1/openInterestHist
        base_url: https://fapi.binance.com
        period: 5m
        limit: 1
      okx_derivatives:
        enabled: true
        symbols:
        - BTC-USDT
        - ETH-USDT
        api_endpoint: /api/v5/rubik/stat/contracts/open-interest-volume
        base_url: https://www.okx.com
        period: 5m
        limit: '1'
  liquidation:
    enabled: true
    method: websocket
    interval: null
    real_time: true
    historical: false
    exchanges:
    - okx_derivatives
    - binance_derivatives
    symbols:
    - BTCUSDT
    - ETHUSDT
    - BTC-USDT-SWAP
    - ETH-USDT-SWAP
    filters:
      min_value_usd: 0
      max_value_usd: 10000000
    validation:
      required_fields:
      - exchange_name
      - symbol_name
      - side
      - price
      - quantity
      price_range_check: true
      quantity_range_check: true
    alerts:
      large_liquidation_threshold: 100000
  lsr_top_position:
    enabled: true
    method: rest_api
    interval: 20
    real_time: false
    historical: true
    exchanges:
    - okx_derivatives
    - binance_derivatives
    api_config:
      period: 5m
      limit: 30
      max_retries: 3
      retry_delay: 5
      timeout: 30
    validation:
      required_fields:
      - exchange_name
      - symbol_name
      - long_short_ratio
      - timestamp
      ratio_range_check: true
      min_ratio: 0.1
      max_ratio: 10.0
    alerts:
      extreme_ratio_threshold: 5.0
    nats:
      enabled: true
      subject_template: lsr_top_position.{exchange}.{market_type}.{symbol}
      publish_timeout: 5
      max_retries: 3
  lsr_all_account:
    enabled: true
    method: rest_api
    interval: 20
    real_time: false
    historical: true
    exchanges:
    - okx_derivatives
    - binance_derivatives
    api_config:
      period: 5m
      limit: 30
      max_retries: 3
      retry_delay: 5
      timeout: 30
    validation:
      required_fields:
      - exchange_name
      - symbol_name
      - long_short_ratio
      - timestamp
      ratio_range_check: true
      min_ratio: 0.1
      max_ratio: 10.0
    alerts:
      extreme_ratio_threshold: 5.0
    nats:
      enabled: true
      subject_template: lsr_all_account.{exchange}.{market_type}.{symbol}
      publish_timeout: 5
      max_retries: 3
  volatility_index:
    enabled: true
    method: rest_api
    interval: 60
    real_time: false
    historical: false
    exchanges:
    - deribit_derivatives
    api_config:
      collection_interval_minutes: 1
      resolution: '60'
      timeout: 30
      max_retries: 3
      retry_delay: 1.0
    validation:
      required_fields:
      - exchange_name
      - symbol_name
      - volatility_index
      - timestamp
      index_range_check: true
      min_index: 0.0
      max_index: 500.0
    alerts:
      high_volatility_threshold: 100.0
storage:
  buffer_size: 1000
  batch_size: 100
  flush_interval: 10
  compression_enabled: true
trading_strategies:
  default:
    depth_config:
      exchanges:
        binance:
          spot:
            snapshot_depth: 1000
            websocket_depth: 1000
            api_weight: 10
            update_frequency: 100ms
          perpetual:
            snapshot_depth: 1000
            websocket_depth: 1000
            api_weight: 10
            update_frequency: 100ms
        okx:
          spot:
            snapshot_depth: 400
            websocket_depth: 400
            api_weight: 5
            update_frequency: 100ms
          perpetual:
            snapshot_depth: 400
            websocket_depth: 400
            api_weight: 5
            update_frequency: 100ms
    performance_config:
      reconnect_interval: 60
      max_latency_ms: 1000
      error_tolerance: medium
  high_frequency:
    depth_config:
      exchanges:
        binance:
          spot:
            snapshot_depth: 100
            websocket_depth: 100
            api_weight: 5
            update_frequency: 10ms
        okx:
          spot:
            snapshot_depth: 100
            websocket_depth: 100
            api_weight: 3
            update_frequency: 10ms
    performance_config:
      reconnect_interval: 10
      max_latency_ms: 100
      error_tolerance: strict
logging:
  sampling:
    default:
      count_interval: 100
      time_interval: 1.0
      always_log_errors: true
      always_log_first: true
    data_types:
      orderbook:
        count_interval: 100
        time_interval: 1.0
      trade:
        count_interval: 50
        time_interval: 1.0
      funding_rate:
        count_interval: 1
        time_interval: 0.1
      open_interest:
        count_interval: 1
        time_interval: 0.1
      lsr_top_position:
        count_interval: 20
        time_interval: 2.0
      lsr_all_account:
        count_interval: 20
        time_interval: 2.0
