# MarketPrismç»Ÿä¸€æ•°æ®æ”¶é›†å™¨ Docker Composeé…ç½®
# ğŸ”„ Dockeréƒ¨ç½²ç®€åŒ–æ”¹é€ ç‰ˆæœ¬ (2025-08-02)
#
# ç®€åŒ–æ”¹é€ å†…å®¹:
# - âœ… æœåŠ¡å®šä¹‰ç®€åŒ–: ä»4ä¸ªæœåŠ¡ç®€åŒ–ä¸º1ä¸ªæœåŠ¡
# - âœ… è¿è¡Œæ¨¡å¼å›ºå®š: ä¸“æ³¨launcheræ¨¡å¼ï¼ˆå®Œæ•´æ•°æ®æ”¶é›†ç³»ç»Ÿï¼‰
# - âœ… ç½‘ç»œæ¨¡å¼ä¼˜åŒ–: ä½¿ç”¨hostç½‘ç»œæ¨¡å¼è¿æ¥ç»Ÿä¸€NATSå®¹å™¨
# - âœ… ç¯å¢ƒå˜é‡ç®€åŒ–: æ ¸å¿ƒé…ç½®é¡¹ï¼Œæ”¯æŒAPIå¯†é’¥æ³¨å…¥
# - âœ… èµ„æºé™åˆ¶ä¼˜åŒ–: å†…å­˜2Gï¼ŒCPU 1.0æ ¸å¿ƒ
#
# éªŒè¯ç»“æœ:
# - âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼Œä¸ç»Ÿä¸€NATSå®¹å™¨é›†æˆæ­£å¸¸
# - âœ… 8ç§æ•°æ®ç±»å‹Ã—5ä¸ªäº¤æ˜“æ‰€å…¨éƒ¨æ­£å¸¸å·¥ä½œ
# - âœ… 118,187æ¡æ¶ˆæ¯ï¼Œ817MBæ•°æ®æŒç»­æµå…¥NATS
#
# ä½¿ç”¨æ–¹æ³•:
# 1. å…ˆå¯åŠ¨ç»Ÿä¸€NATS: cd ../message-broker/unified-nats && docker-compose up -d
# 2. å†å¯åŠ¨Data Collector: docker-compose -f docker-compose.unified.yml up -d



services:
  # å®Œæ•´æ•°æ®æ”¶é›†ç³»ç»Ÿï¼ˆlauncheræ¨¡å¼ï¼‰
  data-collector:
    build:
      context: ../../
      dockerfile: services/data-collector/Dockerfile
    image: marketprism/data-collector:simplified
    container_name: marketprism-data-collector
    environment:
      - COLLECTOR_MODE=launcher
      - MARKETPRISM_NATS_URL=nats://localhost:4222
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HEALTH_CHECK_PORT=8087
      - METRICS_PORT=9094
      - MARKETPRISM_UNIFIED_DATA_COLLECTION_CONFIG=/app/services/data-collector/config/collector/unified_data_collection.yaml
      # APIå¯†é’¥é…ç½®ï¼ˆå¯é€‰ï¼‰
      - BINANCE_DERIVATIVES_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_DERIVATIVES_API_SECRET=${BINANCE_API_SECRET:-}
      - OKX_DERIVATIVES_API_KEY=${OKX_API_KEY:-}
      - OKX_DERIVATIVES_API_SECRET=${OKX_API_SECRET:-}
      - OKX_DERIVATIVES_PASSPHRASE=${OKX_PASSPHRASE:-}
      - DERIBIT_DERIVATIVES_API_KEY=${DERIBIT_API_KEY:-}
      - DERIBIT_DERIVATIVES_API_SECRET=${DERIBIT_API_SECRET:-}
    network_mode: "host"
    # ä½¿ç”¨hostç½‘ç»œæ¨¡å¼ï¼Œç«¯å£ç›´æ¥æš´éœ²åœ¨ä¸»æœºä¸Šï¼š
    # - 8086: å¥åº·æ£€æŸ¥ç«¯å£
    # - 9093: PrometheusæŒ‡æ ‡ç›‘æ§ç«¯å£
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # èµ„æºé™åˆ¶ (ä½¿ç”¨Docker Compose v1å…¼å®¹è¯­æ³•)
    mem_limit: 2G
    cpus: 1.0
    mem_reservation: 512M

# æ³¨æ„ï¼šæ­¤é…ç½®ä¾èµ–å¤–éƒ¨è¿è¡Œçš„ç»Ÿä¸€NATSå®¹å™¨
# è¯·å…ˆå¯åŠ¨ç»Ÿä¸€NATSå®¹å™¨ï¼š
# cd services/message-broker/unified-nats
# sudo docker-compose -f docker-compose.unified.yml up -d

# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å¯åŠ¨å®Œæ•´ç³»ç»Ÿï¼š
#    docker-compose -f docker-compose.unified.yml up -d
#
# 2. æŸ¥çœ‹æ—¥å¿—ï¼š
#    docker-compose -f docker-compose.unified.yml logs -f data-collector
#
# 3. åœæ­¢æœåŠ¡ï¼š
#    docker-compose -f docker-compose.unified.yml down
#
# 4. è‡ªå®šä¹‰æ—¥å¿—çº§åˆ«ï¼š
#    LOG_LEVEL=DEBUG docker-compose -f docker-compose.unified.yml up -d
