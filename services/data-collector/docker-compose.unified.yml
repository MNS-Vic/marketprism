# MarketPrism统一数据收集器 Docker Compose配置
# 简化版本 - 专注launcher模式完整数据收集系统

version: '3.8'

services:
  # 完整数据收集系统（launcher模式）
  data-collector:
    build:
      context: ../../
      dockerfile: services/data-collector/Dockerfile
    image: marketprism/data-collector:simplified
    container_name: marketprism-data-collector
    environment:
      - COLLECTOR_MODE=launcher
      - MARKETPRISM_NATS_SERVERS=nats://localhost:4222
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - COLLECTOR_CONFIG_PATH=/app/config/collector/unified_data_collection.yaml
      # API密钥配置（可选）
      - MARKETPRISM_BINANCE_API_KEY=${BINANCE_API_KEY:-}
      - MARKETPRISM_BINANCE_API_SECRET=${BINANCE_API_SECRET:-}
      - MARKETPRISM_OKX_API_KEY=${OKX_API_KEY:-}
      - MARKETPRISM_OKX_API_SECRET=${OKX_API_SECRET:-}
      - MARKETPRISM_OKX_PASSPHRASE=${OKX_PASSPHRASE:-}
      - MARKETPRISM_DERIBIT_API_KEY=${DERIBIT_API_KEY:-}
      - MARKETPRISM_DERIBIT_API_SECRET=${DERIBIT_API_SECRET:-}
    network_mode: "host"
    # 使用host网络模式，端口直接暴露在主机上：
    # - 8086: 健康检查端口
    # - 9093: Prometheus指标监控端口
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'

# 注意：此配置依赖外部运行的统一NATS容器
# 请先启动统一NATS容器：
# cd services/message-broker/unified-nats
# sudo docker-compose -f docker-compose.unified.yml up -d

# 使用方法：
# 1. 启动完整系统：
#    docker-compose -f docker-compose.unified.yml up -d
#
# 2. 查看日志：
#    docker-compose -f docker-compose.unified.yml logs -f data-collector
#
# 3. 停止服务：
#    docker-compose -f docker-compose.unified.yml down
#
# 4. 自定义日志级别：
#    LOG_LEVEL=DEBUG docker-compose -f docker-compose.unified.yml up -d
