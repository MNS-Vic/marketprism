# MarketPrism统一数据收集器 Docker Compose配置
# 🔄 Docker部署简化改造版本 (2025-08-02)
#
# 简化改造内容:
# - ✅ 服务定义简化: 从4个服务简化为1个服务
# - ✅ 运行模式固定: 专注launcher模式（完整数据收集系统）
# - ✅ 网络模式优化: 使用host网络模式连接统一NATS容器
# - ✅ 环境变量简化: 核心配置项，支持API密钥注入
# - ✅ 资源限制优化: 内存2G，CPU 1.0核心
#
# 验证结果:
# - ✅ 容器启动成功，与统一NATS容器集成正常
# - ✅ 8种数据类型×5个交易所全部正常工作
# - ✅ 118,187条消息，817MB数据持续流入NATS
#
# 使用方法:
# 1. 先启动统一NATS: cd ../message-broker/unified-nats && docker-compose up -d
# 2. 再启动Data Collector: docker-compose -f docker-compose.unified.yml up -d



services:
  # 完整数据收集系统（launcher模式）
  data-collector:
    build:
      context: ../../
      dockerfile: services/data-collector/Dockerfile
    image: marketprism/data-collector:simplified
    container_name: marketprism-data-collector
    environment:
      - COLLECTOR_MODE=launcher
      - MARKETPRISM_NATS_URL=nats://host.docker.internal:4222
      - NATS_URL=nats://host.docker.internal:4222
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - COLLECTOR_ENABLE_HTTP=1
      - HEALTH_CHECK_PORT=8087
      - METRICS_PORT=9092
      - MARKETPRISM_UNIFIED_DATA_COLLECTION_CONFIG=/app/services/data-collector/config/collector/unified_data_collection.yaml
      # API密钥配置（可选）
      - BINANCE_DERIVATIVES_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_DERIVATIVES_API_SECRET=${BINANCE_API_SECRET:-}
      - OKX_DERIVATIVES_API_KEY=${OKX_API_KEY:-}
      - OKX_DERIVATIVES_API_SECRET=${OKX_API_SECRET:-}
      - OKX_DERIVATIVES_PASSPHRASE=${OKX_PASSPHRASE:-}
      - DERIBIT_DERIVATIVES_API_KEY=${DERIBIT_API_KEY:-}
      - DERIBIT_DERIVATIVES_API_SECRET=${DERIBIT_API_SECRET:-}
    networks:
      - marketprism
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8087:8086"
      - "9092:9093"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # 资源限制 (使用Docker Compose v1兼容语法)
    mem_limit: 3G
    mem_reservation: 512M

networks:
  marketprism:
    driver: bridge

# 注意：容器通过 host.docker.internal:4222 连接统一NATS容器（由 message-broker compose 暴露到宿主机）
# 使用方法：
# 1. 启动完整系统：
#    docker compose -f docker-compose.unified.yml up -d --build
# 2. 查看日志：
#    docker compose -f docker-compose.unified.yml logs -f data-collector
# 3. 停止服务：
#    docker compose -f docker-compose.unified.yml down
# 4. 自定义日志级别：
#    LOG_LEVEL=DEBUG docker compose -f docker-compose.unified.yml up -d
