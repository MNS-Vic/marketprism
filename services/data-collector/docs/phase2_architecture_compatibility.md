# Phase 2 å¤šè¿›ç¨‹æ¶æ„å…¼å®¹æ€§åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šåˆ†æäº† Phase 2 å¤šè¿›ç¨‹æ”¹é€ ä¸ç°æœ‰ MarketPrism æ¶æ„çš„å…¼å®¹æ€§ï¼Œç¡®è®¤**æ— æ¶æ„å†²çª**ï¼Œä»…éœ€**å°å¹…è°ƒæ•´ Docker å†…å­˜é…ç½®**ã€‚

**æ ¸å¿ƒç»“è®º**ï¼š
- âœ… **ç«¯å£åˆ†é…**ï¼šæ— å†²çªï¼Œæ— éœ€ä¿®æ”¹ README
- âœ… **Docker é…ç½®**ï¼šä»…éœ€è°ƒæ•´å†…å­˜é™åˆ¶ï¼ˆ3GB â†’ 4GBï¼‰
- âœ… **é…ç½®æ–‡ä»¶**ï¼šæ— éœ€ä¿®æ”¹ï¼Œä¿æŒå”¯ä¸€é…ç½®åŸåˆ™
- âœ… **å¯åŠ¨æ–¹å¼**ï¼šå®Œå…¨å‘åå…¼å®¹
- âœ… **ç›‘æ§æ¥å£**ï¼šæ¥å£ä¸å˜ï¼Œå¢åŠ å­è¿›ç¨‹è¯¦æƒ…

---

## 1ï¸âƒ£ ç«¯å£åˆ†é…åˆ†æ

### README è§„å®šçš„å›ºå®šç«¯å£

æ ¹æ® `README.md` ç¬¬ 31-38 è¡Œï¼š

```
- å›ºå®šç«¯å£ï¼ˆå†²çªè¯·"kill å ç”¨"ï¼Œä¸è¦æ”¹ç«¯å£ï¼‰
  - NATS: 4222ï¼ˆå®¢æˆ·ç«¯ï¼‰ã€8222ï¼ˆç›‘æ§/å¥åº·ï¼‰
  - çƒ­å­˜å‚¨æœåŠ¡: 8085ï¼ˆ/healthï¼‰
  - é‡‡é›†å™¨: 8087ï¼ˆ/healthï¼‰ã€9092ï¼ˆ/metricsï¼‰  â† æœ¬æœåŠ¡
  - å†·å­˜å‚¨æœåŠ¡: 8086ï¼ˆ/healthï¼‰
  - ClickHouse: 8123ï¼ˆHOT HTTPï¼‰ã€8124ï¼ˆCOLD HTTP æ˜ å°„ï¼‰
```

### å¤šè¿›ç¨‹æ¶æ„çš„ç«¯å£ä½¿ç”¨

| ç»„ä»¶ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| **ä¸»è¿›ç¨‹** | 8087, 9092 | ç»§ç»­ä½¿ç”¨ç°æœ‰ç«¯å£ï¼Œå¯¹å¤–æ¥å£ä¸å˜ |
| **å­è¿›ç¨‹ 1-5** | æ—  | é€šè¿‡ IPCï¼ˆPipeï¼‰ä¸ä¸»è¿›ç¨‹é€šä¿¡ï¼Œä¸éœ€è¦ç‹¬ç«‹ç«¯å£ |

### ç»“è®º

âœ… **æ— ç«¯å£å†²çª**
- ä¸»è¿›ç¨‹ç»§ç»­ä½¿ç”¨ 8087ï¼ˆå¥åº·æ£€æŸ¥ï¼‰ã€9092ï¼ˆæŒ‡æ ‡ï¼‰
- å­è¿›ç¨‹ä¸éœ€è¦ç‹¬ç«‹ HTTP ç«¯å£
- å¯¹å¤–æ¥å£å®Œå…¨ä¸å˜
- **æ— éœ€ä¿®æ”¹ README ç«¯å£è§„å®š**

---

## 2ï¸âƒ£ Docker é…ç½®åˆ†æ

### å½“å‰é…ç½®

æ–‡ä»¶ï¼š`services/data-collector/docker-compose.unified.yml`

```yaml
services:
  data-collector:
    mem_limit: 3G
    mem_reservation: 512M
    # CPU æ— é™åˆ¶
    ports:
      - "8087:8087"  # å¥åº·æ£€æŸ¥ç«¯å£
      - "9092:9092"  # Prometheus metrics ç«¯å£
```

### å½“å‰èµ„æºä½¿ç”¨ï¼ˆå•è¿›ç¨‹ï¼‰

```
CONTAINER ID   NAME                         CPU %     MEM USAGE / LIMIT   MEM %
415ee74a57b2   marketprism-data-collector   103.86%   418.8MiB / 3GiB     13.63%
```

**åˆ†æ**ï¼š
- CPUï¼š103.86%ï¼ˆå•æ ¸å¿ƒé¥±å’Œï¼ŒGIL ç“¶é¢ˆï¼‰
- å†…å­˜ï¼š418.8MB / 3GBï¼ˆ13.63%ï¼Œä½™é‡å……è¶³ï¼‰
- è¿›ç¨‹æ•°ï¼š9 ä¸ªçº¿ç¨‹

### å¤šè¿›ç¨‹æ¶æ„çš„èµ„æºéœ€æ±‚

| è¿›ç¨‹ | å†…å­˜ç¡¬é™åˆ¶ | è¯´æ˜ |
|------|-----------|------|
| okx_derivatives | 200MB | é«˜é¢‘ OrderBook |
| okx_spot | 160MB | é«˜é¢‘ OrderBook |
| binance_derivatives | 140MB | ä¸­é¢‘ OrderBook |
| binance_spot | 120MB | ä¸­é¢‘ OrderBook |
| deribit_derivatives | 100MB | ä½é¢‘ REST API |
| **æ€»è®¡** | **720MB** | å½“å‰ï¼š418.8MB |

**ç³»ç»Ÿå¼€é”€**ï¼š
- Python è§£é‡Šå™¨ï¼š~50MB Ã— 5 = 250MB
- IPC ç¼“å†²åŒºï¼š~30MB
- ä¸´æ—¶å³°å€¼ï¼š~50MB
- **æ€»è®¡**ï¼š~1GB

### æ¨èé…ç½®

```yaml
services:
  data-collector:
    mem_limit: 4G          # 3G â†’ 4Gï¼ˆå¢åŠ  1GBï¼‰
    mem_reservation: 1G    # 512M â†’ 1Gï¼ˆæé«˜é¢„ç•™ï¼‰
    # CPU æ— é™åˆ¶ï¼ˆä¿æŒä¸å˜ï¼Œå¤šè¿›ç¨‹å¯å……åˆ†åˆ©ç”¨å¤šæ ¸ï¼‰
    ports:
      - "8087:8087"  # å¥åº·æ£€æŸ¥ç«¯å£ï¼ˆä¸å˜ï¼‰
      - "9092:9092"  # Prometheus metrics ç«¯å£ï¼ˆä¸å˜ï¼‰
```

**è°ƒæ•´ç†ç”±**ï¼š
- å¤šè¿›ç¨‹å†…å­˜éœ€æ±‚ï¼š~1GB
- è®¾ç½® 4GB ç•™æœ‰ 3GB ä½™é‡
- è¶³å¤Ÿåº”å¯¹ä¸´æ—¶å³°å€¼å’Œç³»ç»Ÿå¼€é”€

### ç»“è®º

âœ… **ä»…éœ€è°ƒæ•´å†…å­˜é™åˆ¶**
- `mem_limit: 3G â†’ 4G`
- `mem_reservation: 512M â†’ 1G`
- å…¶ä»–é…ç½®ä¿æŒä¸å˜

---

## 3ï¸âƒ£ é…ç½®æ–‡ä»¶åˆ†æ

### å½“å‰é…ç½®æ–‡ä»¶

æ–‡ä»¶ï¼š`services/data-collector/config/collector/unified_data_collection.yaml`

**ç‰¹ç‚¹**ï¼š
- åŒ…å«æ‰€æœ‰äº¤æ˜“æ‰€å’Œæ•°æ®ç±»å‹çš„é…ç½®
- å”¯ä¸€æƒå¨é…ç½®æ–‡ä»¶
- ç¬¦åˆ README è§„å®šçš„"å•ä¸€é…ç½®"åŸåˆ™

### å¤šè¿›ç¨‹æ¶æ„çš„é…ç½®ä½¿ç”¨

```
ä¸»è¿›ç¨‹ï¼ˆmain.pyï¼‰
  â†“ åŠ è½½å®Œæ•´é…ç½®
  â†“ æŒ‰äº¤æ˜“æ‰€æ‹†åˆ†
  â”œâ”€â†’ å­è¿›ç¨‹ 1ï¼ˆokx_derivativesï¼‰ï¼šåªåŠ è½½ OKX è¡ç”Ÿå“é…ç½®
  â”œâ”€â†’ å­è¿›ç¨‹ 2ï¼ˆokx_spotï¼‰ï¼šåªåŠ è½½ OKX ç°è´§é…ç½®
  â”œâ”€â†’ å­è¿›ç¨‹ 3ï¼ˆbinance_derivativesï¼‰ï¼šåªåŠ è½½ Binance è¡ç”Ÿå“é…ç½®
  â”œâ”€â†’ å­è¿›ç¨‹ 4ï¼ˆbinance_spotï¼‰ï¼šåªåŠ è½½ Binance ç°è´§é…ç½®
  â””â”€â†’ å­è¿›ç¨‹ 5ï¼ˆderibit_derivativesï¼‰ï¼šåªåŠ è½½ Deribit è¡ç”Ÿå“é…ç½®
```

**é…ç½®è¿‡æ»¤é€»è¾‘**ï¼ˆåœ¨ main.py ä¸­å®ç°ï¼‰ï¼š
```python
def filter_config_by_exchange(config: dict, exchange: str) -> dict:
    """æ ¹æ®äº¤æ˜“æ‰€åç§°è¿‡æ»¤é…ç½®"""
    filtered_config = copy.deepcopy(config)
    filtered_config['exchanges'] = {
        k: v for k, v in config['exchanges'].items()
        if k == exchange
    }
    return filtered_config
```

### ç»“è®º

âœ… **æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶**
- ä¿æŒå”¯ä¸€é…ç½®æ–‡ä»¶
- é…ç½®è¿‡æ»¤åœ¨ä»£ç ä¸­å®ç°
- ç¬¦åˆ"å•ä¸€é…ç½®"åŸåˆ™

---

## 4ï¸âƒ£ å¯åŠ¨æ–¹å¼åˆ†æ

### å½“å‰å¯åŠ¨æ–¹å¼

**Docker æ–¹å¼**ï¼š
```bash
docker compose -f docker-compose.unified.yml up -d
```

**ç›´æ¥è¿è¡Œæ–¹å¼**ï¼š
```bash
python main.py --mode launcher
```

### å¤šè¿›ç¨‹æ¶æ„çš„å¯åŠ¨æ–¹å¼

**Docker æ–¹å¼ï¼ˆé»˜è®¤å¤šè¿›ç¨‹ï¼‰**ï¼š
```bash
docker compose -f docker-compose.unified.yml up -d
```

**ç›´æ¥è¿è¡Œæ–¹å¼ï¼ˆé»˜è®¤å¤šè¿›ç¨‹ï¼‰**ï¼š
```bash
python main.py --mode launcher
```

**é™çº§åˆ°å•è¿›ç¨‹ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰**ï¼š
```bash
python main.py --mode launcher --single-process
```

**å•ä¸ªäº¤æ˜“æ‰€æµ‹è¯•ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰**ï¼š
```bash
python main.py --mode launcher --exchange okx_derivatives
```

### ç»“è®º

âœ… **å®Œå…¨å‘åå…¼å®¹**
- é»˜è®¤å¯ç”¨å¤šè¿›ç¨‹
- æ”¯æŒé™çº§åˆ°å•è¿›ç¨‹
- æ”¯æŒå•ä¸ªäº¤æ˜“æ‰€æµ‹è¯•

---

## 5ï¸âƒ£ ç›‘æ§å’Œå¥åº·æ£€æŸ¥åˆ†æ

### å½“å‰æ¥å£

- `http://localhost:8087/health` - å¥åº·æ£€æŸ¥
- `http://localhost:9092/metrics` - Prometheus æŒ‡æ ‡

### å¤šè¿›ç¨‹æ¶æ„çš„æ¥å£

**ä¸»è¿›ç¨‹è¡Œä¸º**ï¼š
- èšåˆæ‰€æœ‰å­è¿›ç¨‹çš„å¥åº·çŠ¶æ€
- èšåˆæ‰€æœ‰å­è¿›ç¨‹çš„æŒ‡æ ‡
- å“åº”æ ¼å¼ä¿æŒå…¼å®¹ï¼Œå¢åŠ å­è¿›ç¨‹è¯¦æƒ…

**å¥åº·æ£€æŸ¥å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "healthy",
  "uptime_seconds": 3600,
  "mode": "multiprocess",
  "processes": {
    "okx_derivatives": {
      "status": "healthy",
      "cpu_percent": 32.5,
      "memory_mb": 145,
      "uptime_seconds": 3600
    },
    "okx_spot": {
      "status": "healthy",
      "cpu_percent": 28.1,
      "memory_mb": 115,
      "uptime_seconds": 3600
    },
    "binance_derivatives": {
      "status": "healthy",
      "cpu_percent": 22.3,
      "memory_mb": 95,
      "uptime_seconds": 3600
    },
    "binance_spot": {
      "status": "healthy",
      "cpu_percent": 18.7,
      "memory_mb": 75,
      "uptime_seconds": 3600
    },
    "deribit_derivatives": {
      "status": "healthy",
      "cpu_percent": 8.2,
      "memory_mb": 55,
      "uptime_seconds": 3600
    }
  },
  "services": {
    /* ç°æœ‰æ ¼å¼ä¿æŒä¸å˜ */
  }
}
```

**Prometheus æŒ‡æ ‡å¢å¼º**ï¼š
```
# ç°æœ‰æŒ‡æ ‡ä¿æŒä¸å˜
marketprism_cpu_usage_percent 47.0
marketprism_data_count_total{exchange="okx_spot",data_type="orderbook"} 12345

# æ–°å¢å­è¿›ç¨‹æŒ‡æ ‡
marketprism_process_cpu_percent{process="okx_derivatives"} 32.5
marketprism_process_memory_mb{process="okx_derivatives"} 145
marketprism_process_uptime_seconds{process="okx_derivatives"} 3600
marketprism_process_status{process="okx_derivatives",status="healthy"} 1
```

### ç»“è®º

âœ… **æ¥å£å®Œå…¨å…¼å®¹**
- ç°æœ‰ç›‘æ§ç³»ç»Ÿæ— éœ€ä¿®æ”¹
- å¢åŠ å­è¿›ç¨‹è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
- Prometheus æŒ‡æ ‡å‘åå…¼å®¹

---

## 6ï¸âƒ£ æ—¥å¿—å’Œè°ƒè¯•åˆ†æ

### å½“å‰æ—¥å¿—

- å•ä¸€æ—¥å¿—æ–‡ä»¶ï¼š`logs/unified-collector.log`

### å¤šè¿›ç¨‹æ¶æ„çš„æ—¥å¿—

| æ—¥å¿—æ–‡ä»¶ | å†…å®¹ |
|---------|------|
| `logs/collector_main.log` | ä¸»è¿›ç¨‹æ—¥å¿— + æ‰€æœ‰å­è¿›ç¨‹çš„å…³é”®äº‹ä»¶ |
| `logs/collector_okx_derivatives.log` | OKX è¡ç”Ÿå“å­è¿›ç¨‹æ—¥å¿— |
| `logs/collector_okx_spot.log` | OKX ç°è´§å­è¿›ç¨‹æ—¥å¿— |
| `logs/collector_binance_derivatives.log` | Binance è¡ç”Ÿå“å­è¿›ç¨‹æ—¥å¿— |
| `logs/collector_binance_spot.log` | Binance ç°è´§å­è¿›ç¨‹æ—¥å¿— |
| `logs/collector_deribit_derivatives.log` | Deribit è¡ç”Ÿå“å­è¿›ç¨‹æ—¥å¿— |
| `logs/unified-collector.log` | è½¯é“¾æ¥åˆ° `collector_main.log`ï¼ˆå‘åå…¼å®¹ï¼‰ |

**æ—¥å¿—æ ¼å¼å¢å¼º**ï¼š
```
[2025-10-22 10:30:45] [okx_derivatives] [INFO] OrderBook updated: BTC-USDT
[2025-10-22 10:30:45] [okx_spot] [INFO] Trade received: ETH-USDT
[2025-10-22 10:30:46] [main] [INFO] All processes healthy
```

### ç»“è®º

âœ… **æ—¥å¿—æ›´è¯¦ç»†ï¼Œä½†ä¿æŒå‘åå…¼å®¹**
- æ¯ä¸ªå­è¿›ç¨‹ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶
- ä¸»è¿›ç¨‹æ—¥å¿—èšåˆå…³é”®äº‹ä»¶
- ä¿ç•™ `unified-collector.log` è½¯é“¾æ¥

---

## 7ï¸âƒ£ èµ„æºé™åˆ¶ç­–ç•¥

### å†…å­˜é™åˆ¶ï¼ˆè½¯é™åˆ¶ + ç¡¬é™åˆ¶ï¼‰

| è¿›ç¨‹ | å†…å­˜è½¯é™åˆ¶ | å†…å­˜ç¡¬é™åˆ¶ | è§¦å‘åŠ¨ä½œ |
|------|-----------|-----------|----------|
| okx_derivatives | 150MB | 200MB | è½¯é™åˆ¶ï¼šå‘Šè­¦ï¼›ç¡¬é™åˆ¶ï¼šé‡å¯ |
| okx_spot | 120MB | 160MB | è½¯é™åˆ¶ï¼šå‘Šè­¦ï¼›ç¡¬é™åˆ¶ï¼šé‡å¯ |
| binance_derivatives | 100MB | 140MB | è½¯é™åˆ¶ï¼šå‘Šè­¦ï¼›ç¡¬é™åˆ¶ï¼šé‡å¯ |
| binance_spot | 80MB | 120MB | è½¯é™åˆ¶ï¼šå‘Šè­¦ï¼›ç¡¬é™åˆ¶ï¼šé‡å¯ |
| deribit_derivatives | 60MB | 100MB | è½¯é™åˆ¶ï¼šå‘Šè­¦ï¼›ç¡¬é™åˆ¶ï¼šé‡å¯ |
| **æ€»è®¡** | **510MB** | **720MB** | è¿œä½äº Docker é™åˆ¶ï¼ˆ4GBï¼‰ |

### OOM é¢„é˜²æœºåˆ¶

1. **è½¯é™åˆ¶è§¦å‘**ï¼š
   - è®°å½•è­¦å‘Šæ—¥å¿—
   - å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
   - ä¸å½±å“è¿›ç¨‹è¿è¡Œ

2. **ç¡¬é™åˆ¶è§¦å‘**ï¼š
   - ä¼˜é›…åœæ­¢è¿›ç¨‹
   - ç­‰å¾… 5 ç§’å†·å´
   - è‡ªåŠ¨é‡å¯è¿›ç¨‹

3. **Docker OOM é¢„é˜²**ï¼š
   - ç¡¬é™åˆ¶æ€»å’Œï¼ˆ720MBï¼‰è¿œä½äº Docker é™åˆ¶ï¼ˆ4GBï¼‰
   - ç•™æœ‰ 3.3GB ä½™é‡
   - ç¡®ä¿åœ¨è¾¾åˆ°ç³»ç»Ÿ OOM ä¹‹å‰ä¸»åŠ¨é‡å¯

---

## 8ï¸âƒ£ é£é™©è¯„ä¼°

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|------|----------|------|
| ç«¯å£å†²çª | ä¸­ | ä½ | å­è¿›ç¨‹ä¸éœ€è¦ç‹¬ç«‹ç«¯å£ | âœ… å·²è§„é¿ |
| å†…å­˜ OOM | é«˜ | ä½ | è½¯/ç¡¬é™åˆ¶ + ä¸»åŠ¨é‡å¯ | âœ… å·²è§„é¿ |
| Docker èµ„æºä¸è¶³ | ä¸­ | ä½ | è°ƒæ•´å†…å­˜é™åˆ¶ä¸º 4GB | âœ… å·²è§„é¿ |
| è°ƒè¯•å¤æ‚åº¦å¢åŠ  | ä¸­ | é«˜ | ç‹¬ç«‹æ—¥å¿— + è°ƒè¯•å·¥å…· | âš ï¸ éœ€å®æ–½ |
| éƒ¨ç½²å¤æ‚åº¦å¢åŠ  | ä¸­ | ä¸­ | ä¿ç•™å•è¿›ç¨‹æ¨¡å¼ + ç°åº¦å‘å¸ƒ | âš ï¸ éœ€å®æ–½ |
| IPC é€šä¿¡ç“¶é¢ˆ | ä½ | ä½ | å¼‚æ­¥éé˜»å¡ + æ‰¹é‡å‘é€ | âœ… å·²è§„é¿ |

---

## 9ï¸âƒ£ æ€»ç»“

### âœ… å…¼å®¹æ€§ç»“è®º

**æ— æ¶æ„å†²çª**ï¼Œä»…éœ€å°å¹…è°ƒæ•´ï¼š

1. **Docker é…ç½®**ï¼š
   - `mem_limit: 3G â†’ 4G`
   - `mem_reservation: 512M â†’ 1G`

2. **å…¶ä»–æ–¹é¢**ï¼š
   - âœ… ç«¯å£åˆ†é…ï¼šæ— éœ€ä¿®æ”¹
   - âœ… é…ç½®æ–‡ä»¶ï¼šæ— éœ€ä¿®æ”¹
   - âœ… å¯åŠ¨æ–¹å¼ï¼šå®Œå…¨å…¼å®¹
   - âœ… ç›‘æ§æ¥å£ï¼šå®Œå…¨å…¼å®¹
   - âœ… æ—¥å¿—æ ¼å¼ï¼šå‘åå…¼å®¹

### ğŸ“Š é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ï¼ˆPhase 1ï¼‰ | ç›®æ ‡ï¼ˆPhase 2ï¼‰ | æ”¹å–„å¹…åº¦ |
|------|----------------|----------------|----------|
| CPU å ç”¨ç‡ | 103.86% | 80-90% | â†“ 15-20% |
| å•æ ¸å¿ƒå³°å€¼ | 100% | 60-70% | â†“ 30-40% |
| å†…å­˜å ç”¨ | 418.8MB | 720MB | â†‘ 72% |
| æ•°æ®å»¶è¿Ÿ | 0.17-0.30ms | 0.12-0.25ms | â†“ 20-30% |
| P99 å»¶è¿Ÿ | 5-10ms | 2-5ms | â†“ 40-50% |

### ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **æ¶æ„è®¾è®¡å®Œæˆ**ï¼ˆæœ¬æŠ¥å‘Šï¼‰
2. â³ **å¼€å§‹é˜¶æ®µ 2**ï¼šæ ¸å¿ƒç»„ä»¶å¼€å‘
3. â³ **å¼€å§‹é˜¶æ®µ 3**ï¼šä¸»è¿›ç¨‹æ”¹é€ 
4. â³ **å¼€å§‹é˜¶æ®µ 4**ï¼šæµ‹è¯•ä¸éªŒè¯
5. â³ **å¼€å§‹é˜¶æ®µ 5**ï¼šéƒ¨ç½²ä¸ç›‘æ§

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-10-22
**åˆ›å»ºäºº**ï¼šAugment Agent
**çŠ¶æ€**ï¼šå·²å®Œæˆ

