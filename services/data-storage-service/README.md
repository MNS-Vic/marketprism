# MarketPrism åˆ†å±‚æ•°æ®å­˜å‚¨æœåŠ¡

MarketPrismçš„åˆ†å±‚æ•°æ®å­˜å‚¨æ¶æ„ï¼Œå®ç°çƒ­ç«¯å®æ—¶å­˜å‚¨å’Œå†·ç«¯å½’æ¡£å­˜å‚¨ï¼Œæ”¯æŒæ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

### åˆ†å±‚å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®æ”¶é›†å™¨     â”‚â”€â”€â”€â–¶â”‚   NATSé˜Ÿåˆ—      â”‚â”€â”€â”€â–¶â”‚   çƒ­ç«¯å­˜å‚¨      â”‚
â”‚  (Data Collector)â”‚    â”‚  (Message Queue)â”‚    â”‚  (Hot Storage)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å†·ç«¯å­˜å‚¨      â”‚â—€â”€â”€â”€â”‚   æ•°æ®åŒæ­¥      â”‚â—€â”€â”€â”€â”‚   å®šæ—¶è°ƒåº¦      â”‚
â”‚  (Cold Storage) â”‚    â”‚  (Data Sync)    â”‚    â”‚  (Scheduler)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

1. **å®æ—¶æ•°æ®æ”¶é›†** â†’ **NATS JetStream** â†’ **çƒ­ç«¯ClickHouse**
2. **å®šæ—¶åŒæ­¥ä»»åŠ¡** â†’ **çƒ­ç«¯ClickHouse** â†’ **å†·ç«¯ClickHouse**
3. **æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†** â†’ **çƒ­ç«¯æ•°æ®æ¸…ç†**

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Docker & Docker Compose
- Python 3.11+
- ClickHouse 23.8+
- NATS 2.10+

### 2. é…ç½®æ–‡ä»¶

å¤åˆ¶å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
cp config/tiered_storage_config.yaml.example config/tiered_storage_config.yaml
```

å…³é”®é…ç½®é¡¹ï¼š

```yaml
# çƒ­ç«¯å­˜å‚¨é…ç½®ï¼ˆè¿œç¨‹æœåŠ¡å™¨ï¼‰
hot_storage:
  clickhouse_host: "clickhouse-hot"
  clickhouse_database: "marketprism_hot"
  retention_days: 3

# å†·ç«¯å­˜å‚¨é…ç½®ï¼ˆæœ¬åœ°NASï¼‰
cold_storage:
  clickhouse_host: "192.168.1.100"  # æœ¬åœ°NAS IP
  clickhouse_database: "marketprism_cold"
  retention_days: 365
```

### 3. éƒ¨ç½²æ–¹å¼

#### æ–¹å¼1ï¼šDocker Composeï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨çƒ­ç«¯å­˜å‚¨æœåŠ¡
docker-compose -f docker-compose.tiered-storage.yml up hot-storage-service

# å¯åŠ¨å†·ç«¯å½’æ¡£æœåŠ¡ï¼ˆåœ¨æœ¬åœ°NASä¸Šï¼‰
docker-compose -f docker-compose.tiered-storage.yml --profile local-nas up cold-storage-service

# å¯åŠ¨å®Œæ•´æœåŠ¡æ ˆ
docker-compose -f docker-compose.tiered-storage.yml up
```

#### æ–¹å¼2ï¼šç›´æ¥è¿è¡Œ

```bash
# çƒ­ç«¯å­˜å‚¨æœåŠ¡
python tiered_storage_main.py --mode hot --config config/tiered_storage_config.yaml

# å†·ç«¯å½’æ¡£æœåŠ¡
python tiered_storage_main.py --mode cold --config config/tiered_storage_config.yaml

# åŒæ—¶è¿è¡Œä¸¤ä¸ªæœåŠ¡
python tiered_storage_main.py --mode both --config config/tiered_storage_config.yaml
```

## ğŸ“Š æœåŠ¡ç»„ä»¶

### 1. çƒ­ç«¯æ•°æ®å­˜å‚¨æœåŠ¡ (Hot Storage Service)

**åŠŸèƒ½**ï¼š
- ä»NATS JetStreamè®¢é˜…å®æ—¶é‡‘èæ•°æ®
- å°†æ•°æ®å†™å…¥è¿œç¨‹æœåŠ¡å™¨çš„ClickHouseçƒ­ç«¯æ•°æ®åº“
- æ”¯æŒ7ç§æ•°æ®ç±»å‹ï¼šorderbook, trades, funding_rate, open_interest, liquidation, lsr, volatility_index

**ç‰¹ç‚¹**ï¼š
- é«˜é¢‘å®æ—¶å†™å…¥
- çŸ­æœŸæ•°æ®ä¿ç•™ï¼ˆ2-3å¤©ï¼‰
- ä¼˜åŒ–çš„æ‰¹é‡å†™å…¥æ€§èƒ½

### 2. å†·ç«¯æ•°æ®å½’æ¡£æœåŠ¡ (Cold Storage Service)

**åŠŸèƒ½**ï¼š
- å®šæ—¶ä»çƒ­ç«¯ClickHouseåŒæ­¥å†å²æ•°æ®
- å°†æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°NASçš„ClickHouseå†·ç«¯æ•°æ®åº“
- å®ç°æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ç‰¹ç‚¹**ï¼š
- å®šæ—¶æ‰¹é‡åŒæ­¥
- é•¿æœŸæ•°æ®ä¿ç•™ï¼ˆ1å¹´+ï¼‰
- æ•°æ®å®Œæ•´æ€§éªŒè¯

### 3. åˆ†å±‚å­˜å‚¨ç®¡ç†å™¨ (Tiered Storage Manager)

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€ç®¡ç†çƒ­ç«¯å’Œå†·ç«¯å­˜å‚¨
- æ•°æ®ä¼ è¾“ä»»åŠ¡è°ƒåº¦å’Œç›‘æ§
- å­˜å‚¨å±‚çº§é—´çš„æ•°æ®è¿ç§»

**ç‰¹ç‚¹**ï¼š
- å¼‚æ­¥ä»»åŠ¡å¤„ç†
- å¤±è´¥é‡è¯•æœºåˆ¶
- å®Œæ•´çš„çŠ¶æ€ç›‘æ§

## ğŸ”§ é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®é¡¹

```yaml
# NATSé…ç½®
nats:
  url: "nats://nats:4222"
  max_reconnect_attempts: 10

# çƒ­ç«¯å­˜å‚¨é…ç½®
hot_storage:
  clickhouse_host: "clickhouse-hot"
  retention_days: 3
  batch_size: 1000

# å†·ç«¯å­˜å‚¨é…ç½®
cold_storage:
  clickhouse_host: "192.168.1.100"
  retention_days: 365
  batch_size: 5000

# åŒæ­¥é…ç½®
sync:
  interval_hours: 6
  batch_hours: 24
  cleanup_enabled: true
```

### ç¯å¢ƒå˜é‡

```bash
# è¿è¡Œæ¨¡å¼
STORAGE_MODE=hot|cold|both

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=DEBUG|INFO|WARNING|ERROR

# ç¯å¢ƒ
ENVIRONMENT=development|staging|production
```

## ğŸ“ˆ ç›‘æ§å’Œè¿ç»´

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥çƒ­ç«¯æœåŠ¡
curl http://localhost:8085/health

# æ£€æŸ¥å†·ç«¯æœåŠ¡
curl http://localhost:8086/health
```

### ç»Ÿè®¡ä¿¡æ¯

```bash
# è·å–æœåŠ¡ç»Ÿè®¡
curl http://localhost:8085/stats

# è·å–ä¼ è¾“ä»»åŠ¡çŠ¶æ€
curl http://localhost:8085/transfer-tasks
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹çƒ­ç«¯æœåŠ¡æ—¥å¿—
docker logs marketprism-hot-storage

# æŸ¥çœ‹å†·ç«¯æœåŠ¡æ—¥å¿—
docker logs marketprism-cold-storage
```

## ğŸ”„ æ•°æ®åŒæ­¥æµç¨‹

### è‡ªåŠ¨åŒæ­¥

ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹åŒæ­¥æµç¨‹ï¼š

1. **å®šæ—¶è§¦å‘**ï¼šæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡åŒæ­¥
2. **æ•°æ®æŸ¥è¯¢**ï¼šä»çƒ­ç«¯ClickHouseæŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´çš„æ•°æ®
3. **æ•°æ®ä¼ è¾“**ï¼šå°†æ•°æ®æ‰¹é‡å†™å…¥å†·ç«¯ClickHouse
4. **å®Œæ•´æ€§éªŒè¯**ï¼šéªŒè¯ä¼ è¾“æ•°æ®çš„å®Œæ•´æ€§
5. **æ¸…ç†çƒ­ç«¯**ï¼šå¯é€‰æ‹©æ€§æ¸…ç†å·²åŒæ­¥çš„çƒ­ç«¯æ•°æ®

### æ‰‹åŠ¨åŒæ­¥

```python
# è°ƒåº¦å•ä¸ªä¼ è¾“ä»»åŠ¡
task_id = await storage_manager.schedule_data_transfer(
    data_type="orderbook",
    exchange="binance_spot", 
    symbol="BTC-USDT",
    start_time=start_time,
    end_time=end_time
)

# æ‰¹é‡è‡ªåŠ¨åŒæ­¥
task_ids = await storage_manager.auto_schedule_transfers(
    lookback_hours=24
)
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ•°æ®ç±»å‹

1. åœ¨`TieredStorageManager`ä¸­æ·»åŠ æ•°æ®ç±»å‹æ”¯æŒ
2. æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹åˆ—è¡¨
3. ç¡®ä¿æ•°æ®æ ‡å‡†åŒ–å™¨æ”¯æŒæ–°ç±»å‹

### è‡ªå®šä¹‰åŒæ­¥ç­–ç•¥

1. ç»§æ‰¿`DataSyncTask`ç±»
2. å®ç°è‡ªå®šä¹‰çš„åŒæ­¥é€»è¾‘
3. åœ¨é…ç½®ä¸­æŒ‡å®šè‡ªå®šä¹‰ä»»åŠ¡ç±»

### æ‰©å±•å­˜å‚¨åç«¯

1. å®ç°æ–°çš„å­˜å‚¨å†™å…¥å™¨
2. åœ¨`TieredStorageManager`ä¸­é›†æˆ
3. æ›´æ–°é…ç½®æ¶æ„

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ClickHouseæœåŠ¡çŠ¶æ€
   - éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤è®¤è¯ä¿¡æ¯æ­£ç¡®

2. **åŒæ­¥å¤±è´¥**
   - æŸ¥çœ‹ä¼ è¾“ä»»åŠ¡çŠ¶æ€
   - æ£€æŸ¥ç£ç›˜ç©ºé—´
   - éªŒè¯æ•°æ®æ ¼å¼

3. **æ€§èƒ½é—®é¢˜**
   - è°ƒæ•´æ‰¹é‡å¤§å°
   - ä¼˜åŒ–ç½‘ç»œé…ç½®
   - ç›‘æ§èµ„æºä½¿ç”¨

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥æ‰¾é”™è¯¯æ—¥å¿—
grep "ERROR" /app/logs/*.log

# ç›‘æ§åŒæ­¥è¿›åº¦
grep "ä¼ è¾“ä»»åŠ¡" /app/logs/*.log

# æ€§èƒ½åˆ†æ
grep "duration" /app/logs/*.log
```

## ğŸ“‹ æœ€ä½³å®è·µ

### éƒ¨ç½²å»ºè®®

1. **çƒ­ç«¯æœåŠ¡**ï¼šéƒ¨ç½²åœ¨é è¿‘æ•°æ®æ”¶é›†å™¨çš„æœåŠ¡å™¨ä¸Š
2. **å†·ç«¯æœåŠ¡**ï¼šéƒ¨ç½²åœ¨æœ¬åœ°NASæˆ–ä¸“ç”¨å­˜å‚¨æœåŠ¡å™¨ä¸Š
3. **ç½‘ç»œä¼˜åŒ–**ï¼šç¡®ä¿çƒ­ç«¯å’Œå†·ç«¯ä¹‹é—´æœ‰ç¨³å®šçš„ç½‘ç»œè¿æ¥
4. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®å…³é”®æŒ‡æ ‡çš„ç›‘æ§å’Œå‘Šè­¦

### æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡å¤§å°**ï¼šæ ¹æ®ç½‘ç»œå’Œå­˜å‚¨æ€§èƒ½è°ƒæ•´æ‰¹é‡å¤§å°
2. **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶å¹¶å‘ä¼ è¾“ä»»åŠ¡æ•°é‡
3. **å‹ç¼©ä¼ è¾“**ï¼šå¯ç”¨æ•°æ®å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨ClickHouseä¸­åˆ›å»ºåˆé€‚çš„ç´¢å¼•

### å®‰å…¨è€ƒè™‘

1. **ç½‘ç»œå®‰å…¨**ï¼šä½¿ç”¨VPNæˆ–ä¸“ç”¨ç½‘ç»œè¿æ¥
2. **æ•°æ®åŠ å¯†**ï¼šå¯ç”¨ä¼ è¾“å’Œå­˜å‚¨åŠ å¯†
3. **è®¿é—®æ§åˆ¶**ï¼šé…ç½®é€‚å½“çš„ç”¨æˆ·æƒé™
4. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½é‡è¦é…ç½®å’Œæ•°æ®

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»MarketPrismå¼€å‘å›¢é˜Ÿæˆ–æäº¤Issueã€‚
