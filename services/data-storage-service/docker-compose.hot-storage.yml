# MarketPrism Data Storage Service - çƒ­å­˜å‚¨Docker Composeé…ç½®
# ğŸ”„ Dockeréƒ¨ç½²ç®€åŒ–æ”¹é€ ç‰ˆæœ¬ (2025-08-02)
#
# ç®€åŒ–æ”¹é€ å†…å®¹:
# - âœ… ä¸“æ³¨çƒ­å­˜å‚¨æœåŠ¡: ä»NATSè®¢é˜…æ•°æ®å­˜å…¥ClickHouse
# - âœ… æ”¯æŒ8ç§æ•°æ®ç±»å‹: orderbook, trade, funding_rate, open_interest, liquidation, lsr_top_position, lsr_all_account, volatility_index
# - âœ… ä¼˜åŒ–ClickHouseé…ç½®: åˆ†ç¦»LSRè¡¨ï¼Œä¼˜åŒ–åˆ†åŒºå’Œç´¢å¼•
# - âœ… ç®€åŒ–ç½‘ç»œé…ç½®: hostç½‘ç»œæ¨¡å¼ï¼Œç›´æ¥è¿æ¥ç»Ÿä¸€NATSå®¹å™¨
# - âœ… è‡ªåŠ¨å»ºè¡¨: å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºClickHouseè¡¨ç»“æ„
#
# ä½¿ç”¨æ–¹æ³•:
# 1. å…ˆå¯åŠ¨ç»Ÿä¸€NATS: cd ../message-broker/unified-nats && docker-compose up -d
# 2. å†å¯åŠ¨Data Collector: cd ../data-collector && docker-compose up -d
# 3. æœ€åå¯åŠ¨Hot Storage: docker-compose -f docker-compose.hot-storage.yml up -d



services:
  # ClickHouseçƒ­å­˜å‚¨æ•°æ®åº“
  clickhouse-hot:
    image: clickhouse/clickhouse-server:23.8-alpine
    container_name: marketprism-clickhouse-hot
    hostname: clickhouse-hot
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"   # HTTPç«¯å£
      - "${CLICKHOUSE_TCP_PORT:-9000}:9000"    # TCPç«¯å£
    environment:
      - CLICKHOUSE_DB=${CLICKHOUSE_DATABASE:-marketprism_hot}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse_hot_data:/var/lib/clickhouse
      - ./config/clickhouse_schema.sql:/docker-entrypoint-initdb.d/init.sql
      - ./config/clickhouse-config.xml:/etc/clickhouse-server/config.d/custom.xml
    networks:
      - marketprism
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    # èµ„æºé™åˆ¶ (ä½¿ç”¨Docker Compose v1å…¼å®¹è¯­æ³•)
    mem_limit: 2G
    cpus: 1.0
    mem_reservation: 512M

  # çƒ­å­˜å‚¨æœåŠ¡
  hot-storage-service:
    build:
      context: .
      dockerfile: Dockerfile.production
    image: marketprism/hot-storage-service:latest
    container_name: marketprism-hot-storage-service
    hostname: hot-storage-service
    command: ["python", "services/data-storage-service/jetstream_pure_hot_storage.py"]

    environment:
      # åŸºç¡€é…ç½®
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1

      # NATSé…ç½®ï¼ˆæœåŠ¡ä»£ç å®é™…è¯»å–çš„å˜é‡åï¼‰
      - NATS_URL=${MARKETPRISM_NATS_URL:-nats://host.docker.internal:4222}
      - MARKETPRISM_NATS_ENABLED=true

      # ClickHouseé…ç½®ï¼ˆæœåŠ¡ä»£ç ä½¿ç”¨ CLICKHOUSE_* å˜é‡ï¼‰
      - CLICKHOUSE_HOST=clickhouse-hot
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE:-marketprism_hot}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      # å…¼å®¹å…¥å£è„šæœ¬ç­‰å¾…ClickHouseçš„å˜é‡ï¼ˆä»…ç”¨äºå¥åº·ç­‰å¾…ï¼Œä¸å½±å“åº”ç”¨å†…è¯»å–ï¼‰
      - CLICKHOUSE_HTTP_PORT=8123

      # æœåŠ¡é…ç½®
      - MARKETPRISM_STORAGE_SERVICE_PORT=8080
      - MARKETPRISM_STORAGE_SERVICE_HOST=0.0.0.0

      # JetStream Pull è°ƒä¼˜å‚æ•°
      - JS_PULL_BATCH_SIZE=${JS_PULL_BATCH_SIZE:-100}
      - JS_PULL_CONCURRENCY=${JS_PULL_CONCURRENCY:-3}

      # LSR ç»Ÿä¸€é…ç½®ï¼ˆä½œä¸ºæƒå¨æ¥æºä¼ å…¥å®¹å™¨ï¼‰
      - LSR_DELIVER_POLICY=${LSR_DELIVER_POLICY:-last}
      - LSR_ACK_POLICY=${LSR_ACK_POLICY:-explicit}
      - LSR_ACK_WAIT=${LSR_ACK_WAIT:-60}
      - LSR_MAX_DELIVER=${LSR_MAX_DELIVER:-3}
      - LSR_MAX_ACK_PENDING=${LSR_MAX_ACK_PENDING:-2000}
    ports:
      - "18080:8080"  # å¥åº·æ£€æŸ¥å’ŒAPIç«¯å£ï¼ˆä¸»æœºâ†’å®¹å™¨ï¼‰
    depends_on:
      clickhouse-hot:
        condition: service_healthy
    networks:
      - marketprism
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      # NOTE: å®¹å™¨å†…ç›‘å¬çš„æ˜¯ 8080ï¼Œ18080 æ˜¯å®¿ä¸»æœºæ˜ å°„ç«¯å£ï¼›å¥åº·æ£€æŸ¥å¿…é¡»è®¿é—®å®¹å™¨å†… 8080
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    # èµ„æºé™åˆ¶ (ä½¿ç”¨Docker Compose v1å…¼å®¹è¯­æ³•)
    mem_limit: 1G
    cpus: 0.5
    mem_reservation: 256M

# ç½‘ç»œé…ç½®
networks:
  marketprism:
    driver: bridge


# æ•°æ®å·é…ç½®
volumes:
  clickhouse_hot_data:
    driver: local
    name: marketprism-clickhouse-hot-data

# ç¯å¢ƒå˜é‡è¯´æ˜:
# - CLICKHOUSE_DATABASE: ClickHouseæ•°æ®åº“å (é»˜è®¤: marketprism_hot)
# - CLICKHOUSE_USER: ClickHouseç”¨æˆ·å (é»˜è®¤: default)
# - CLICKHOUSE_PASSWORD: ClickHouseå¯†ç  (é»˜è®¤: ç©º)
# - MARKETPRISM_NATS_SERVERS: NATSæœåŠ¡å™¨åœ°å€ (é»˜è®¤: nats://localhost:4222)
# - LOG_LEVEL: æ—¥å¿—çº§åˆ« (é»˜è®¤: INFO)
