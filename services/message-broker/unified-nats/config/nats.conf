# MarketPrism NATS Server 配置文件
# 🔄 Docker部署简化改造版本 (2025-08-02)

# 服务器基本配置
server_name: "marketprism-nats-unified"
host: "0.0.0.0"
port: 4222

# HTTP监控端口
http_port: 8222

# 日志配置
log_file: "/var/log/nats/nats.log"
logtime: true
debug: false
trace: false

# 连接配置
max_connections: 64K
max_control_line: 4KB
max_payload: 1MB
max_pending: 64MB
ping_interval: "2m"
ping_max: 2

# 写入超时配置
write_deadline: "10s"

# 认证配置（开发环境暂时关闭）
# authorization {
#     user: "marketprism"
#     password: "your_secure_password"
# }

# JetStream配置
jetstream {
    # 存储目录
    store_dir: "/data/jetstream"
    
    # 最大内存使用
    max_memory_store: 1GB
    
    # 最大文件存储
    max_file_store: 10GB
    
    # 域配置
    domain: "marketprism"
}

# 集群配置（单节点模式）
cluster {
    name: "marketprism-cluster"
    host: "0.0.0.0"
    port: 6222
    
    # 路由配置
    routes = [
        # nats-route://nats-1:6222
        # nats-route://nats-2:6222
    ]
    
    # 集群认证
    # authorization {
    #     user: "cluster_user"
    #     password: "cluster_password"
    # }
}

# 系统账户配置
system_account: "$SYS"

# 账户配置
accounts {
    # 系统账户
    $SYS {
        users = [
            { user: "admin", pass: "admin" }
        ]
    }
    
    # MarketPrism应用账户
    MARKETPRISM {
        users = [
            { 
                user: "marketprism_user", 
                pass: "marketprism_pass",
                permissions: {
                    publish: {
                        allow: [">"]
                    }
                    subscribe: {
                        allow: [">"]
                    }
                }
            }
        ]
        
        # JetStream配置
        jetstream: {
            max_memory: 512MB
            max_file: 5GB
            max_streams: 100
            max_consumers: 1000
        }
    }
}

# 默认账户
no_auth_user: "marketprism_user"

# 性能优化配置
# 最大订阅数
max_subscriptions: 0

# 最大负载
max_payload: 1MB

# 慢消费者配置
slow_consumer_threshold: "1s"

# 监控配置
monitoring {
    # HTTP监控端点
    http_port: 8222
    
    # 监控路径
    # /varz - 服务器变量
    # /connz - 连接信息
    # /routez - 路由信息
    # /subsz - 订阅信息
    # /stacksz - 堆栈信息
}

# 限制配置
limits {
    # 最大连接数
    max_connections: 64K
    
    # 最大订阅数
    max_subscriptions: 0
    
    # 最大负载
    max_payload: 1MB
    
    # 最大控制行
    max_control_line: 4KB
    
    # 最大挂起字节数
    max_pending: 64MB
}

# TLS配置（生产环境启用）
# tls {
#     cert_file: "/etc/nats/certs/server.crt"
#     key_file: "/etc/nats/certs/server.key"
#     ca_file: "/etc/nats/certs/ca.crt"
#     verify: true
#     timeout: 5
# }

# 网关配置（多集群连接）
# gateway {
#     name: "marketprism-gateway"
#     host: "0.0.0.0"
#     port: 7222
#     
#     gateways: [
#         {
#             name: "remote-cluster"
#             urls: ["nats://remote-nats:7222"]
#         }
#     ]
# }

# Leaf节点配置（边缘节点）
# leafnodes {
#     host: "0.0.0.0"
#     port: 7422
#     
#     remotes: [
#         {
#             url: "nats://hub-nats:7422"
#         }
#     ]
# }

# WebSocket配置
# websocket {
#     host: "0.0.0.0"
#     port: 8080
#     no_tls: true
# }

# 调试和开发配置
# debug: true
# trace: true
# logtime: true
# log_file: "/var/log/nats/nats.log"

# 优雅关闭配置
# lame_duck_duration: "2m"
# lame_duck_grace_period: "10s"
