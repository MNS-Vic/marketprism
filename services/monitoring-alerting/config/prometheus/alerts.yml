groups:
  - name: marketprism-core
    rules:
      - alert: BrokerDown
        expr: marketprism_broker_connected == 0
        for: 30s
        labels:
          severity: critical
          service: message-broker
        annotations:
          summary: Message Broker disconnected
          description: Broker connection status is 0 for more than 30s.

      - alert: HotInsertErrorsHigh
        expr: rate(marketprism_storage_clickhouse_insert_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: ClickHouse insert errors increasing
          description: ClickHouse insert error rate > 0 in the last 5 minutes.

      - alert: HotErrorRateHigh
        expr: marketprism_storage_error_rate_percent > 5
        for: 5m
        labels:
          severity: warning
          service: hot-storage
        annotations:
          summary: Hot storage error rate high
          description: marketprism_storage_error_rate_percent > 5 for 5 minutes.

      - alert: ColdReplicationLagHigh
        expr: max(marketprism_cold_replication_lag_minutes) > 15
        for: 10m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: Cold storage replication lag high
          description: Any table replication lag_minutes > 15 for 10 minutes.

      - alert: BatchQueueBacklogHigh
        expr: max(marketprism_storage_batch_queue_size) > 1000
        for: 10m
        labels:
          severity: warning
          service: hot-storage
        annotations:
          summary: Hot storage batch queue backlog high
          description: marketprism_storage_batch_queue_size > 1000 for 10 minutes.






      - alert: CollectorTargetDown
        expr: up{job="collector"} == 0
        for: 30s
        labels:
          severity: critical
          service: collector
        annotations:
          summary: "🚨 Collector metrics 端点不可用"
          description: "Prometheus 无法抓取 collector metrics (9092)，已持续 30 秒"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控

      - alert: CollectorHighMemory
        expr: process_resident_memory_bytes{job="collector"} > 3000000000
        for: 5m
        labels:
          severity: warning
          service: collector
        annotations:
          summary: "⚠️ Collector 内存使用过高"
          description: "Collector 内存使用 {{ $value | humanize1024 }}B，超过 3GB 阈值，已持续 5 分钟"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控

      - alert: CollectorNoDataIngestion
        expr: rate(marketprism_nats_messages_published_total[5m]) == 0
        for: 3m
        labels:
          severity: critical
          service: collector
        annotations:
          summary: "🚨 Collector 停止采集数据"
          description: "Collector 在过去 5 分钟内没有发布任何消息到 NATS，已持续 3 分钟"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控

      - alert: CollectorDataIngestionLow
        expr: sum(rate(marketprism_nats_messages_published_total[5m])) < 10
        for: 5m
        labels:
          severity: warning
          service: collector
        annotations:
          summary: "⚠️ Collector 数据采集速率过低"
          description: "Collector 总采集速率 {{ $value | humanize }}ops/s，低于 10 ops/s，已持续 5 分钟"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控


  - name: marketprism-availability
    rules:
      - alert: CollectorHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8087/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: collector
        annotations:
          summary: Collector health endpoint down
          description: Blackbox probe failed for collector health (8087/health).
          runbook_url: https://your.runbook/collector/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控


      - alert: HotServiceHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8085/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: Hot storage service health down
          description: Blackbox probe failed for hot-storage health (8085/health).
          runbook_url: https://your.runbook/hot-storage/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控


      - alert: ColdServiceHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8086/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: Cold storage service health down
          description: Blackbox probe failed for cold-storage health (8086/health).
          runbook_url: https://your.runbook/cold-storage/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控


      - alert: ClickHouseHotDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8123/ping"} == 0
        for: 1m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: ClickHouse (hot) HTTP endpoint down
          description: Blackbox probe failed for ClickHouse hot (8123/ping).
          runbook_url: https://your.runbook/clickhouse/hot
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控


      - alert: ClickHouseColdDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8124/ping"} == 0
        for: 1m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: ClickHouse (cold) HTTP endpoint down
          description: Blackbox probe failed for ClickHouse cold (8124/ping).
          runbook_url: https://your.runbook/clickhouse/cold
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-统一监控



  - name: marketprism-snapshot
    interval: 30s
    rules:
      # 快照成功率告警（警告）
      - alert: SnapshotSuccessRateLow
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="success"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 < 95
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot success rate below 95% for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot success rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 95%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#故障排查"

      # 快照成功率告警（严重）
      - alert: SnapshotSuccessRateCritical
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="success"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 < 80
        for: 3m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot success rate critically low for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot success rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 80%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#故障排查"

      # 快照延迟（P99）
      - alert: SnapshotLatencyHigh
        expr: |
          histogram_quantile(0.99,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot P99 latency high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P99 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 1s)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#性能调优"

      # 快照延迟（P99严重）
      - alert: SnapshotLatencyCritical
        expr: |
          histogram_quantile(0.99,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 2.0
        for: 3m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot P99 latency critically high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P99 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 2s)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#性能调优"

      # 重连频繁
      - alert: SnapshotReconnectionsFrequent
        expr: |
          rate(marketprism_snapshot_reconnections_total[10m]) * 600 > 3
        for: 10m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Frequent snapshot reconnections for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot reconnections: {{ $value | humanize }} times in 10 minutes for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 3)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#问题-2websocket-频繁重连binance-derivatives"

      # 超时率
      - alert: SnapshotTimeoutRateHigh
        expr: |
          (
            sum(rate(marketprism_snapshot_timeouts_total[5m])) by (exchange, market_type, symbol)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type, symbol)
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "High snapshot timeout rate for {{ $labels.exchange }}_{{ $labels.market_type }}/{{ $labels.symbol }}"
          description: "Snapshot timeout rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }}/{{ $labels.symbol }} (threshold: 10%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#问题-1快照获取失败"

      # 请求停止
      - alert: SnapshotRequestsStopped
        expr: |
          sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type) == 0
        for: 2m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot requests stopped for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "No snapshot requests in the last 5 minutes for {{ $labels.exchange }}_{{ $labels.market_type }}"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#故障排查"

      # 平均延迟（P50）
      - alert: SnapshotAverageLatencyHigh
        expr: |
          histogram_quantile(0.50,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 0.5
        for: 10m
        labels:
          severity: info
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot average latency high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P50 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 500ms)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#性能调优"

      # 错误率
      - alert: SnapshotErrorRateHigh
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="error"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "High snapshot error rate for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot error rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 5%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#故障排查"
