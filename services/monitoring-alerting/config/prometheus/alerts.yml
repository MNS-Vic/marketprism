groups:
  - name: marketprism-core
    rules:
      - alert: BrokerDown
        expr: marketprism_broker_connected == 0
        for: 30s
        labels:
          severity: critical
          service: message-broker
        annotations:
          summary: Message Broker disconnected
          description: Broker connection status is 0 for more than 30s.

      - alert: HotInsertErrorsHigh
        expr: rate(marketprism_storage_clickhouse_insert_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: ClickHouse insert errors increasing
          description: ClickHouse insert error rate > 0 in the last 5 minutes.

      - alert: HotErrorRateHigh
        expr: marketprism_storage_error_rate_percent > 5
        for: 5m
        labels:
          severity: warning
          service: hot-storage
        annotations:
          summary: Hot storage error rate high
          description: marketprism_storage_error_rate_percent > 5 for 5 minutes.

      - alert: ColdReplicationLagHigh
        expr: max(marketprism_cold_replication_lag_minutes) > 15
        for: 10m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: Cold storage replication lag high
          description: Any table replication lag_minutes > 15 for 10 minutes.

      - alert: BatchQueueBacklogHigh
        expr: max(marketprism_storage_batch_queue_size) > 1000
        for: 10m
        labels:
          severity: warning
          service: hot-storage
        annotations:
          summary: Hot storage batch queue backlog high
          description: marketprism_storage_batch_queue_size > 1000 for 10 minutes.






      - alert: CollectorTargetDown
        expr: up{job="collector"} == 0
        for: 30s
        labels:
          severity: critical
          service: collector
        annotations:
          summary: "ğŸš¨ Collector metrics ç«¯ç‚¹ä¸å¯ç”¨"
          description: "Prometheus æ— æ³•æŠ“å– collector metrics (9092)ï¼Œå·²æŒç»­ 30 ç§’"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§

      - alert: CollectorHighMemory
        expr: process_resident_memory_bytes{job="collector"} > 3000000000
        for: 5m
        labels:
          severity: warning
          service: collector
        annotations:
          summary: "âš ï¸ Collector å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "Collector å†…å­˜ä½¿ç”¨ {{ $value | humanize1024 }}Bï¼Œè¶…è¿‡ 3GB é˜ˆå€¼ï¼Œå·²æŒç»­ 5 åˆ†é’Ÿ"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§

      - alert: CollectorNoDataIngestion
        expr: rate(marketprism_nats_messages_published_total[5m]) == 0
        for: 3m
        labels:
          severity: critical
          service: collector
        annotations:
          summary: "ğŸš¨ Collector åœæ­¢é‡‡é›†æ•°æ®"
          description: "Collector åœ¨è¿‡å» 5 åˆ†é’Ÿå†…æ²¡æœ‰å‘å¸ƒä»»ä½•æ¶ˆæ¯åˆ° NATSï¼Œå·²æŒç»­ 3 åˆ†é’Ÿ"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§

      - alert: CollectorDataIngestionLow
        expr: sum(rate(marketprism_nats_messages_published_total[5m])) < 10
        for: 5m
        labels:
          severity: warning
          service: collector
        annotations:
          summary: "âš ï¸ Collector æ•°æ®é‡‡é›†é€Ÿç‡è¿‡ä½"
          description: "Collector æ€»é‡‡é›†é€Ÿç‡ {{ $value | humanize }}ops/sï¼Œä½äº 10 ops/sï¼Œå·²æŒç»­ 5 åˆ†é’Ÿ"
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§


  - name: marketprism-availability
    rules:
      - alert: CollectorHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8087/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: collector
        annotations:
          summary: Collector health endpoint down
          description: Blackbox probe failed for collector health (8087/health).
          runbook_url: https://your.runbook/collector/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§


      - alert: HotServiceHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8085/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: Hot storage service health down
          description: Blackbox probe failed for hot-storage health (8085/health).
          runbook_url: https://your.runbook/hot-storage/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§


      - alert: ColdServiceHealthDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8086/health"} == 0
        for: 1m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: Cold storage service health down
          description: Blackbox probe failed for cold-storage health (8086/health).
          runbook_url: https://your.runbook/cold-storage/health
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§


      - alert: ClickHouseHotDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8123/ping"} == 0
        for: 1m
        labels:
          severity: critical
          service: hot-storage
        annotations:
          summary: ClickHouse (hot) HTTP endpoint down
          description: Blackbox probe failed for ClickHouse hot (8123/ping).
          runbook_url: https://your.runbook/clickhouse/hot
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§


      - alert: ClickHouseColdDown
        expr: probe_success{job="blackbox-http-internal", instance="http://43.156.224.10:8124/ping"} == 0
        for: 1m
        labels:
          severity: critical
          service: cold-storage
        annotations:
          summary: ClickHouse (cold) HTTP endpoint down
          description: Blackbox probe failed for ClickHouse cold (8124/ping).
          runbook_url: https://your.runbook/clickhouse/cold
          dashboard_url: http://127.0.0.1:3000/d/marketprism-unified/marketprism-ç»Ÿä¸€ç›‘æ§



  - name: marketprism-snapshot
    interval: 30s
    rules:
      # å¿«ç…§æˆåŠŸç‡å‘Šè­¦ï¼ˆè­¦å‘Šï¼‰
      - alert: SnapshotSuccessRateLow
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="success"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 < 95
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot success rate below 95% for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot success rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 95%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ•…éšœæ’æŸ¥"

      # å¿«ç…§æˆåŠŸç‡å‘Šè­¦ï¼ˆä¸¥é‡ï¼‰
      - alert: SnapshotSuccessRateCritical
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="success"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 < 80
        for: 3m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot success rate critically low for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot success rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 80%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ•…éšœæ’æŸ¥"

      # å¿«ç…§å»¶è¿Ÿï¼ˆP99ï¼‰
      - alert: SnapshotLatencyHigh
        expr: |
          histogram_quantile(0.99,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot P99 latency high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P99 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 1s)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ€§èƒ½è°ƒä¼˜"

      # å¿«ç…§å»¶è¿Ÿï¼ˆP99ä¸¥é‡ï¼‰
      - alert: SnapshotLatencyCritical
        expr: |
          histogram_quantile(0.99,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 2.0
        for: 3m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot P99 latency critically high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P99 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 2s)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ€§èƒ½è°ƒä¼˜"

      # é‡è¿é¢‘ç¹
      - alert: SnapshotReconnectionsFrequent
        expr: |
          rate(marketprism_snapshot_reconnections_total[10m]) * 600 > 3
        for: 10m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Frequent snapshot reconnections for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot reconnections: {{ $value | humanize }} times in 10 minutes for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 3)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#é—®é¢˜-2websocket-é¢‘ç¹é‡è¿binance-derivatives"

      # è¶…æ—¶ç‡
      - alert: SnapshotTimeoutRateHigh
        expr: |
          (
            sum(rate(marketprism_snapshot_timeouts_total[5m])) by (exchange, market_type, symbol)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type, symbol)
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "High snapshot timeout rate for {{ $labels.exchange }}_{{ $labels.market_type }}/{{ $labels.symbol }}"
          description: "Snapshot timeout rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }}/{{ $labels.symbol }} (threshold: 10%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#é—®é¢˜-1å¿«ç…§è·å–å¤±è´¥"

      # è¯·æ±‚åœæ­¢
      - alert: SnapshotRequestsStopped
        expr: |
          sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type) == 0
        for: 2m
        labels:
          severity: critical
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot requests stopped for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "No snapshot requests in the last 5 minutes for {{ $labels.exchange }}_{{ $labels.market_type }}"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ•…éšœæ’æŸ¥"

      # å¹³å‡å»¶è¿Ÿï¼ˆP50ï¼‰
      - alert: SnapshotAverageLatencyHigh
        expr: |
          histogram_quantile(0.50,
            sum(rate(marketprism_snapshot_request_duration_seconds_bucket[5m])) by (exchange, market_type, le)
          ) > 0.5
        for: 10m
        labels:
          severity: info
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "Snapshot average latency high for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot P50 latency is {{ $value | humanizeDuration }} for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 500ms)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ€§èƒ½è°ƒä¼˜"

      # é”™è¯¯ç‡
      - alert: SnapshotErrorRateHigh
        expr: |
          (
            sum(rate(marketprism_snapshot_requests_total{status="error"}[5m])) by (exchange, market_type)
            /
            sum(rate(marketprism_snapshot_requests_total[5m])) by (exchange, market_type)
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: collector
          component: data-collector
          feature: snapshot
        annotations:
          summary: "High snapshot error rate for {{ $labels.exchange }}_{{ $labels.market_type }}"
          description: "Snapshot error rate is {{ $value | humanize }}% for {{ $labels.exchange }}_{{ $labels.market_type }} (threshold: 5%)"
          runbook_url: "https://github.com/MNS-Vic/marketprism/blob/main/services/data-collector/docs/SNAPSHOT_MODE_GUIDE.md#æ•…éšœæ’æŸ¥"
